library(cluster)
library(factoextra)
library(FactoMineR)
library(reshape2)
library(ggplot2)
library(reshape)
library(RColorBrewer)
library(pheatmap)
library(ConsensusClusterPlus)
library(dplyr)
library(reshape)
library(survival)
library(survminer)
library(parallel)
library(ggplot2)
library(ggpubr)
library(magrittr)
library(umap)
library(Rtsne)
library(Seurat)
library(dplyr)
library(cluster)
library(factoextra)
library(FactoMineR)
library(factoextra)
library(reshape2)
library(ggplot2)
library(GSVA)
library(GSEABase)
library(msigdbr)
library(clusterProfiler)
options(connectionObserver = NULL)
library(org.Hs.eg.db)
library(enrichplot)
library(limma)
library(edgeR)
library(RColorBrewer)
library(pheatmap)
library(AnnotationDbi)
library(reshape)
library(reshape2)
library(clusterProfiler)
library(DESeq2)
library(maftools)
library(TCGAmutations)
library(tidyr)
library(glmnet)
library(Matrix)
library(ggcorrplot)
library(ggplot2)
library(FactoMineR)
library(cluster)
library(factoextra)
library(pROC)
library(sva)
library(descriptr)
library(readxl)
options(digits=10)

library(glmnet)
library(dplyr)
library(dplyr)
library(pROC)
library(caret)
library(randomForest)
library(pacman)
library(DALEX)
library(klaR)
library(ROCR)
library(xgboost)
library(Matrix)
library(breakDown)
library(Ckmeans.1d.dp)

library(class)
library(gmodels)
library(kknn)
library(e1071)

###TNM
dir.create("D:/data/data11/LUADs")
getwd()
setwd("D:/data/data11/LUADs")

##全部IB进行分析
setwd("D:/data/data16/singlegene")
LUAD1<-list.files(pattern="\\RNA matrix.csv")
LUAD2<-as.data.frame(LUAD1)
LUAD3<-tidyr::separate(LUAD2,LUAD1,into=c("Dataset")," ")
for(i in seq_along(LUAD3$Dataset))
  assign(LUAD3$Dataset[i], read.table(LUAD1[i], sep = ",", header = TRUE))


GSE11969<-read.table("D:/data/data3/ASPM/Single LUAD/GSE11969/GSE11969 RNA matrix.csv",
                     sep=",",header=TRUE,stringsAsFactors=FALSE)
GSE14814<-read.table("D:/data/data3/ASPM/Single LUAD/GSE14814/GSE14814 RNA matrix.csv",
                     sep=",",header=TRUE,stringsAsFactors=FALSE)
GSE81089<-read.table("D:/data/data3/ASPM/Single LUAD/GSE81089/GSE81089 RNA matrix.csv",
                     sep=",",header=TRUE,stringsAsFactors=FALSE)


NS1ol<-read.table("D:/data/data16/NSCLC clinical.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
NS1on<-read.table("D:/data/data3/ASPM/Single LUAD/NSCLC clinical xiu.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)

NS1<-rbind(NS1ol,NS1on)

table(NS1$Dataset,NS1$pStage)

NS1u<-subset(NS1,NS1$Histology=="AD" &
               NS1$pStage %in% c("IA","IB",
                                 "II","IIA","IIB"),select=c(1:ncol(NS1)))

NS1u<-NS1u[complete.cases(NS1u$OS.time),] ##去除OS无数据

table(NS1u$Dataset,NS1u$pStage)

NS1u$SStage[NS1u$pStage=="IA"]<-"IA"
NS1u$SStage[NS1u$pStage %in% c("II","IIA","IIB")]<-"II"
NS1u$SStage[NS1u$pStage=="IB"]<-"IB"

table(NS1u$SStage)



##合并
LUAD4<-list(GSE11969,GSE13213,GSE26939,GSE30219,GSE31210,GSE41271,GSE42127,
            GSE50081,GSE63459,GSE68465,GSE68571,GSE72094,GSE81089,TCGALUAD)
for(i in seq_along(LUAD4)){rownames(LUAD4[[i]])<-(LUAD4[[i]])[,1]}

LUAD4a<-Reduce(function(x,y)merge(x,y,by="GeneID",all.x=FALSE),LUAD4,accumulate=FALSE)

##对每一个数据集进行Z转化
LUAD5<-lapply(LUAD4,function(x)as.data.frame(t(scale(t(x[,-1])))))

for(i in seq_along(LUAD5)){ LUAD5[[i]]$GeneID <- rownames(LUAD5[[i]])}
for(i in seq_along(LUAD5)){ LUAD5[[i]] <- (LUAD5[[i]])[,c("GeneID",colnames(LUAD5[[i]])[1:(length(colnames(LUAD5[[i]]))-1)])]}

LUAD6<-Reduce(function(x,y)merge(x,y,by="GeneID",all.x=FALSE),LUAD5,accumulate=FALSE)

rownames(LUAD6)<-LUAD6$GeneID


LUAD7<-LUAD6[,intersect(NS1u$Patients,colnames(LUAD6))] %>% na.omit() ##去除基因NA

NS1u1<-subset(NS1u,NS1u$Patients %in% colnames(LUAD7),select=c(1:ncol(NS1u)))

NS1u1$SStage<-factor(NS1u1$SStage,levels=c("IA","IB","II"))


##Z转化批次效应情况

##没有Z转化 ##
set.seed(20230629)
table(NS1$Histology)
NS1a<-subset(NS1u1,NS1u1$SStage=="IB",select=c(1:ncol(NS1u1)))

NS2a<-subset(NS1a,NS1a$Patients %in% colnames(LUAD4a)[-1],select=c(1:ncol(NS1a)))
NS3a<-setdiff(colnames(LUAD4a),NS2a$Patients)[-1]

LUAD7ad<-dplyr::select(LUAD4a,-one_of(NS3a))  ##未Z转化 全部LUAD

u1d<-LUAD7ad[,-1]
u2d<-as.data.frame(t(u1d))
u2d[is.na(u2d)]<-0
u3d<-umap(u2d,method='naive',n_neighbors = 15)
u4d<-as.data.frame(u3d$layout)
u4d$Patients<-rownames(u4d)
u4d<-merge(u4d,NS2a,by=c("Patients"))
u5d<-ggplot(u4d,aes(x=V1,y=V2,colour=Dataset))+geom_point(size=0.5)+
  xlab("UMAP_1")+ylab("UMAP_2")+labs(colour="Datasets")+

  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=16))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=20))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
u5d
ggsave("LUAD IB all UMAP pro xiu1.pdf", width=8, height=6)

nd<-Rtsne(u2d,
          dims = 2,
          pca = TRUE,
          perplexity = 10,
          theta = 0.0,
          max_iter = 1000)
n1d<-data.frame(nd$Y,u4d$Patients)
colnames(n1d)<-c("Y1","Y2","Patients")
n1dm<-merge(n1d,NS2a,by=c("Patients"))
n2d<-ggplot(n1dm,aes(Y1,Y2,colour=Dataset))+geom_point(size=0.5)+
  xlab("tSNE_1")+ylab("tSNE_2")+labs(colour="Datasets")+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=16))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=20))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
n2d
ggsave("LUAD IB all tSNE pro xiu1.pdf", width=8, height=6)


##全部LUAD
##Z转化 ##
set.seed(20230629)

LUAD7ad<-dplyr::select(LUAD6,-one_of(NS3a))  ##Z转化 全部LUAD

u1d<-LUAD7ad[,-1]
u2d<-as.data.frame(t(u1d))
u2d[is.na(u2d)]<-0
u3d<-umap(u2d,method='naive',n_neighbors = 15)
u4d<-as.data.frame(u3d$layout)
u4d$Patients<-rownames(u4d)
u4d<-merge(u4d,NS2a,by=c("Patients"))
u5d<-ggplot(u4d,aes(x=V1,y=V2,colour=Dataset))+geom_point(size=0.5)+
  xlab("UMAP_1")+ylab("UMAP_2")+labs(colour="Datasets")+

  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=16))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=20))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
u5d
ggsave("LUAD IB all UMAP pro xiu1 Z.pdf", width=8, height=6)

nd<-Rtsne(u2d,
          dims = 2,
          pca = TRUE,
          perplexity = 10,
          theta = 0.0,
          max_iter = 1000)
n1d<-data.frame(nd$Y,u4d$Patients)
colnames(n1d)<-c("Y1","Y2","Patients")
n1dm<-merge(n1d,NS2a,by=c("Patients"))
n2d<-ggplot(n1dm,aes(Y1,Y2,colour=Dataset))+geom_point(size=0.5)+
  xlab("tSNE_1")+ylab("tSNE_2")+labs(colour="Datasets")+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=16))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=20))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
n2d
ggsave("LUAD all tSNE pro xiu1 Z.pdf", width=8, height=6)




class(NS1u1$SStage)
set.seed(765429)
NS1u1<-arrange(NS1u1,NS1u1$SStage) ##排序

##按照SStage进行分层抽样 0.6
k1<-data.frame(table(NS1u1$SStage))
install.packages("sampling")
library(sampling)
sample=strata(NS1u1,c("SStage"),size=k1$Freq*0.6,method="srswor")
table(sample$SStage)

bc_train<-getdata(NS1u1,sample)
bc_test<-subset(NS1u1,NS1u1$Patients %in% setdiff(NS1u1$Patients,bc_train$Patients),
                select=c(1:ncol(NS1u1)))
getwd()
setwd("D:/data/data11/LUADs")
getwd()
write.table(bc_train,"LUAD IB train.csv",sep=",",col.names=T,row.names = F)
write.table(bc_test,"LUAD IB test.csv",sep=",",col.names=T,row.names = F)

bc_train<-read.table("LUAD IB train.csv",
                  sep=",",header=TRUE,stringsAsFactors=FALSE)

bc_test<-read.table("LUAD IB test.csv",
                     sep=",",header=TRUE,stringsAsFactors=FALSE)



bc_train1<-subset(bc_train,bc_train$SStage=="IB",select=c(1:ncol(bc_train)))
t5<-as.data.frame(t(LUAD7))[bc_train1$Patients,]
t5$Patients<-rownames(t5)
t6<-dplyr::select(NS1,Patients,OS.status,OS.time)
t7<-merge(t6,t5,by=c("Patients"))

bc_test1<-subset(bc_test,bc_test$SStage=="IB",select=c(1:ncol(bc_test)))
t5t<-as.data.frame(t(LUAD7))[bc_test1$Patients,]
t5t$Patients<-rownames(t5t)
t6t<-dplyr::select(NS1,Patients,OS.status,OS.time)
t7t<-merge(t6t,t5t,by=c("Patients"))




a2<-sapply(t7[,-(1:3)],function(x)coxph(Surv(OS.time,OS.status)~x,data=t7),simplify=FALSE)
###实验循环提取单一基因数据
###提取列表中每一个变量summary结果
a3<-sapply(a2,function(x)summary(x),simplify=FALSE)
a3$`1362`
###提取列表中每一个变量summary结果后回归系数的对数 HR
a4<-as.data.frame(sapply(a2,function(x)summary(x)$coefficients[1,2],simplify=TRUE))
a4$GeneID<-rownames(a4)
colnames(a4)<-c("HR","GeneID")


###提取列表中每一个变量的回归summary结果中的回归系数的p值，以矩阵形式保存
a5<-as.data.frame(sapply(a2,function(x)summary(x)$coefficients[1,5],simplify=TRUE))
a5$GeneID<-rownames(a5)
colnames(a5)<-c("p","GeneID")



e4<-merge(a4,a5,by="GeneID")

write.table(e4,"LUAD IB OR p.csv",sep=",",col.names=T,row.names = F)

e4<-read.table("LUAD IB OR p.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

a6<-subset(e4,e4$p<0.1,select=c(1:ncol(e4))) ##选择0.1
class(a6$GeneID)
a6$GeneID<-as.character(a6$GeneID)

b<-as.factor(ifelse(e4$p<0.1,"p<0.1","p>0.1"))
log10(0.1)
log10(0.05)
library(ggplot2)
"#BFEFFF","#40E0D0","#EED5D2","#F08080"
g2<-ggplot(e4,aes(HR,-1*log10(p)))+geom_point()+
  theme_bw()+theme(panel.grid =element_blank())+
  xlab("HR")+ylab("-log10(pvalue)")+labs(title="")+
  geom_hline(yintercept=1,linetype="dashed",size=0.4,colour="black")+
  geom_point(aes(color=b))+
  scale_color_manual(values =c("#F08080","#BFEFFF"))+
  theme(axis.text.x=element_text(size=20,face="bold",colour="black"))+
  theme(axis.text.y=element_text(size=20,face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=22,face="bold",colour="black"))+
  theme(axis.title.y=element_text(size=22,face="bold",colour="black"))+
  theme(legend.position="none")+
  theme(plot.title=element_text(size=25,face="bold",colour="black"))
g2

ggsave("IB OS gene.pdf", width=5, height=5)



t5a<-t5[,a6$GeneID]
t6a<-as.matrix(t(t5a))

setwd("D:/data/data11/LUADs")
getwd()
title="D:\\data/data11/LUADs/Concensus"
results = ConsensusClusterPlus(t6a,maxK=10,reps=1000,pItem=0.8,pFeature=1,
                               title=title,clusterAlg="pam",

                               distance="euclidean",seed=12341234,plot="pdf")
icl=calcICL(results,plot="pdf")
dev.off()

getwd()
t7a<-as.data.frame(results[[2]][["consensusClass"]])
colnames(t7a)<-c("Type")
t7a$Patients<-rownames(t7a)
write.csv(t7a, file="LUAD IB consensus type2.csv",sep=",",row.names = FALSE)

t7a<-as.data.frame(results[[4]][["consensusClass"]])
colnames(t7a)<-c("Type")
t7a$Patients<-rownames(t7a)
write.csv(t7a, file="LUAD IB consensus type4.csv",sep=",",row.names = FALSE)

t7a<-as.data.frame(results[[3]][["consensusClass"]])
colnames(t7a)<-c("Type")
t7a$Patients<-rownames(t7a)
write.csv(t7a, file="LUAD IB consensus type3.csv",sep=",",row.names = FALSE)



##三分类
t7a<-read.table(file="LUAD IB consensus type3.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
t7a$Type[t7a$Type=="1"]<-"IB3"
t7a$Type[t7a$Type=="2"]<-"IB1"
t7a$Type[t7a$Type=="3"]<-"IB2"


##二分类
t7a<-read.table(file="LUAD IB consensus type2.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
t7a$Type[t7a$Type=="1"]<-"IB1"
t7a$Type[t7a$Type=="2"]<-"IB2"


##四分类
t7a<-read.table(file="LUAD IB consensus type4.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
t7a$Type[t7a$Type=="1"]<-"IB1"
t7a$Type[t7a$Type=="2"]<-"IB2"
t7a$Type[t7a$Type=="3"]<-"IB3"
t7a$Type[t7a$Type=="4"]<-"IB4"



u1<-t6a
u2<-as.data.frame(t(u1))
u2[c(1:3),c(1:3)]
u2[is.na(u2)]<-0
u3<-umap(u2,method='naive',n_neighbors = 15)
u4<-as.data.frame(u3$layout)
u4$Type<-as.factor(t7a$Type)
u5<-ggplot(u4,aes(x=V1,y=V2,colour=Type))+geom_point()+
  xlab("UMAP_1")+ylab("UMAP_2")+labs(colour="Type")+
  scale_colour_manual(values=c("#BFEFFF","#40E0D0","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=22))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=24))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
u5
ggsave("LUAD IB type4 UMAP.pdf", width=7, height=6)



n<-Rtsne(u2,
         dims = 2,
         pca = TRUE,
         perplexity = 10,
         theta = 0.0,
         max_iter = 1000)
n1<-data.frame(n$Y,u4$Type)
colnames(n1)<-c("Y1","Y2","Type")
n2<-ggplot(n1,aes(Y1,Y2,colour=Type))+geom_point()+
  xlab("tSNE_1")+ylab("tSNE_2")+labs(colour="Type")+
  scale_colour_manual(values=c("#BFEFFF","#40E0D0","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "right")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=22))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=24))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
n2
ggsave("LUAD IB type4 tSNE.pdf", width=7, height=6)




table(t7a$Type)


b1<-merge(t7a,NS1,by=c("Patients"))


##OS
b3o<-survdiff(Surv(OS.time, OS.status)~Type, data=b1)##
b3o
b3o1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=b1)
b3o1
b3o2<-coxph(Surv(OS.time,OS.status)~Type, data=b1)
b3o2


fito<-survfit(Surv(OS.time, OS.status)~Type, data=b1)
mytheme1<-theme_classic(base_family="")
##

curveo<-ggsurvplot(fito,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                   legend.labs=c("IB1","IB2","IB3","IB4"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",
                   legend="top",size=0.4,
                   title="",xlab="Months",ylab="OS",
                   font.legend=c(22, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curveo
ggsave("LUAD IB OS type4.pdf", width=7, height=6)

curveo<-ggsurvplot(fito,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                       palette=c("#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                       legend.labs=c("IB1","IB2","IB3","IB4"),
                       pval=FALSE,ggtheme=mytheme1,
                       legend.title="Type",
                       legend="top",size=0.4,
                       title="",xlab="Months",ylab="OS",
                       font.legend=c(22, "bold", "black"),
                       font.title=c(24, "bold", "black"),
                       surv.median.line="hv",
                       font.x=c(24, "bold", "black"),
                       font.y=c(24, "bold", "black"),
                       font.tickslab=c(20, "bold", "black"),
                       risk.table=TRUE)
curveo
###高低划分
##IA期
qsh1<-subset(bc_train,bc_train$SStage=="IA",select=c(1:ncol(bc_train)))

qsh1$Type<-"0"
qsh2<-dplyr::select(qsh1,Patients,Type)

qsh3<-merge(qsh2,NS1,by=c("Patients"))

##合并IA、IB期

he1<-rbind(b1,qsh3)

allas<-he1
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB1","IB2","IB3","IB4"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA OS type4.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                      legend.labs=c("IA","IB1","IB2","IB3","IB4"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)
qsh1<-subset(bc_train,bc_train$SStage=="II",select=c(1:ncol(bc_train)))

qsh1$Type<-"0"
qsh2<-dplyr::select(qsh1,Patients,Type)

qsh3<-merge(qsh2,NS1,by=c("Patients"))

##合并II、IB期

he1<-rbind(b1,qsh3)

allas<-he1
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                     legend.labs=c("II","IB1","IB2","IB3","IB4"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII OS type4.pdf", width=7, height=6)



Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#40E0D0","#EED5D2","#F08080"),
                     legend.labs=c("II","IB1","IB2","IB3","IB4"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1



###高低划分
b1<-merge(t7a,NS1,by=c("Patients"))

b1$Type[b1$Type %in% c("IB1")]<-"0L"
b1$Type[b1$Type %in% c("IB2","IB3")]<-"1M"
b1$Type[b1$Type %in% c("IB4")]<-"2H"
table(b1$Type)


##IA期
qsh1<-subset(bc_train,bc_train$SStage=="IA",select=c(1:ncol(bc_train)))

qsh1$Type<-"0"
qsh2<-dplyr::select(qsh1,Patients,Type)
qsh3<-merge(qsh2,NS1,by=c("Patients"))

##合并IA、IB期

he1<-rbind(b1,qsh3)

allas<-he1
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA OS risk.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)
qsh1<-subset(bc_train,bc_train$SStage=="II",select=c(1:ncol(bc_train)))

qsh1$Type<-"0"
qsh2<-dplyr::select(qsh1,Patients,Type)

qsh3<-merge(qsh2,NS1,by=c("Patients"))

##合并II、IB期

he1<-rbind(b1,qsh3)

allas<-he1
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII OS risk.pdf", width=7, height=6)



Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1a








##进行IB4和IB1的差异基因筛选，多种机器学习算法建立评分

library(e1071)
library(kernlab)
library(caret)
library(randomForest)
library(glmnet)

x1<-subset(t7a,t7a$Type!=c("IB2") &
             t7a$Type!=c("IB3"),select=c(1:ncol(t7a)))
table(x1$Type)

x2<-t5[,a6$GeneID]
x2$Patients<-rownames(x2)

x3<-merge(x1,x2,by=c("Patients"))

rownames(x3)<-x3$Patients

x4<-x3[,-1]

y1<-t5[x1$Patients,]

y2<-as.data.frame(t(y1))


class(colnames(y1))

##使用sort()函数检查顺序是否相同
is_same_order <- function(v1,v2) {
  return(all(sort(v1) == sort(v2)))
}
print(is_same_order(x1$Patients, rownames(y1)))

getwd()

##SVM  ##太慢
train_matrix <- (x4[,-1]) %>% data.frame() %>% mutate(across(where(is.character), as.numeric))  %>% as.matrix()
colnames(train_matrix)<-colnames(x4[,-1])
Profile=rfe(x=train_matrix,
            y=as.numeric(as.factor(x4$Type)),
            sizes = c(2,4,6,8, seq(10,40,by=3)),
            rfeControl = rfeControl(functions = caretFuncs, method = "cv"),
            methods="svmRadial")
featureGenes=Profile$optVariables





##randomForest
rf<-randomForest(x4[,-1], factor(x4$Type),data=x4,importance=TRUE,mtry=3, proximity=TRUE)
##type=1是以准确率递减方法得到维度重要性值。type=2为基尼系数方法
##打分值MeanDecreaseGini，分数越高越有可能存在研究价值
importance<-importance(rf)
rfGenes<-as.data.frame(importance[order(importance[,"MeanDecreaseGini"], decreasing = TRUE),])
rfGenes$GeneID<-rownames(rfGenes)
write.csv(rfGenes,file="D:/data/data11/LUADs/rfgeneIBLUAD.csv",row.names=F,col.names=T)
rfGenes<-read.table("D:/data/data11/LUADs/rfgeneIBLUAD.csv",
                  sep=",",header=TRUE,stringsAsFactors=FALSE)


GimpK<-rfGenes[1:30,]

Gimp1<-bitr(GimpK$GeneID, fromType = "ENTREZID",
           toType = c("ENTREZID", "SYMBOL"),
           OrgDb = org.Hs.eg.db)

colnames(Gimp1)<-c("GeneID","SYMBOL")
imp1a<-merge(GimpK,Gimp1,by=c("GeneID"))
imp1b<-imp1a[order(imp1a$MeanDecreaseGini),]

imp1b$SYMBOL<-factor(imp1b$SYMBOL,levels=imp1b$SYMBOL)
imp1c<-ggplot(imp1b,aes(x=MeanDecreaseGini,y=SYMBOL,size=MeanDecreaseGini))+geom_point(colour="#BFEFFF")+
  xlab("Importance")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=12,
                                face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=12,
                                  face="bold",colour="black"))+
  theme(axis.text.x=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(legend.position = "none")

imp1c
ggsave("LUAD IB rf impor.pdf", width=3, height=5)





##lasso  ##glmnet包中,alpha=1是lasso模型,alpha=0则为Ridge模型,处于0-1之间的算法叫Elastic Net,
train_matrix <- (x4[,-1]) %>% data.frame() %>% mutate(across(where(is.character), as.numeric))  %>% as.matrix()
colnames(train_matrix)<-colnames(x4[,-1])
fit=glmnet(train_matrix, x4$Type, family = "binomial", alpha=1)

par(mar=c(2,2,2,2))
pdf("kall LUAD IB lasso 1g.pdf",width=6, height=6)
plot1<-plot(fit,font.lab=2,font.axis=2,
            family="",cex.lab=2,cex.axis=1.8)
dev.off()

cvfit=cv.glmnet(train_matrix, x4$Type, family="binomial", alpha=1,type.measure='deviance',nfolds = 10)

pdf("kall LUAD IB lasso 2g.pdf",width=8, height=6)
plot2<-plot(cvfit,font.lab=2,font.axis=2,family="",
            cex.lab=2,cex.axis=1.8)
dev.off()


e1=coef(fit, s = cvfit$lambda.min)
e2<-e1[which(e1!= 0)]
e3<-round(e2,4)
e3
e4<-row.names(e1)[which(e1!= 0)]
e4
e5<-matrix(e3,length(e3),1)
rownames(e5)<-e4
colnames(e5)<-c("coef")
e6<-as.data.frame(e5)
e6$GeneID<-rownames(e6)
lass<-e6[-1,]

write.csv(lass,file="D:/data/data11/LUADs/lassIBLUAD.csv",row.names=F,col.names=T)

lass<-read.table("D:/data/data11/LUADs/lassIBLUAD.csv",
                    sep=",",header=TRUE,stringsAsFactors=FALSE)


##GBM
library(VIM)

fitControl <- trainControl( method = "repeatedcv", number = 4, repeats = 4)
train_matrix <- (x4[,-1]) %>% data.frame() %>% mutate(across(where(is.character), as.numeric))  %>% as.matrix()
colnames(train_matrix)<-colnames(x4[,-1])
fitgbm<-train(x=train_matrix,y=as.factor(x4$Type),  method = "gbm", trControl = fitControl,verbose = FALSE)
importances <- varImp(fitgbm)  ##Overall>0
importances
importances1<-as.data.frame(importances$importance) ##全部
importances1$GeneID<-rownames(importances1)
importances2<-importances1[order(importances1$Overall,decreasing = TRUE),]

write.csv(importances2,file="D:/data/data11/LUADs/GBMIBLUAD.csv",row.names=F,col.names=T)

importances2<-read.table("D:/data/data11/LUADs/GBMIBLUAD.csv",
                 sep=",",header=TRUE,stringsAsFactors=FALSE)


GimpK<-importances2[1:30,]

Gimp1<-bitr(GimpK$GeneID, fromType = "ENTREZID",
            toType = c("ENTREZID", "SYMBOL"),
            OrgDb = org.Hs.eg.db)

colnames(Gimp1)<-c("GeneID","SYMBOL")
imp1a<-merge(GimpK,Gimp1,by=c("GeneID"))
imp1b<-imp1a[order(imp1a$Overall),]

imp1b$SYMBOL<-factor(imp1b$SYMBOL,levels=imp1b$SYMBOL)
imp1c<-ggplot(imp1b,aes(x=Overall,y=SYMBOL,size=Overall))+geom_point(colour="#EED5D2")+
  xlab("Importance")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=12,
                                face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=12,
                                  face="bold",colour="black"))+
  theme(axis.text.x=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(legend.position = "none")

imp1c
ggsave("LUAD IB gbm impor.pdf", width=3, height=5)








##xgboost
library(xgboost)

train_matrix <- (x4[,-1]) %>% data.frame() %>% mutate(across(where(is.character), as.numeric))  %>% as.matrix()
colnames(train_matrix)<-colnames(x4[,-1])
labels <- as.numeric(as.factor(x4$Type))-1
dtrain <- xgb.DMatrix(data = train_matrix, label = labels)
params <- list(objective = "binary:logistic",
  eval_metric = "logloss",
  max_depth = 2,
  eta = 0.1)
model <- xgboost(params = params, data = dtrain, nrounds = 100)
print(xgb.importance(feature_names = colnames(train_matrix), model = model))
imp<-xgb.importance(feature_names=colnames(train_matrix),model=model)
imp$GeneID<-imp$Feature
imp1<-imp[order(imp$Gain,decreasing = TRUE),]

write.csv(imp1,file="D:/data/data11/LUADs/xgboostIBLUAD.csv",row.names=F,col.names=T)

imp1<-read.table("D:/data/data11/LUADs/xgboostIBLUAD.csv",
                         sep=",",header=TRUE,stringsAsFactors=FALSE)


GimpK<-imp1[1:30,]

Gimp1<-bitr(GimpK$GeneID, fromType = "ENTREZID",
            toType = c("ENTREZID", "SYMBOL"),
            OrgDb = org.Hs.eg.db)

colnames(Gimp1)<-c("GeneID","SYMBOL")
imp1a<-merge(GimpK,Gimp1,by=c("GeneID"))
imp1b<-imp1a[order(imp1a$Gain),]

imp1b$SYMBOL<-factor(imp1b$SYMBOL,levels=imp1b$SYMBOL)
imp1c<-ggplot(imp1b,aes(x=Gain,y=SYMBOL,size=Gain))+geom_point(colour="#F08080")+
  xlab("Importance")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=12,
                                face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=12,
                                  face="bold",colour="black"))+
  theme(axis.text.x=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(legend.position = "none")

imp1c
ggsave("LUAD IB xgboost impor.pdf", width=3, height=5)




###筛选交集基因

##需要排序
inteIP1<-Reduce(intersect,list(rfGenes[c(1:30),]$GeneID,
                               lass[c(1:30),]$GeneID,
                               importances2[c(1:30),]$GeneID,
                               imp1[c(1:30),]$GeneID))
inteIP1

inteIP1G<-bitr(inteIP1, fromType = "ENTREZID",
            toType = c("ENTREZID", "SYMBOL"),
            OrgDb = org.Hs.eg.db)


library(VennDiagram)
library(grid)
library(futile.logger)
library(venn)

pdf("LUAD IB Mole.pdf",width=4, height=5)
par(font=2,lwd=0.2,col="black")
s<-venn(list(rfGenes[c(1:30),]$GeneID,
             lass[c(1:30),]$GeneID,
             importances2[c(1:30),]$GeneID,
             imp1[c(1:30),]$GeneID),
        snames=c("rf","gbm","XGBoost","LASSO"),
        box=F,opacity = 0.5,plotsize=15,ilcs=1,
        borders=F,sncs=1,
        zcolor = c("cyan","red","royalblue","seagreen"))
s
dev.off()




inteIP1<-Reduce(intersect,list(rfGenes[c(1:36),]$GeneID,
                               lass[c(1:36),]$GeneID,
                               importances2[c(1:36),]$GeneID,
                               imp1[c(1:36),]$GeneID))
inteIP1


##只有两个基因 ##1062 CENPE  ##100 ADA

inteIP2<-Reduce(intersect,list(rfGenes[c(1:30),]$GeneID,
                               importances2[c(1:30),]$GeneID,
                               imp1[c(1:30),]$GeneID))
inteIP2

##6基因

inteIP2<-Reduce(intersect,list(rfGenes[c(1:30),]$GeneID,

                               imp1[c(1:30),]$GeneID))
inteIP2


lg1<-subset(LUAD6,LUAD6$GeneID %in% inteIP1,select=c(1:ncol(LUAD6)))
pgene.df<-bitr(lg1$GeneID, fromType = "ENTREZID",
               toType = c("ENTREZID", "SYMBOL"),
               OrgDb = org.Hs.eg.db)
pgmm1<-as.data.frame(pgene.df)
colnames(pgmm1)<-c("GeneID","GeneSymbol")
lg2a<-merge(pgmm1,lg1,by=c("GeneID"))
rownames(lg2a)<-lg2a$GeneSymbol
lg2<-as.data.frame(t(lg2a[,-c(1:2)])) %>% mutate(across(where(is.character), as.numeric))

lg3<-lg2
lg3$Patients<-rownames(lg2)
lg4<-x4
lg4$Patients<-rownames(lg4)
lg5<-lg4[,c("Patients","Type")]



lg6<-merge(lg5,lg3,by=c("Patients"))
lg6$Type[lg6$Type=="IB1"]<-0
lg6$Type[lg6$Type=="IB4"]<-1
class(lg6$Type)
lg6$Type<-as.numeric(lg6$Type)

lg7<-glm(Type~.,data=lg6[,-c(1)],family=binomial())
summary(lg7)


lg9<-as.data.frame(lg7$coefficients)
lg9$GeneID<-rownames(lg9)
lg10<-lg9[-1,]
colnames(lg10)<-c("coef","Gene")
write.csv(lg10, file="LUAD IB HL logstic coef.csv",col.names = T,row.names = F)



las2<-as.data.frame(t(lg2))
las3<-lg10[,1]

las4<-as.data.frame(sapply(las2,function(x)sum(x*las3)))
las4$Patients<-rownames(las4)
colnames(las4)<-c("LAS","Patients")

getwd()
write.csv(las4, file="LUAD IB HL logstic.csv",col.names = T,row.names = F)

las4<-read.table("LUAD IB HL logstic.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)


##预后分析
##train
te2<-merge(bc_train,las4,by=c("Patients"))

all<-subset(te2,te2$SStage=="IB",select=c(1:ncol(te2)))

121+258+76
121/455 ==0.265
258/455 ==0.567
76/455==0.167
1-0.167==0.833
quantile(all$LAS, probs = 0.75)

all$LAS1[all$LAS>= quantile(all$LAS, 0.833) ]<-"2High"
all$LAS1[(all$LAS < quantile(all$LAS, 0.833))
         & (all$LAS >=quantile(all$LAS, 0.265))]<-"1Middle"
all$LAS1[all$LAS< quantile(all$LAS, 0.265) ]<-"0Low"


table(all$LAS1)


###与IA合并

##IA期
qsh1<-subset(bc_train,bc_train$SStage=="IA",select=c(1:ncol(bc_train)))


qsh1$Type<-"0"

ag1<-all
ag1<-dplyr::rename(ag1,Type=LAS1)
ag2<-ag1[,-21]


##合并IA、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","1Middle","2High"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA OS riskscore.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)
qsh1<-subset(bc_train,bc_train$SStage=="II",select=c(1:ncol(bc_train)))



qsh1$Type<-"0"


ag1<-all
ag1<-dplyr::rename(ag1,Type=LAS1)
ag2<-ag1[,-21]


##合并II、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","1Middle","2High"))

##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII OS riskscore.pdf", width=7, height=6)



Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("II","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a



##Test
te2<-merge(bc_test,las4,by=c("Patients"))

all<-subset(te2,te2$SStage=="IB",select=c(1:ncol(te2)))

all$LAS1[all$LAS>= quantile(all$LAS, 0.833) ]<-"2High"
all$LAS1[(all$LAS < quantile(all$LAS, 0.833))
         & (all$LAS >=quantile(all$LAS, 0.265))]<-"1Middle"
all$LAS1[all$LAS< quantile(all$LAS, 0.265) ]<-"0Low"

121+258+76
121/455 ==0.265
258/455 ==0.567
76/455==0.167
1-0.167



###与IA合并

##IA期

qsh1<-subset(bc_test,bc_test$SStage=="IA",select=c(1:ncol(bc_test)))


qsh1$Type<-"0"


ag1<-all
ag1<-dplyr::rename(ag1,Type=LAS1)

ag2<-ag1[,-18]

##合并IA、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","1Middle","2High"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA OS riskscore test.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("IA","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)
qsh1<-subset(bc_train,bc_train$SStage=="II",select=c(1:ncol(bc_train)))

qsh1<-subset(bc_test,bc_test$SStage=="II",select=c(1:ncol(bc_test)))




qsh1$Type<-"0"


ag1<-all
ag1<-dplyr::rename(ag1,Type=LAS1)


ag2<-ag1[,-18]
##合并II、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","1Middle","2High"))

##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII OS riskscore test.pdf", width=7, height=6)



Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("II","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a



##关键基因的生存预测及表达情况

LUAD6p<-list()
for(i in seq_along(LUAD5)){
  LUAD6p[[i]]<-subset(LUAD5[[i]],LUAD5[[i]]$GeneID %in% inteIP1G$ENTREZID,select=c(1:ncol(LUAD5[[i]])))
  LUAD6p[[i]]<-as.data.frame(t(LUAD6p[[i]])[-1,])
}

LUAD6a<-do.call("rbind",LUAD6p) %>% mutate(across(where(is.character), as.numeric))

colnames(LUAD6a)<-c("CENPE","FSCN1","SLC2A1")
class(LUAD6a$CENPE)

LUAD6a$Patients<-rownames(LUAD6a)


table(NS1$Dataset,NS1$Histology)

##Histology中有正常组织的
NB1<-subset(NS1,NS1$Dataset %in% c("GSE11969","GSE30219","GSE31210",
                                   "GSE63459","GSE68465","GSE68571",
                                   "TCGA-LUAD"),select=c(1:ncol(NS1)))
table(NB1$Dataset,NB1$Histology)
NB1$Histology[NB1$Histology %in% c("Normal lung tissue")]<-"Normal"
NB1$Histology[NB1$Histology %in% c("AD")]<-"Tumor"
table(NB1$Dataset,NB1$Histology)

NB2<-subset(NB1,NB1$Histology=="Normal",select=c(1:ncol(NB1)))
NB3<-subset(NB1,NB1$Histology=="Tumor" &
              NB1$pStage %in% c("IB"),select=c(1:ncol(NB1)))

NB4<-rbind(NB2,NB3)
table(NB4$Dataset,NB4$Histology)

##去除GSE68571 Tumor只有2个
NB4a<-subset(NB4,NB4$Dataset %in% c("GSE11969","GSE30219","GSE31210",
                                   "GSE63459","GSE68465",
                                   "TCGA-LUAD"),select=c(1:ncol(NB4)))

rans1<-merge(NB4a,LUAD6a,by=c("Patients"))

m4<-split(rans1,rans1$Dataset)

m4a<-lapply(m4,function(x)wilcox.test(x$SLC2A1 ~ x$Histology))
m4a

m4b<-lapply(m4,function(x)wilcox.test(x$CENPE ~ x$Histology))
m4b

m4c<-lapply(m4,function(x)wilcox.test(x$FSCN1 ~ x$Histology))
m4c

rans1$Histology<-factor(rans1$Histology,levels=c("Normal","Tumor"))

m6<-ggplot(rans1,aes(x=interaction(Histology,Dataset),y=SLC2A1,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("Normal.",unique(rans1$Dataset)),
                   labels=unique(rans1$Dataset))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("SLC2A1")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="top")+
  annotate("text",x=1.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=3.5,y=4,label="*",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=5.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=7.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=9.5,y=4,label="p=0.087",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=11.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)
m6

ggsave("LUAD 1B SLC2A1.pdf", width=6, height=4)



m6<-ggplot(rans1,aes(x=interaction(Histology,Dataset),y=CENPE,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("Normal.",unique(rans1$Dataset)),
                   labels=unique(rans1$Dataset))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("CENPE")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="top")+
  annotate("text",x=1.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=3.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=5.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=7.5,y=4,label="p=0.205",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=9.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=11.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)
m6
ggsave("LUAD 1B CENPE.pdf", width=6, height=4)


m6<-ggplot(rans1,aes(x=interaction(Histology,Dataset),y=FSCN1,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("Normal.",unique(rans1$Dataset)),
                   labels=unique(rans1$Dataset))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("FSCN1")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="top")+
  annotate("text",x=1.5,y=4,label="*",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=3.5,y=4,label="p=0.471",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=5.5,y=4,label="p=0.715",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=7.5,y=4,label="p=0.168",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=9.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=11.5,y=4,label="*",
           fontface="bold",colour="BLACK",size=6)
m6
ggsave("LUAD 1B FSCN1.pdf", width=6, height=4)



##表达量分析 分为train 和 test


NB2<-subset(NB1,NB1$Histology=="Normal",select=c(1:ncol(NB1)))

##train
NB3a<-subset(NB1,NB1$Histology=="Tumor" &
              NB1$pStage %in% c("IB") &
               NB1$Patients %in% bc_train1$Patients,select=c(1:ncol(NB1)))
##test
NB3a<-subset(NB1,NB1$Histology=="Tumor" &
               NB1$pStage %in% c("IB") &
               NB1$Patients %in% bc_test1$Patients,select=c(1:ncol(NB1)))



NB4t<-rbind(NB2,NB3a)
table(NB4t$Dataset,NB4t$Histology)



rans1t<-merge(NB4t,LUAD6a,by=c("Patients"))

wilcox.test(rans1t$SLC2A1 ~ rans1t$Histology)
wilcox.test(rans1t$CENPE ~ rans1t$Histology)
wilcox.test(rans1t$FSCN1 ~ rans1t$Histology)


rans1t$Histology<-factor(rans1t$Histology,levels=c("Normal","Tumor"))

m6<-ggplot(rans1t,aes(x=Histology,y=SLC2A1,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("SLC2A1")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="none")+
  annotate("text",x=1.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)
m6
ggsave("LUAD IB train SLC2A1.pdf", width=2, height=3)
ggsave("LUAD IB test SLC2A1.pdf", width=2, height=3)


m6<-ggplot(rans1t,aes(x=Histology,y=CENPE,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("CENPE")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="none")+
  annotate("text",x=1.5,y=4,label="***",
           fontface="bold",colour="BLACK",size=6)
m6
ggsave("LUAD IB train CENPE.pdf", width=2, height=3)
ggsave("LUAD IB test CENPE.pdf", width=2, height=3)



m6<-ggplot(rans1t,aes(x=Histology,y=FSCN1,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("FSCN1")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="none")+
  annotate("text",x=1.5,y=4,label="p=0.266",
           fontface="bold",colour="BLACK",size=4)
m6
ggsave("LUAD IB train FSCN1.pdf", width=2, height=3)


m6<-ggplot(rans1t,aes(x=Histology,y=FSCN1,fill=Histology))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("FSCN1")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=10))+
  theme(legend.position="none")+
  annotate("text",x=1.5,y=4,label="p=0.104",
           fontface="bold",colour="BLACK",size=4)
m6
ggsave("LUAD IB test FSCN1.pdf", width=2, height=3)


##生存分析分train 和 test

NS1B<-subset(NS1,NS1$Histology=="AD" &
               NS1$pStage %in% c("IB"),select=c(1:ncol(NS1)))

NS1B<-NS1B[complete.cases(NS1B$OS.time),]

NS1B1<-merge(NS1B,LUAD6a,by=c("Patients"))


##train
allas<-subset(NS1B1,NS1B1$Patients %in% bc_train1$Patients,select=c(1:ncol(NS1B1)))

##test
allas<-subset(NS1B1,NS1B1$Patients %in% bc_test1$Patients,select=c(1:ncol(NS1B1)))


allas$Type[allas$CENPE >= median(allas$CENPE) ]<-"1High"
allas$Type[allas$CENPE < median(allas$CENPE) ]<-"0Low"

allas$Type[allas$FSCN1 >= median(allas$FSCN1) ]<-"1High"
allas$Type[allas$FSCN1 < median(allas$FSCN1) ]<-"0Low"

allas$Type[allas$SLC2A1 >= median(allas$SLC2A1) ]<-"1High"
allas$Type[allas$SLC2A1 < median(allas$SLC2A1) ]<-"0Low"


allas$Type<-factor(allas$Type,levels=c("0Low","1High"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)
Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#BFEFFF","#F08080"),
                     legend.labs=c("Low","High"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IB CENPE train OS.pdf", width=7, height=6)
ggsave("LUAD IB FSCN1 train OS.pdf", width=7, height=6)
ggsave("LUAD IB SLC2A1 train OS.pdf", width=7, height=6)
ggsave("LUAD IB CENPE test OS.pdf", width=7, height=6)
ggsave("LUAD IB FSCN1 test OS.pdf", width=7, height=6)
ggsave("LUAD IB SLC2A1 test OS.pdf", width=7, height=6)



Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#BFEFFF","#F08080"),
                     legend.labs=c("Low","High"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1


##三组危险分型比较


##IA
##train
qsh1<-subset(NS1u1,NS1u1$SStage=="IA" &
               (NS1u1$Patients %in% bc_train$Patients),select=c(1:ncol(NS1u1)))
qsh2<-dplyr::select(qsh1,OS.time,OS.status,SStage)
qsh2$SStage<-0
allas<-subset(NS1B1,NS1B1$Patients %in% bc_train1$Patients,select=c(1:ncol(NS1B1)))


##test
qsh1<-subset(NS1u1,NS1u1$SStage=="IA" &
               (NS1u1$Patients %in% bc_test$Patients),select=c(1:ncol(NS1u1)))
qsh2<-dplyr::select(qsh1,OS.time,OS.status,SStage)
qsh2$SStage<-0
allas<-subset(NS1B1,NS1B1$Patients %in% bc_test1$Patients,select=c(1:ncol(NS1B1)))




allas$Type1[allas$CENPE >= median(allas$CENPE) ]<-"1High"
allas$Type1[allas$CENPE < median(allas$CENPE) ]<-"0Low"

allas$Type2[allas$FSCN1 >= median(allas$FSCN1) ]<-"1High"
allas$Type2[allas$FSCN1 < median(allas$FSCN1) ]<-"0Low"

allas$Type3[allas$SLC2A1 >= median(allas$SLC2A1) ]<-"1High"
allas$Type3[allas$SLC2A1 < median(allas$SLC2A1) ]<-"0Low"



allas$SStage<-"1Middle"

allas$SStage[allas$Type1=="1High" &
               allas$Type2=="1High"&
               allas$Type3=="1High"]<-"2High"
allas$SStage[allas$Type1=="0Low" &
               allas$Type2=="0Low"&
               allas$Type3=="0Low"]<-"0Low"

allas1<-dplyr::select(allas,OS.time,OS.status,SStage)

allas<-rbind(allas1,qsh2)

table(allas$SStage)

allas$SStage<-factor(allas$SStage,levels=c("0","0Low","1Middle","2High"))

##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~SStage, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~SStage, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~SStage, data=allas)
Ge2
summary(Ge2)
Gefit1<-survfit(Surv(OS.time,OS.status)~SStage, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA 3gene OS train.pdf", width=7, height=6)
ggsave("LUAD IBIA 3gene OS test.pdf", width=7, height=6)


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1





##II
##train
qsh1<-subset(NS1u1,NS1u1$SStage=="II" &
               (NS1u1$Patients %in% bc_train$Patients),select=c(1:ncol(NS1u1)))
qsh2<-dplyr::select(qsh1,OS.time,OS.status,SStage)
qsh2$SStage<-0
allas<-subset(NS1B1,NS1B1$Patients %in% bc_train1$Patients,select=c(1:ncol(NS1B1)))


##test
qsh1<-subset(NS1u1,NS1u1$SStage=="II" &
               (NS1u1$Patients %in% bc_test$Patients),select=c(1:ncol(NS1u1)))
qsh2<-dplyr::select(qsh1,OS.time,OS.status,SStage)
qsh2$SStage<-0
allas<-subset(NS1B1,NS1B1$Patients %in% bc_test1$Patients,select=c(1:ncol(NS1B1)))


allas$Type1[allas$CENPE >= median(allas$CENPE) ]<-"1High"
allas$Type1[allas$CENPE < median(allas$CENPE) ]<-"0Low"

allas$Type2[allas$FSCN1 >= median(allas$FSCN1) ]<-"1High"
allas$Type2[allas$FSCN1 < median(allas$FSCN1) ]<-"0Low"

allas$Type3[allas$SLC2A1 >= median(allas$SLC2A1) ]<-"1High"
allas$Type3[allas$SLC2A1 < median(allas$SLC2A1) ]<-"0Low"



allas$SStage<-"1Middle"

allas$SStage[allas$Type1=="1High" &
               allas$Type2=="1High"&
               allas$Type3=="1High"]<-"2High"
allas$SStage[allas$Type1=="0Low" &
               allas$Type2=="0Low"&
               allas$Type3=="0Low"]<-"0Low"

allas1<-dplyr::select(allas,OS.time,OS.status,SStage)

allas<-rbind(allas1,qsh2)

table(allas$SStage)

allas$SStage<-factor(allas$SStage,levels=c("0","0Low","1Middle","2High"))

##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~SStage, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~SStage, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~SStage, data=allas)
Ge2
summary(Ge2)
Gefit1<-survfit(Surv(OS.time,OS.status)~SStage, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII 3gene OS train.pdf", width=7, height=6)
ggsave("LUAD IBII 3gene OS test.pdf", width=7, height=6)


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1



##三基因的基因富集分析
### ENTREZID SYMBOL
##   6513 SLC2A1
##     1062  CENPE
##     6624  FSCN1
##train
tra1<-dplyr::select(t5,-Patients)
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`1062`,y,method = "spearman")))
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`6624`,y,method = "spearman")))
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`6513`,y,method = "spearman")))


##test
tra1<-dplyr::select(t5t,-Patients)
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`1062`,y,method = "spearman")))
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`6624`,y,method = "spearman")))
q1<-as.data.frame(apply(tra1,2,function(y)cor(tra1$`6513`,y,method = "spearman")))



colnames(q1)<-"r"

q2<-q1$r
names(q2)<-rownames(q1)

q3<-sort(q2,decreasing = T)



options(digits=4)
hallmark<-read.gmt("h.all.v7.4.entrez.gmt")

q4<-as.data.frame(GSEA(q3,TERM2GENE=hallmark,
                       pvalueCutoff =1))

mm1<-q4
mm1$ID<-gsub("HALLMARK_","",mm1$ID)
mm1$Group[mm1$p.adjust <0.05 & mm1$NES>0]<-"Activated"
mm1$Group[mm1$p.adjust <0.05 & mm1$NES<0]<-"Suppressed"
mm2<-subset(mm1,mm1$p.adjust<0.05,select=c(1:ncol(mm1)))
mm2$ID<-factor(mm2$ID,level=mm2$ID[order(mm2$NES)])
Significance<-as.factor(ifelse(mm2$NES>0,"Up-regulated","Down-regulated"))

bp7<-ggplot(mm2,aes(x=NES,y=ID,size=NES))+geom_point()+
  geom_point(aes(color =Significance))+scale_color_manual(values =c("#BFEFFF","#F08080"))+
  labs(title="")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-4,4)+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-2,y=10,label="Suppressed",family="",
           fontface="bold",colour="BLACK",size=4)+
  annotate("text",x=2,y=9,label="Activated",family="",
           fontface="bold",colour="BLACK",size=4)


bp7
ggsave("LUAD IB CENPE train.pdf", width=5, height=6)
ggsave("LUAD IB FSCN1 train.pdf", width=6, height=7)
ggsave("LUAD IB SLC2A1 train.pdf", width=6, height=6)

ggsave("LUAD IB CENPE test.pdf", width=5, height=6)
ggsave("LUAD IB FSCN1 test.pdf", width=6, height=7)
ggsave("LUAD IB SLC2A1 test.pdf", width=5, height=6)



r1<-read.gmt("D:/data/data14/c2.cp.reactome.v7.4.entrez.gmt")
r3<-as.data.frame(GSEA(q3,TERM2GENE=r1))
r4<-separate(r3,ID,c("H","Name"),9)
r4$Name<-factor(r4$Name,level=r4$Name[order(r4$NES)])
Significance<-as.factor(ifelse(r4$NES>0,"Up-regulated","Down-regulated"))
r5<-arrange(r4,r4$Name)
r6<-r5[c(1:10,((nrow(r5)-9):nrow(r5))),]
Significance<-as.factor(ifelse(r6$NES>0,"Up-regulated","Down-regulated"))
r7<-ggplot(r6,aes(x=NES,y=Name,size=NES))+geom_point(aes(color =Significance))+
  labs(title="")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-6.5,6.5)+
  scale_color_manual(values =c("#BFEFFF","#F08080"))+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-3.5,y=7,label="Low-risk",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=3.5,y=3,label="High-risk",family="",
           fontface="bold",colour="BLACK",size=4.5)

r7
ggsave("reactome LUAD IB CENPE train.pdf", width=10, height=6)
ggsave("reactome LUAD IB FSCN1 train.pdf", width=9, height=6)
ggsave("reactome LUAD IB SLC2A1 train.pdf", width=8, height=6)



##评分在IB中的化疗作用
getwd()
setwd("D:/data/data11/LUADs")
getwd()
ch1<-read.table("chemotherapy NSCLC 2.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
table(ch1$Dataset,ch1$chemotherapy)

ch2<-merge(ch1[,c(2:3)],NS1u1,by=c("Patients"))
ch3<-subset(ch2,ch2$SStage=="IB",select=c(1:ncol(ch2)))

all<-ch3
lSsurv<-Surv(all$OS.time,all$OS.status)
all1<-survdiff(Surv(OS.time,OS.status)~chemotherapy, data=all)##p= 5.214e-06
all1
all2<-coxph(Surv(OS.time,OS.status)~chemotherapy,data=all)
all2
summary(all2)

all3<-all

allfit1<-survfit(Surv(OS.time,OS.status)~chemotherapy, data=all3)
mytheme1<-theme_bw()+theme(panel.grid =element_blank())

allcurve1<-ggsurvplot(allfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      legend.labs=c("No","Yes"),
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="adjuvant chemotherapy",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(15, "bold", "black"),
                      font.title=c(15, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(15, "bold", "black"),
                      font.y=c(15, "bold", "black"),
                      font.tickslab=c(12, "bold", "black"))
allcurve1

ggsave("LUAD chemo OS r2.pdf",width=5, height=4)


###

lash<-read.table("LUAD IB HL logstic.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)

te2<-merge(lash,ch3,by=c("Patients"))

all<-te2

121+258+76
121/455 ==0.265
258/455 ==0.567
76/455==0.167
1-0.167==0.833
quantile(all$LAS, probs = 0.75)

all$LAS1[all$LAS>= quantile(all$LAS, 0.833) ]<-"2High"
all$LAS1[(all$LAS < quantile(all$LAS, 0.833))
         & (all$LAS >=quantile(all$LAS, 0.265))]<-"1Middle"
all$LAS1[all$LAS< quantile(all$LAS, 0.265) ]<-"0Low"


ch3<-subset(all,all$LAS1=="0Low",select=c(1:ncol(all)))



allp<-ch3
lSsurv<-Surv(allp$OS.time,allp$OS.status)
all1<-survdiff(Surv(OS.time,OS.status)~chemotherapy, data=allp)##p= 5.214e-06
all1
all2<-coxph(Surv(OS.time,OS.status)~chemotherapy,data=allp)
all2
summary(all2)


##化疗和不同IB类型


te2<-merge(b1[,c(1:2)],ch3,by=c("Patients"))

all<-te2
table(all$Type)

ch3<-subset(all,all$Type=="0L",select=c(1:ncol(all)))



allp<-ch3
lSsurv<-Surv(allp$OS.time,allp$OS.status)
all1<-survdiff(Surv(OS.time,OS.status)~chemotherapy, data=allp)##p= 5.214e-06
all1
all2<-coxph(Surv(OS.time,OS.status)~chemotherapy,data=allp)
all2
summary(all2)



##机器学习三分类


fe1<-t7a
fe1$Type[fe1$Type %in% c("IB1")]<-"0L"
fe1$Type[fe1$Type %in% c("IB2","IB3")]<-"1M"
fe1$Type[fe1$Type %in% c("IB4")]<-"2H"
table(fe1$Type)

fe2<- t5a %>% mutate(across(where(is.character), as.numeric))
class(fe2$`100`)

d2<-dplyr::select(fe2,one_of(factor(a6$GeneID)))
d2$Patients<-rownames(d2)
d3<-merge(fe1,d2,by=c("Patients"))
rownames(d3)<-d3$Patients
trainx<-d3[,-c(1:2)]
trainy<-d3$Type


bc_test1<-subset(bc_test,bc_test$SStage=="IB",select=c(1:ncol(bc_test)))
t5te<-as.data.frame(t(LUAD7))[bc_test1$Patients,]
fe2te<- t5te %>% mutate(across(where(is.character), as.numeric))
class(fe2te$`100`)
d2t<-dplyr::select(fe2te,one_of(factor(a6$GeneID)))

d2t$Type<-"IB1"
d3t<-d2t

testx<-d3t[,-c(ncol(d3t))]
testy<-d3t$Type




##使用sort()函数检查顺序是否相同
is_same_order <- function(v1,v2) {
  return(all(sort(v1) == sort(v2)))
}
print(is_same_order(colnames(d2), colnames(d2t)))



##实际
trainx<-d3[,-c(1:2)]
trainy<-d3$Type
traind<-d3[,-1]

write.csv(trainx, file="trainx1BS.csv",col.names = T,row.names = T)

write.csv(data.frame(t(trainx)), file="trainx1BSTran.csv",col.names = T,row.names = T)


write.csv(trainy, file="trainy1BS.csv",col.names = T,row.names = T)



testx<-d3t[,-c(ncol(d3t))]
testy<-d3t$Type
testd<-d3t[,c(ncol(d3t),1:(ncol(d3t)-1))]

write.csv(testx, file="testx1BS.csv",col.names = T,row.names = T)
write.csv(testy, file="testy1BS.csv",col.names = T,row.names = T)



is_same_order <- function(v1,v2) {
  return(all(sort(v1) == sort(v2)))
}
print(is_same_order(colnames(trainx), colnames(testx)))


is_same_order <- function(v1,v2) {
  return(all(sort(v1) == sort(v2)))
}
print(is_same_order(colnames(traind), colnames(testd)))




set.seed(20220712)
Fit1 = train(trainx,trainy,method ="rf")
Fit2 = train(trainx,trainy,method ="gbm")
Fit3 = train(trainx,trainy,method ="nnet") ##失败
Fit4 = train(trainx,trainy,method ="xgbTree")
Fit5 = train(trainx,trainy,method ="knn")
Fit6 = train(trainx,trainy,method ="pls")
Fit7 = train(trainx,trainy,method ="naive_bayes")
Fit8 = train(trainx,trainy,method ="treebag")
Fit9 = train(trainx,trainy,method ="C5.0")

models = list(Fit1,Fit2,Fit3,Fit4,Fit5,Fit6,Fit7,Fit8,Fit9)

models = list(Fit1,Fit2,Fit4,Fit5,Fit6,Fit7,Fit8,Fit9)

probValues = extractProb(models,testX = testx, testY = testy)
testProbs = subset(probValues, dataType == "Test")

##OK备注每一个预测变量带有样本标签
prob1 = subset(testProbs, model == "rf")  ##ok
prob2 = subset(testProbs, model == "gbm")
prob3 = subset(testProbs, model == "nnet") ####失败
prob4 = subset(testProbs, model == "xgbTree")
prob5 = subset(testProbs, model == "knn")
prob6 = subset(testProbs, model == "pls")  ##ok
prob7 = subset(testProbs, model == "naive_bayes")
prob8 = subset(testProbs, model == "treebag")
prob9 = subset(testProbs, model == "C5.0")  ##ok




write.csv(prob1,file="D:/data/data11/LUADs/Text rfIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob2,file="D:/data/data11/LUADs/Text gbmIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob4,file="D:/data/data11/LUADs/Text xgbTreeIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob5,file="D:/data/data11/LUADs/Text knnIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob6,file="D:/data/data11/LUADs/Text plsIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob7,file="D:/data/data11/LUADs/Text naivebayesIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob8,file="D:/data/data11/LUADs/Text treebagIBLUAD.csv",row.names=T,col.names=T)
write.csv(prob9,file="D:/data/data11/LUADs/Text C5.0IBLUAD.csv",row.names=T,col.names=T)

getwd()

prob4<-read.table("Text xgbTreeIBLUAD.csv",
                   sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)

prob5<-read.table("Text knnIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)



pred <- predict(Fit1, newdata=traind)
pred <- predict(Fit2, newdata=traind)
pred <- predict(Fit4, newdata=traind)
pred <- predict(Fit5, newdata=traind)
pred <- predict(Fit6, newdata=traind)
pred <- predict(Fit7, newdata=traind)
pred <- predict(Fit8, newdata=traind)
pred <- predict(Fit9, newdata=traind)




table(pred)
cm<- confusionMatrix(table(pred, traind$Type))

au1<-as.data.frame(cm$overall)
au2<-as.data.frame(cm$overall)
au4<-as.data.frame(cm$overall)
au5<-as.data.frame(cm$overall)
au6<-as.data.frame(cm$overall)
au7<-as.data.frame(cm$overall)
au8<-as.data.frame(cm$overall)
au9<-as.data.frame(cm$overall)


au<-cbind(au1,au2,au4,au5,au6,au7,au8,au9)
colnames(au)<-c("rf","gbm","xgbTree","knn","pls","naive_bayes","treebag","C5.0")
write.csv(au,file="D:/data/data11/LUADs/Train IBLUAD.csv",row.names=T,col.names=T)



accuracy<- cm$overall['Accuracy']
cm$table


confusion_matrix1 <- ggplot(as.data.frame(cm$table), aes(x = pred, y = Var2, fill = Freq)) +
  geom_tile() +theme_bw()+theme(panel.grid =element_blank())+
  geom_text(aes(label = Freq), color = "white", size = 12) +
  labs(title = "") +
  xlab("Predicted") +
  ylab("Actual") +
  scale_fill_gradient(low = "#BFEFFF", high = "#F08080")+
  theme(axis.title.y=element_text(face="bold",colour="black",
                                  size=14))+
  theme(axis.title.x=element_text(face="bold",colour="black",
                                  size=14))+
  theme(legend.title=element_text(face="bold",colour="black",
                                  size=14))+
  theme(legend.text=element_text(face="bold",colour="black",
                                 size=12))+
  theme(plot.title=element_text(face="bold",colour="black",
                                size=14))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  theme(axis.text.x=element_text(face="bold",colour="black",size=12))

confusion_matrix1

ggsave("confusion_matrix1 LUAD IB rf.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB gbm.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB xgbTree.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB knn.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB pls.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB naive_bayes.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB treebag.pdf",width=4, height=4)
ggsave("confusion_matrix1 LUAD IB C5.pdf",width=4, height=4)



##1 3 6 9有patients 编号，但其余无编号，默认和testd一致，按顺序预测



tey1<-prob1
tey1$Patients<-rownames(tey1)
tey1$Type<-tey1$pred

tey1<-prob6
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred

tey1<-prob9
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred


tey1<-prob2
tey1<-prob4
tey1<-prob5 ##ok
tey1<-prob7 ##ok
tey1<-prob8
tey1$Patients<-rownames(testd)
tey1$Type<-tey1$pred






te2<-merge(bc_test,tey1[,c("Patients","Type")],by=c("Patients"))


identical(tey1$Patients,rownames(testd))

all<-subset(te2,te2$SStage=="IB",select=c(1:ncol(te2)))

all$LAS1<-all$Type


###与IA合并
##IA期
qsh1<-subset(bc_test,bc_test$SStage=="IA",select=c(1:ncol(bc_test)))
qsh1$Type<-"0"
ag1<-all

ag2<-ag1[,-19]


##合并IA、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
table(allas$Type)
allas$Type<-factor(allas$Type,levels=c("0","0L","1M","2H"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("Test LUAD IBIA OS risk rf.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk gbm.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk xgbTree.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk knn.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk pls.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk naive_bayes.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk treebag.pdf", width=7, height=6)
ggsave("Test LUAD IBIA OS risk C5.0.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("IA","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)

qsh1<-subset(bc_test,bc_test$SStage=="II",select=c(1:ncol(bc_test)))

qsh1$Type<-"0"

ag1<-all

ag2<-ag1[,-19]

##合并II、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0L","1M","2H"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("Test LUAD IBII OS risk rf.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk gbm.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk xgbTree.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk knn.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk pls.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk naive_bayes.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS risk treebag.pdf", width=7, height=6)
ggsave("Test LUAD IBII OS C5.0.pdf", width=7, height=6)




Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1a


##IB机器学习拟合评分并够建R包

prob1<-read.table("Text rfIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob2<-read.table("Text gbmIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob4<-read.table("Text xgbTreeIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob5<-read.table("Text knnIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob6<-read.table("Text plsIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob7<-read.table("Text naivebayesIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob8<-read.table("Text treebagIBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)
prob9<-read.table("Text C5.0IBLUAD.csv",
                  sep=",",row.names=1,header=TRUE,stringsAsFactors=FALSE)




tey1<-prob1
tey1$Patients<-rownames(testd)
tey1$Type<-tey1$pred


tey2<-prob2
tey2$Patients<-rownames(testd)
tey2$Type<-tey2$pred

tey4<-prob4
tey4$Patients<-rownames(testd)
tey4$Type<-tey4$pred

tey5<-prob5 ##ok
tey5$Patients<-rownames(testd)
tey5$Type<-tey5$pred

tey6<-prob6 ##ok
tey6$Patients<-rownames(testd)
tey6$Type<-tey6$pred

tey7<-prob7 ##ok
tey7$Patients<-rownames(testd)
tey7$Type<-tey7$pred

tey8<-prob8
tey8$Patients<-rownames(testd)
tey8$Type<-tey8$pred

tey9<-prob9
tey9$Patients<-rownames(testd)
tey9$Type<-tey9$pred



###0L
L1<-subset(tey1,tey1$Type=="0L",select=c(9))
L2<-subset(tey2,tey2$Type=="0L",select=c(9))
L4<-subset(tey4,tey4$Type=="0L",select=c(9))
L5<-subset(tey5,tey5$Type=="0L",select=c(9))
L6<-subset(tey6,tey6$Type=="0L",select=c(9))
L7<-subset(tey7,tey7$Type=="0L",select=c(9))
L8<-subset(tey8,tey8$Type=="0L",select=c(9))
L9<-subset(tey9,tey9$Type=="0L",select=c(9))

inteL<-Reduce(intersect,list(L1$Patients,L2$Patients,L4$Patients,L5$Patients,
                             L6$Patients,L7$Patients))
inteL



library(VennDiagram)
library(grid)
library(futile.logger)
library(venn)

pdf("LUAD IB mash L.pdf",width=3.8, height=3.8)
par(font=2,lwd=0.2,col="black")
s<-venn(list(L1$Patients,L2$Patients,L4$Patients,L5$Patients,
             L6$Patients,L7$Patients),
        snames=c("rf","gbm","xgbTree","knn","pls","naive_bayes"),
        box=F,opacity = 0.5,plotsize=15,ilcs=1,
        borders=F,sncs=1,
        zcolor = c("cyan","red","royalblue","seagreen",
                   "Khaki","PaleVioletRed"))
s
dev.off()



###1M
M1<-subset(tey1,tey1$Type=="1M",select=c(9))
M2<-subset(tey2,tey2$Type=="1M",select=c(9))
M4<-subset(tey4,tey4$Type=="1M",select=c(9))
M5<-subset(tey5,tey5$Type=="1M",select=c(9))
M6<-subset(tey6,tey6$Type=="1M",select=c(9))
M7<-subset(tey7,tey7$Type=="1M",select=c(9))
M8<-subset(tey8,tey8$Type=="1M",select=c(9))
M9<-subset(tey9,tey9$Type=="1M",select=c(9))

inteM<-Reduce(intersect,list(M1$Patients,M2$Patients,M4$Patients,M5$Patients,
                             M6$Patients,M7$Patients))
inteM


library(VennDiagram)
library(grid)
library(futile.logger)
library(venn)

pdf("LUAD IB mash M.pdf",width=3.8, height=3.8)
par(font=2,lwd=0.2,col="black")
s<-venn(list(M1$Patients,M2$Patients,M4$Patients,M5$Patients,
             M6$Patients,M7$Patients),
        snames=c("rf","gbm","xgbTree","knn","pls","naive_bayes"),
        box=F,opacity = 0.5,plotsize=15,ilcs=1,
        borders=F,sncs=1,
        zcolor = c("cyan","red","royalblue","seagreen",
                   "Khaki","PaleVioletRed"))
s
dev.off()

###2H
H1<-subset(tey1,tey1$Type=="2H",select=c(9))
H2<-subset(tey2,tey2$Type=="2H",select=c(9))
H4<-subset(tey4,tey4$Type=="2H",select=c(9))
H5<-subset(tey5,tey5$Type=="2H",select=c(9))
H6<-subset(tey6,tey6$Type=="2H",select=c(9))
H7<-subset(tey7,tey7$Type=="2H",select=c(9))
H8<-subset(tey8,tey8$Type=="2H",select=c(9))
H9<-subset(tey9,tey9$Type=="2H",select=c(9))

inteH<-Reduce(intersect,list(H1$Patients,H2$Patients,H4$Patients,H5$Patients,
                             H6$Patients,H7$Patients))
inteH


library(VennDiagram)
library(grid)
library(futile.logger)
library(venn)

pdf("LUAD IB mash H.pdf",width=3.8, height=3.8)
par(font=2,lwd=0.2,col="black")
s<-venn(list(H1$Patients,H2$Patients,H4$Patients,H5$Patients,
             H6$Patients,H7$Patients),
        snames=c("rf","gbm","xgbTree","knn","pls","naive_bayes"),
        box=F,opacity = 0.5,plotsize=15,ilcs=1,
        borders=F,sncs=1,
        zcolor = c("cyan","red","royalblue","seagreen",
                   "Khaki","PaleVioletRed"))
s
dev.off()


te2<-merge(bc_test,tey1[,c("Patients","Type")],by=c("Patients"))
te2$Type<-NA
te2$Type[te2$Patients %in% inteL]<-"0L"
te2$Type[te2$Patients %in% inteM]<-"1M"
te2$Type[te2$Patients %in% inteH]<-"2H"
table(te2$Type)


identical(tey1$Patients,rownames(testd))

all<-subset(te2,te2$SStage=="IB",select=c(1:ncol(te2)))

all$LAS1<-all$Type


###与IA合并
##IA期
qsh1<-subset(bc_test,bc_test$SStage=="IA",select=c(1:ncol(bc_test)))
qsh1$Type<-"0"
ag1<-all

ag2<-ag1[,-19]


##合并IA、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
table(allas$Type)
allas$Type<-factor(allas$Type,levels=c("0","0L","1M","2H"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##
Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("IA","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("Test LUAD IBIA OS risk all.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("IA","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a





##II期
table(NS1$pStage)

qsh1<-subset(bc_test,bc_test$SStage=="II",select=c(1:ncol(bc_test)))

qsh1$Type<-"0"

ag1<-all

ag2<-ag1[,-19]

##合并II、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0L","1M","2H"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##


Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                     legend.labs=c("II","IB L","IB M","IB H"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("Test LUAD IBII OS risk all.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2","#F08080"),
                      legend.labs=c("II","IB L","IB M","IB H"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a


##去除2H，其余按评分划分
te2<-merge(bc_test,tey1[,c("Patients","Type")],by=c("Patients"))
te2$Type<-1
te2$Type[te2$Patients %in% inteL]<-"0L"
te2$Type[te2$Patients %in% inteM]<-"1M"
te2$Type[te2$Patients %in% inteH]<-"2H"
table(te2$Type)

te3<-subset(te2,te2$Type !="2H",select=c(1:ncol(te2)))


te4<-merge(te3,las4,by=c("Patients"))

all<-subset(te4,te4$SStage=="IB",select=c(1:ncol(te4)))

all$LAS1[all$LAS>= median(all$LAS) ]<-"2High"
all$LAS1[all$LAS< median(all$LAS) ]<-"0Low"

all$LAS1[all$LAS>= quantile(all$LAS, 0.319) ]<-"2High"
all$LAS1[all$LAS< quantile(all$LAS, 0.319) ]<-"0Low"


## 121/(121+258) 0.3192612137
## 258/(121+258) 0.6807387863

table(all$LAS1)

##IA期

qsh1<-subset(bc_test,bc_test$SStage=="IA",select=c(1:ncol(bc_test)))


qsh1$Type<-"0"


ag1<-dplyr::select(all,-Type,-LAS)
ag1<-dplyr::rename(ag1,Type=LAS1)

ag2<-ag1

##合并IA、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","2High"))
##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2"),
                     legend.labs=c("IA","IB L","IB M"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBIA OS riskscore test all.pdf", width=7, height=6)


Gecurve1a<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#BFEFFF","#EED5D2"),
                      legend.labs=c("IA","IB L","IB M"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",
                      legend="top",size=0.4,
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
Gecurve1a





##II期

qsh1<-subset(bc_test,bc_test$SStage=="II",select=c(1:ncol(bc_test)))

qsh1$Type<-"0"


ag1<-dplyr::select(all,-Type,-LAS)
ag1<-dplyr::rename(ag1,Type=LAS1)

ag2<-ag1
##合并II、IB期

he1<-rbind(ag2,qsh1)

allas<-he1
allas<-he1
allas$Type<-factor(allas$Type,levels=c("0","0Low","2High"))

##os
Gesurvp<-Surv(allas$OS.time,allas$OS.status)
Ge<-survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge
Ge1<-pairwise_survdiff(Surv(OS.time,OS.status)~Type, data=allas)
Ge1
Ge2<-coxph(Surv(OS.time,OS.status)~Type, data=allas)
Ge2
summary(Ge2)

Gefit1<-survfit(Surv(OS.time,OS.status)~Type, data=allas)##data=all huibaocuo
mytheme1<-theme_classic(base_family="")
##

Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2"),
                     legend.labs=c("II","IB L","IB M"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
Gecurve1
ggsave("LUAD IBII OS riskscore test all.pdf", width=7, height=6)



Gecurve1<-ggsurvplot(Gefit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#BFEFFF","#EED5D2"),
                     legend.labs=c("II","IB L","IB M"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend="top",size=0.4,
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE)
Gecurve1





###IB分型生物学意义
##按高中低危
table(fe1$Type)

##0L
s1<-fe1
s1$Type[fe1$Type=="0L"]<-"T"
s1$Type[fe1$Type %in% c("1M","2H")]<-"N"
table(s1$Type)


##1M
s1<-fe1
s1$Type[fe1$Type=="1M"]<-"T"
s1$Type[fe1$Type %in% c("0L","2H")]<-"N"
table(s1$Type)


##2H
s1<-fe1
s1$Type[fe1$Type=="2H"]<-"T"
s1$Type[fe1$Type %in% c("0L","1M")]<-"N"
table(s1$Type)

s2<-merge(s1,t7,by=c("Patients"))
rownames(s2)<-s2$Patients
s3<-as.data.frame(t(s2[,-c(1:4)]))
design <- model.matrix(~0+factor(s2$Type))
colnames(design)=levels(factor(s2$Type))
rownames(design)=colnames(s3)
table(s2$Type)
contrast.matrix<-makeContrasts(contrasts = "T-N",levels = design)

fit <- lmFit(s3,design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
diff2 <- topTable(fit2, coef = 1, n = Inf, adjust.method = "BH", sort.by = "P")

diff2$ENTREZID<-rownames(diff2)
gene.df<-bitr(rownames(diff2), fromType = "ENTREZID",
              toType = c("ENTREZID", "SYMBOL"),
              OrgDb = org.Hs.eg.db)
gmm1<-as.data.frame(gene.df)
gmm2<-merge(gmm1,diff2,by=c("ENTREZID"))
gmm3<-subset(gmm2,abs(gmm2$logFC)>1 & gmm2$adj.P.Val<0.05,select=c(1:ncol(gmm2)))


write.csv(gmm2,"LUAD IB 0L.csv",row.names=F)
write.csv(gmm2,"LUAD IB 1M.csv",row.names=F)
write.csv(gmm2,"LUAD IB 2H.csv",row.names=F)


##GSEA分析

msigdbr_species()
human <- msigdbr(species = "Homo sapiens")
dim(human)
table(human$gs_subcat)

##Hallmark
h.human <- msigdbr(species="Homo sapiens",category="H")
colnames(h.human)
h.human1<-h.human %>% dplyr::select(gs_name,gene_symbol)
table(h.human1$gs_name)

length(unique(h.human1$gs_name))


##OL
G1<-read.table("LUAD IB 0L.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()
help(GSEA)
h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB 0L.csv",row.names=F)

h3<-read.table("Hallmark LUAD IB 0L.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)
h4<-separate(h3,ID,c("H","Name"),9)
h4$Name<-factor(h4$Name,level=h4$Name[order(h4$NES)])

Significance<-as.factor(ifelse(h4$NES>0,"Up-regulated","Down-regulated"))

h5<-ggplot(h4,aes(x=NES,y=Name,size=NES))+geom_point(aes(color =Significance))+
  labs(title="Hallmark gene sets")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-6,6)+
  scale_color_manual(values =c("#BFEFFF","#F08080"))+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-3,y=2,label="suppression",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=3.5,y=16,label="activation",family="",
           fontface="bold",colour="BLACK",size=4.5)

h5
ggsave("Hallmark LUAD IB OL.pdf", width=6.5, height=10)


mm1<-h3
mm1$ID<-gsub("HALLMARK_","",mm1$ID)
mm1$Group[mm1$p.adjust <0.05 & mm1$NES>0]<-"Activated"
mm1$Group[mm1$p.adjust <0.05 & mm1$NES<0]<-"Suppressed"
mm2<-subset(mm1,mm1$p.adjust<0.05,select=c(1:ncol(mm1)))
mm2$ID<-factor(mm2$ID,level=mm2$ID[order(mm2$NES)])
mm<-ggplot(mm2, aes(NES,ID,fill=Group)) +
  theme_bw()+theme(panel.grid =element_blank())+
  geom_bar(stat = 'identity',alpha = 0.7)+
  scale_fill_manual(values=c("#F08080","#BFEFFF"))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=10))+
  xlab("NES")+ylab(" ")+labs(title="")+labs(fill="")+
  theme(axis.text.x=element_text(
    face="bold",colour="black",size=10))+
  theme(axis.title.x=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.title=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.text=element_text(face="bold",colour="black",
                                 size=10))

mm

ggsave("Hallmark LUAD IB OL p.pdf",width=7, height=6)


fu1<-subset(G1,G1$adj.P.Val<0.05 & G1$logFC>0.5,select=c(1:ncol(G1)))

library(ReactomePA)
################################
ReactomePA <- enrichPathway(gene = fu1$ENTREZID,
                            organism  = 'human', readable=T,
                            pvalueCutoff = 0.05,
                            qvalueCutoff =0.2)

dotplot(ReactomePA,showCategory = 10)+theme_bw()+
  theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))



all_go_5  <- enrichGO(gene = fu1$ENTREZID,
                      OrgDb = 'org.Hs.eg.db',
                      ont = 'ALL',
                      pvalueCutoff = 0.05,
                      qvalueCutoff =0.2)

all_go_5<-setReadable(all_go_5, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
go_5<-dotplot(all_go_5, split="ONTOLOGY") + facet_grid(ONTOLOGY~., scale="free")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))
go_5





##1M
G1<-read.table("LUAD IB 1M.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()

h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB 1M.csv",row.names=F)

h3<-read.table("Hallmark LUAD IB 1M.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
h4<-separate(h3,ID,c("H","Name"),9)
h4$Name<-factor(h4$Name,level=h4$Name[order(h4$NES)])

Significance<-as.factor(ifelse(h4$NES>0,"Up-regulated","Down-regulated"))

h5<-ggplot(h4,aes(x=NES,y=Name,size=NES))+geom_point(aes(color =Significance))+
  labs(title="Hallmark gene sets")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-6,6)+
  scale_color_manual(values =c("#BFEFFF","#F08080"))+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-3,y=2,label="suppression",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=3.5,y=16,label="activation",family="",
           fontface="bold",colour="BLACK",size=4.5)

h5
ggsave("Hallmark LUAD IB 1M.pdf", width=6.5, height=10)


mm1<-h3
mm1$ID<-gsub("HALLMARK_","",mm1$ID)
mm1$Group[mm1$p.adjust <0.05 & mm1$NES>0]<-"Activated"
mm1$Group[mm1$p.adjust <0.05 & mm1$NES<0]<-"Suppressed"
mm2<-subset(mm1,mm1$p.adjust<0.05,select=c(1:ncol(mm1)))
mm2$ID<-factor(mm2$ID,level=mm2$ID[order(mm2$NES)])
mm<-ggplot(mm2, aes(NES,ID,fill=Group)) +
  theme_bw()+theme(panel.grid =element_blank())+
  geom_bar(stat = 'identity',alpha = 0.7)+
  scale_fill_manual(values=c("#F08080","#BFEFFF"))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=10))+
  xlab("NES")+ylab(" ")+labs(title="")+labs(fill="")+
  theme(axis.text.x=element_text(
    face="bold",colour="black",size=10))+
  theme(axis.title.x=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.title=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.text=element_text(face="bold",colour="black",
                                 size=10))

mm

ggsave("Hallmark LUAD IB 1M p.pdf",width=7, height=6)

fu1<-subset(G1,G1$adj.P.Val<0.05 & G1$logFC>0.5,select=c(1:ncol(G1)))


library(ReactomePA)
################################
ReactomePA <- enrichPathway(gene = fu1$ENTREZID,
                            organism  = 'human', readable=T,
                            pvalueCutoff = 0.05,
                            qvalueCutoff =0.2)

dotplot(ReactomePA,showCategory = 10)+theme_bw()+
  theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))


all_go_5  <- enrichGO(gene = fu1$ENTREZID,
                      OrgDb = 'org.Hs.eg.db',
                      ont = 'ALL',
                      pvalueCutoff = 0.05,
                      qvalueCutoff =0.2)

all_go_5<-setReadable(all_go_5, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
go_5<-dotplot(all_go_5, split="ONTOLOGY") + facet_grid(ONTOLOGY~., scale="free")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))
go_5


##2H
G1<-read.table("LUAD IB 2H.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()

h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB 2H.csv",row.names=F)

h3<-read.table("Hallmark LUAD IB 2H.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
h4<-separate(h3,ID,c("H","Name"),9)
h4$Name<-factor(h4$Name,level=h4$Name[order(h4$NES)])

Significance<-as.factor(ifelse(h4$NES>0,"Up-regulated","Down-regulated"))

h5<-ggplot(h4,aes(x=NES,y=Name,size=NES))+geom_point(aes(color =Significance))+
  labs(title="Hallmark gene sets")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-6,6)+
  scale_color_manual(values =c("#BFEFFF","#F08080"))+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-3,y=2,label="suppression",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=3.5,y=16,label="activation",family="",
           fontface="bold",colour="BLACK",size=4.5)

h5
ggsave("Hallmark LUAD IB 2H.pdf", width=6.5, height=10)


mm1<-h3
mm1$ID<-gsub("HALLMARK_","",mm1$ID)
mm1$Group[mm1$p.adjust <0.05 & mm1$NES>0]<-"Activated"
mm1$Group[mm1$p.adjust <0.05 & mm1$NES<0]<-"Suppressed"
mm2<-subset(mm1,mm1$p.adjust<0.05,select=c(1:ncol(mm1)))
mm2$ID<-factor(mm2$ID,level=mm2$ID[order(mm2$NES)])
mm<-ggplot(mm2, aes(NES,ID,fill=Group)) +
  theme_bw()+theme(panel.grid =element_blank())+
  geom_bar(stat = 'identity',alpha = 0.7)+
  scale_fill_manual(values=c("#F08080","#BFEFFF"))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=10))+
  xlab("NES")+ylab(" ")+labs(title="")+labs(fill="")+
  theme(axis.text.x=element_text(
    face="bold",colour="black",size=10))+
  theme(axis.title.x=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.title=element_text(face="bold",colour="black",
                                  size=12))+
  theme(legend.text=element_text(face="bold",colour="black",
                                 size=10))

mm

ggsave("Hallmark LUAD IB 2H p.pdf",width=7, height=6)


fu1<-subset(G1,G1$adj.P.Val<0.05 & G1$logFC>0.5,select=c(1:ncol(G1)))


library(ReactomePA)
################################
ReactomePA <- enrichPathway(gene = fu1$ENTREZID,
                            organism  = 'human', readable=T,
                            pvalueCutoff = 0.05,
                            qvalueCutoff =0.2)

dotplot(ReactomePA,showCategory = 10)+theme_bw()+
  theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))


all_go_5  <- enrichGO(gene = fu1$ENTREZID,
                      OrgDb = 'org.Hs.eg.db',
                      ont = 'ALL',
                      pvalueCutoff = 0.05,
                      qvalueCutoff =0.2)

all_go_5<-setReadable(all_go_5, OrgDb = org.Hs.eg.db, keyType="ENTREZID")
go_5<-dotplot(all_go_5, split="ONTOLOGY") + facet_grid(ONTOLOGY~., scale="free")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))+
  theme(axis.title.x=element_text(size=12,face="bold",colour="black",family=""))
go_5


##
hu1<-subset(NS1u1,NS1u1$SStage=="IB",
            select=c(1:ncol(NS1u1)))

cb2<-LUAD7[,hu1$Patients]

cb2$ENTREZID<-rownames(cb2)
cb3<-bitr(rownames(cb2), fromType = "ENTREZID",
          toType = c("ENTREZID", "SYMBOL"),
          OrgDb = org.Hs.eg.db)
cb4<-as.data.frame(cb3)
cb5<-merge(cb4,cb2,by=c("ENTREZID"))
rownames(cb5)<-cb5$SYMBOL




if (!requireNamespace("IOBR", quietly = TRUE))
  devtools::install_github("IOBR/IOBR")
library(IOBR)
help(package="IOBR")

tme_deconvolution_methods

# MCPcounter
I4<-deconvo_mcpcounter(eset = cb5[,-c(1:2)],
                       project="LUAD IB"#项目名称
)

I4<-as.data.frame(I4)
rownames(I4)<-I4$ID

I5a<-as.data.frame(scale(I4[,-c(1:2)]))

I5a$Patients<-rownames(I5a)
I5b<-merge(fe1,I5a,by=c("Patients"))

I5c<-lapply(I5b[,-c(1:2)],function(x)kruskal.test(x ~ I5b$Type))

I6<-melt(I5b[,-c(1)],id="Type")
I6$Type<-factor(I6$Type,levels=c("0L","1M","2H"))

"#BFEFFF","#40E0D0","#EED5D2","#F08080"
I7<-ggplot(I6,aes(x=interaction(Type,variable),y=value,fill=Type))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7


# EPIC
I4 <- deconvo_epic(eset = cb5[,-c(1:2)],
                   project="LUAD IB",
                   tumor=TRUE)#是否为肿瘤


I4<-as.data.frame(I4)
rownames(I4)<-I4$ID

I5a<-as.data.frame(scale(I4[,-c(1:2)]))

I5a$Patients<-rownames(I5a)
I5b<-merge(fe1,I5a,by=c("Patients"))

I5c<-lapply(I5b[,-c(1:2)],function(x)kruskal.test(x ~ I5b$Type))

I6<-melt(I5b[,-c(1)],id="Type")
I6$Type<-factor(I6$Type,levels=c("0L","1M","2H"))

"#BFEFFF","#40E0D0","#EED5D2","#F08080"
I7<-ggplot(I6,aes(x=interaction(Type,variable),y=value,fill=Type))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7


# ESTIMATE

I4 <- deconvo_tme(eset = cb5[,-c(1:2)],
                  method = "estimate")#是否为肿瘤


I4<-as.data.frame(I4)
rownames(I4)<-I4$ID

I5a<-as.data.frame(scale(I4[,-c(1)]))

I5a$Patients<-rownames(I5a)
I5b<-merge(fe1,I5a,by=c("Patients"))

I5c<-lapply(I5b[,-c(1:2)],function(x)kruskal.test(x ~ I5b$Type))

I6<-melt(I5b[,-c(1)],id="Type")
I6$Type<-factor(I6$Type,levels=c("0L","1M","2H"))

"#BFEFFF","#40E0D0","#EED5D2","#F08080"
I7<-ggplot(I6,aes(x=interaction(Type,variable),y=value,fill=Type))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7


# TIMER
I4 <- deconvo_tme(eset = cb5[,-c(1:2)],
                          method = "timer",
                          group_list = rep("LUAD",dim(cb5[,-c(1:2)])[2]))

I4<-as.data.frame(I4)
rownames(I4)<-I4$ID

I5a<-as.data.frame(scale(I4[,-c(1)]))

I5a$Patients<-rownames(I5a)
I5b<-merge(fe1,I5a,by=c("Patients"))

I5c<-lapply(I5b[,-c(1:2)],function(x)kruskal.test(x ~ I5b$Type))

I6<-melt(I5b[,-c(1)],id="Type")
I6$Type<-factor(I6$Type,levels=c("0L","1M","2H"))

"#BFEFFF","#40E0D0","#EED5D2","#F08080"
I7<-ggplot(I6,aes(x=interaction(Type,variable),y=value,fill=Type))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7


Gp1<-read.table("LUAD IB 0L.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
fup1<-subset(Gp1,Gp1$adj.P.Val<0.05 & Gp1$logFC>0,select=c(1:ncol(Gp1)))

Gp2<-read.table("LUAD IB 1M.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
fup2<-subset(Gp2,Gp2$adj.P.Val<0.05 & Gp2$logFC>0,select=c(1:ncol(Gp2)))

Gp3<-read.table("LUAD IB 2H.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
fup3<-subset(Gp3,Gp3$adj.P.Val<0.05 & Gp3$logFC>0,select=c(1:ncol(Gp3)))


fup1s<-fup1 %>% top_n(n = 200, wt =logFC)
fup2s<-fup2 %>% top_n(n = 200, wt =logFC)
fup3s<-fup3 %>% top_n(n = 200, wt =logFC)



allg<-data.frame(fup1s$ENTREZID,fup2s$ENTREZID,fup3s$ENTREZID)
colnames(allg)<-c("IB L","IB M","IB H")

library(ReactomePA)
all_ReactomePA <- compareCluster(allg,
                                 fun='enrichPathway',
                                 pvalueCutoff=0.05,
                                 organism="human")

dotplot(all_ReactomePA, showCategory=10, includeAll=FALSE)+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))

ggsave('LUAD IB ReactomePA.pdf', width =8, height = 6)





##各种机器学习预测后情况
tey1<-prob1
tey1$Patients<-rownames(tey1)
tey1$Type<-tey1$pred

tey1<-prob6
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred

tey1<-prob9
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred


tey1<-prob2
tey1<-prob4
tey1<-prob5 ##ok
tey1<-prob7 ##ok
tey1<-prob8
tey1$Patients<-rownames(testd)
tey1$Type<-tey1$pred




table(tey1$Type)

tey1$Type<-as.character(tey1$Type)

##0L
s1<-tey1[,c("Patients","Type")]
s1$Type[tey1$Type=="0L"]<-"T"
s1$Type[tey1$Type %in% c("1M","2H")]<-"N"
table(s1$Type)


##1M
s1<-tey1[,c("Patients","Type")]
s1$Type[tey1$Type=="1M"]<-"T"
s1$Type[tey1$Type %in% c("0L","2H")]<-"N"
table(s1$Type)


##2H
s1<-tey1[,c("Patients","Type")]
s1$Type[tey1$Type=="2H"]<-"T"
s1$Type[tey1$Type %in% c("0L","1M")]<-"N"
table(s1$Type)


s2<-merge(s1,t7t,by=c("Patients"))
rownames(s2)<-s2$Patients
s3<-as.data.frame(t(s2[,-c(1:4)]))
design <- model.matrix(~0+factor(s2$Type))
colnames(design)=levels(factor(s2$Type))
rownames(design)=colnames(s3)
table(s2$Type)
contrast.matrix<-makeContrasts(contrasts = "T-N",levels = design)



fit <- lmFit(s3,design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
diff2 <- topTable(fit2, coef = 1, n = Inf, adjust.method = "BH", sort.by = "P")

diff2$ENTREZID<-rownames(diff2)
gene.df<-bitr(rownames(diff2), fromType = "ENTREZID",
              toType = c("ENTREZID", "SYMBOL"),
              OrgDb = org.Hs.eg.db)
gmm1<-as.data.frame(gene.df)
gmm2<-merge(gmm1,diff2,by=c("ENTREZID"))




Gp1<-gmm2
fup1<-subset(Gp1,Gp1$adj.P.Val<0.05 & Gp1$logFC>0,select=c(1:ncol(Gp1)))

Gp2<-gmm2
fup2<-subset(Gp2,Gp2$adj.P.Val<0.05 & Gp2$logFC>0,select=c(1:ncol(Gp2)))

Gp3<-gmm2
fup3<-subset(Gp3,Gp3$adj.P.Val<0.05 & Gp3$logFC>0,select=c(1:ncol(Gp3)))


fup1s<-fup1 %>% top_n(n = 200, wt =logFC)
fup2s<-fup2 %>% top_n(n = 200, wt =logFC)
fup3s<-fup3 %>% top_n(n = 200, wt =logFC)



allg<-data.frame(fup1s$ENTREZID,fup2s$ENTREZID,fup3s$ENTREZID)
colnames(allg)<-c("IB L","IB M","IB H")

library(ReactomePA)
all_ReactomePA <- compareCluster(allg,
                                 fun='enrichPathway',
                                 pvalueCutoff=0.05,
                                 organism="human")

dotplot(all_ReactomePA, showCategory=10, includeAll=FALSE)+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(axis.text.x=element_text(size=12,face="bold",family="",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.title=element_text(size=10,face="bold",family="",colour="black"))+
  theme(legend.text=element_text(size=10,face="bold",family="",colour="black"))

ggsave('LUAD IB ReactomePA rf.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA gbm.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA xgbTree.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA knn.pdf', width =8, height = 6)

ggsave('LUAD IB ReactomePA pls.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA naive_bayes.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA treebag.pdf', width =8, height = 6)
ggsave('LUAD IB ReactomePA C5.0.pdf', width =8, height = 6)



##建立R包

##先试用riskscore预测IB期生存概率，再通过六种机器学习确定IB-H,在通过riskscore确定IB-L和IB-M

##诺曼图
library(survival)
library(survminer)
library(ggpubr)
library(magrittr)
library(ggplot2)
library(rms)
library(Hmisc)
library(lattice)
library(Formula)
library(grid)

##构建Nomo图
las4<-read.table("LUAD IB HL logstic.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
te2<-merge(bc_train,las4,by=c("Patients"))

all<-subset(te2,te2$SStage=="IB",select=c(1:ncol(te2)))


mm<-all
mm1<-mm[,c("OS.time","OS.status","LAS")]
write.csv(mm1, file="mm1BS.csv",col.names = T,row.names = F)


dd=datadist(mm1)
options(datadist="dd")
options(digits=2)
a1<-cph(Surv(OS.time,OS.status)~LAS,data=mm1,
        x=T, y=T, surv=T)


## 构建生存概率图，注意数据的time是以”月“为单位fun.at=c(0.05,seq(0.1, 0.6, by=0.1), 0.65)
surv<-Survival(a1)# 构建生存概率函数

##画诺曼图需要dd
nom1<-nomogram(a1,lp=FALSE,fun=list(function(x) surv(12, x),
                                    function(x) surv(12*3, x),
                                    function(x) surv(12*5, x)),

               funlabel=c("1-year OS probability",
                          "3-year OS probability",
                          "5-year OS probability"))
plot(nom1)

pdf("IB all OS riskscore nomo.pdf",width=8, height=4)

p1<-plot(nom1,xfrac=0.3, font.var=4,col.var="red",
         cex.axis=0.6,cex.var=0.85,col.grid = gray(c(0.8, 0.95)))
p1
dev.off()


##建立R包及测试
##在Rstudio里创建新软件包IBExpSuv 和 函数IBSurAD/IBMcAD
library(devtools)


setwd("D:/data/data11/LUADs/packages/IBExpSuv")

##将内置数据写入IBExpSuv中的data文件夹，成为.rda中的data文件夹，成为.rda
coef<-read.table("D:/data/data11/LUADs/core1BX.csv",
                 sep=",",header=TRUE,stringsAsFactors=FALSE)
mm1<-read.table("D:/data/data11/LUADs/mm1BS.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
trainxtran<-read.table("D:/data/data11/LUADs/trainx1BSTran.csv",
                       sep=",",header=TRUE,row.names=1,stringsAsFactors=FALSE)
models1<-readRDS("D:/data/data11/models1.rds")
models2<-readRDS("D:/data/data11/models2.rds")

usethis::use_data(coef)
usethis::use_data(mm1)
usethis::use_data(trainxtran)
usethis::use_data(models1)
usethis::use_data(models2)

##调用其他R包
usethis::use_package("rms")
usethis::use_package("pec")
usethis::use_package("survival")
usethis::use_package("caret")
usethis::use_package("dplyr")



##测试

x<-LUAD5[[1]][,-1]


IBSurAD<-function(x){
  x<-x[as.character(coef$Gene),]
  x<-as.data.frame(apply(x,2,as.numeric))
  x<-as.data.frame(sapply(x,function(y)sum(y*(coef$coef))))
  x$Patients<-rownames(x)
  colnames(x)<-c("LAS","Patients")
  a1<-rms::cph(survival::Surv(OS.time,OS.status)~LAS,data=mm1,
               x=T, y=T, surv=T)
  t <- c(1*12,3*12,5*12)
  newd<-as.data.frame(x[,-2])
  colnames(newd)<-"LAS"
  rownames(newd)<-x$Patients
  survprob <- pec::predictSurvProb(a1,newd=newd,times=t)
  survprob1<-as.data.frame(survprob)
  colnames(survprob1)<-c("1-Year OS","3-Year OS","5-Year OS")
  survprob1
}

k<-LUAD5[[1]][,-1]
head(IBSurAD(x))
##正确输出

x<-LUAD5[[1]][,-1]

library(caret)
library(dplyr)

trainxtran<-read.table("D:/data/data11/LUADs/trainx1BSTran.csv",
                   sep=",",header=TRUE,row.names=1,stringsAsFactors=FALSE)
usethis::use_data(trainxtran)

trainx<-as.data.frame(t(trainxtran))

trainy1<-read.table("D:/data/data11/LUADs/trainy1BS.csv",
                   sep=",",header=TRUE,stringsAsFactors=FALSE)

usethis::use_data(trainy1)

trainy<-trainy1$x

Fit1 = train(trainx,trainy,method ="rf")
Fit2 = train(trainx,trainy,method ="gbm")
Fit4 = train(trainx,trainy,method ="xgbTree")
Fit5 = train(trainx,trainy,method ="knn")
Fit6 = train(trainx,trainy,method ="pls")
Fit7 = train(trainx,trainy,method ="naive_bayes")

models = list(Fit1,Fit2,Fit4,Fit5,Fit6,Fit7)

save(models,file = 'D:/data/data11/models.RData')
load('D:/data/data11/models.RData')

saveRDS(models,file = 'D:/data/data11/models.rds') #保存 rds
models<-readRDS('D:/data/data11/models.rds')

models1<-list(models[[1]],models[[2]],models[[3]])
models2<-list(models[[4]],models[[5]],models[[6]])

saveRDS(models1,file = 'D:/data/data11/models1.rds')
saveRDS(models1,file = 'D:/data/data11/models2.rds')


usethis::use_data(models)


x<-LUAD5[[1]][,-1]

IBMcAD<-function(x){
  x1<-x[as.character(rownames(trainxtran)),]
  x2<-as.data.frame(t(x1))
  testx<-x2
  testy<-rep("1B",ncol(x1))
  pred1 <- predict(models1[[1]], newdata=cbind(testy,testx))
  pred2 <- predict(models1[[2]], newdata=cbind(testy,testx))
  pred3 <- predict(models1[[3]], newdata=cbind(testy,testx))
  pred4 <- predict(models2[[1]], newdata=cbind(testy,testx))
  pred5 <- predict(models2[[2]], newdata=cbind(testy,testx))
  pred6 <- predict(models2[[3]], newdata=cbind(testy,testx))

  tey1<-data.frame(pred1)
  tey1$Patients<-rownames(testx)
  tey1<-dplyr::rename(tey1,Type=pred1)
  tey2<-data.frame(pred2)
  tey2$Patients<-rownames(testx)
  tey2<-dplyr::rename(tey2,Type=pred2)
  tey3<-data.frame(pred3)
  tey3$Patients<-rownames(testx)
  tey3<-dplyr::rename(tey3,Type=pred3)
  tey4<-data.frame(pred4)
  tey4$Patients<-rownames(testx)
  tey4<-dplyr::rename(tey4,Type=pred4)
  tey5<-data.frame(pred5)
  tey5$Patients<-rownames(testx)
  tey5<-dplyr::rename(tey5,Type=pred5)
  tey6<-data.frame(pred6)
  tey6$Patients<-rownames(testx)
  tey6<-dplyr::rename(tey6,Type=pred6)

  H1<-subset(tey1,tey1$Type=="2H",select=c(1:2))
  H2<-subset(tey2,tey2$Type=="2H",select=c(1:2))
  H3<-subset(tey3,tey3$Type=="2H",select=c(1:2))
  H4<-subset(tey4,tey4$Type=="2H",select=c(1:2))
  H5<-subset(tey5,tey5$Type=="2H",select=c(1:2))
  H6<-subset(tey6,tey6$Type=="2H",select=c(1:2))


  inteH<-Reduce(intersect,list(H1$Patients,H2$Patients,H3$Patients,
                               H4$Patients,H5$Patients,H6$Patients))
  inteH
  H<-data.frame(inteH,rep("IB H",length(inteH)))
  colnames(H)<-c("Patients","Type")

  x3<-x[as.character(coef$Gene),]
  x3<-as.data.frame(apply(x3,2,as.numeric))
  x3<-as.data.frame(sapply(x3,function(z)sum(z*(coef$coef))))
  x3$Patients<-rownames(x3)
  colnames(x3)<-c("LAS","Patients")


  te2<-merge(x3,tey1[,c("Patients","Type")],by=c("Patients"))
  te2$Type<-1
  te2$Type[te2$Patients %in% inteH]<-"2H"
  te3<-subset(te2,te2$Type !="2H",select=c(1:ncol(te2)))
  te3$LAS1[te3$LAS>= quantile(te3$LAS, 0.319) ]<-"IB M"
  te3$LAS1[te3$LAS< quantile(te3$LAS, 0.319) ]<-"IB L"
  te4<-subset(te3,te3$LAS1=="IB M",select=c(1:ncol(te3)))
  te5<-subset(te3,te3$LAS1=="IB L",select=c(1:ncol(te3)))

  M<-dplyr::select(te4,Patients,LAS1)
  M<-dplyr::rename(M,Type=LAS1)

  L<-dplyr::select(te5,Patients,LAS1)
  L<-dplyr::rename(L,Type=LAS1)

  P<-rbind(H,M,L)

  P

}


head(IBMcAD(x))






##免疫亚型和代谢亚型的进一步建立评分。
##通过随机森林筛选
library(randomForestSRC)
library(tidyverse)
library(ggplot2)
library(ggvenn)
library(glmnet)
library(survival)
library(xgboost)
library(ggpubr)

su1<-subset(fe1,fe1$Type %in% c("0L","1M"),select=c(1:ncol(fe1)))


ct1<-subset(t7,t7$Patients %in% su1$Patients,select=c(1:ncol(t7)))
a2<-sapply(ct1[,-(1:3)],function(x)coxph(Surv(OS.time,OS.status)~x,data=ct1),simplify=FALSE)


ct2<-subset(t7,t7$Patients %in% su1$Patients,select=c(1:ncol(t7)))
a2<-sapply(ct1[,-(1:3)],function(x)coxph(Surv(OS.time,OS.status)~x,data=ct2),simplify=FALSE)


###实验循环提取单一基因数据
###提取列表中每一个变量summary结果
a3<-sapply(a2,function(x)summary(x),simplify=FALSE)
###提取列表中每一个变量summary结果后回归系数的对数 HR
a4<-as.data.frame(sapply(a2,function(x)summary(x)$coefficients[1,2],simplify=TRUE))
a4$GeneID<-rownames(a4)
colnames(a4)<-c("HR","GeneID")
###提取列表中每一个变量的回归summary结果中的回归系数的p值，以矩阵形式保存
a5<-as.data.frame(sapply(a2,function(x)summary(x)$coefficients[1,5],simplify=TRUE))
a5$GeneID<-rownames(a5)
colnames(a5)<-c("p","GeneID")
e4<-merge(a4,a5,by="GeneID")
write.table(e4,"LUAD L IB OR p.csv",sep=",",col.names=T,row.names = F)




e4<-read.table("LUAD L IB OR p.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
a6<-subset(e4,e4$p<0.05,select=c(1:ncol(e4))) ##选择0.05
class(a6$GeneID)
a6$GeneID<-as.character(a6$GeneID)






fit <- rfsrc(Surv(OS.time,OS.status)~., data = LA4[,-1],
             ntree = 1000, nodesize = 14,
             splitrule = 'logrank',
             importance = T,
             proximity = T,
             forest = T)
fit
#绘制OBB图和VIP图
plot(fit,sorted=TRUE,verbose=TRUE)
dev.off()

##绘制重要性变量图
cc6<-as.data.frame(fit$importance)
cc6$Name<-rownames(cc6)
colnames(cc6)<-c("importance","Name")
cc6n<-bitr(cc6$Name, fromType = "ENTREZID",
           toType = c("ENTREZID", "SYMBOL"),
           OrgDb = org.Hs.eg.db)
colnames(cc6)<-c("importance","ENTREZID")
cc6n1<-merge(cc6n,cc6,by=c("ENTREZID"))
cc6a<-cc6n1[order(cc6n1$importance),]

write.csv(cc6a, file="rf LUAD IBMT.csv",col.names = T,row.names = F)


cc6a$SYMBOL<-factor(cc6a$SYMBOL,levels=cc6a$SYMBOL)
options(digits=4)
cc7<-ggplot(cc6a[c((nrow(cc6a)-19):nrow(cc6a)),],aes(x=importance,y=SYMBOL,colour="red",size=importance))+geom_point()+
  xlab("Importance")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=12,
                                face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=12,
                                  face="bold",colour="black"))+
  theme(axis.text.x=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black"))+
  theme(legend.position = "none")

cc7
ggsave("rf impor IJS.pdf", width=4, height=5)





##xgboost算法
x_label<-ifelse(LA4$OS.status==1,LA4$OS.time,-LA4$OS.time)
x_train<-as.matrix(LA4[,c(4:ncol(LA4))])
x_val<-xgb.DMatrix(x_train,
                   label=x_label)
xgb_param<-list("objective"="survival:cox",
                "eval_metric"="cox-nloglik")
xgb.model<-xgb.train(params=xgb_param,
                     data=x_val,
                     nrounds=100,
                     eta=0.1,
                     watchlist=list(val2=x_val))
e<-data.frame(xgb.model$evaluation_log)
ggplot(aes(x=iter,y=val2_cox_nloglik),data=e)+
  geom_point(color="pink",size=3)+
  geom_line()+
  theme_bw()

#筛选VIP值排名前的基因。
imp<-xgb.importance(feature_names=colnames(x_train),model=xgb.model)
write.csv(imp, file="xgboost LUAD IBMT.csv",col.names = T,row.names = F)


impK<-imp[1:30,1:2]

imp1<-bitr(impK$Feature, fromType = "ENTREZID",
           toType = c("ENTREZID", "SYMBOL"),
           OrgDb = org.Hs.eg.db)

colnames(impK)<-c("ENTREZID","importance")
imp1a<-merge(impK,imp1,by=c("ENTREZID"))
imp1b<-imp1a[order(imp1a$importance),]

imp1b$SYMBOL<-factor(imp1b$SYMBOL,levels=imp1b$SYMBOL)
imp1c<-ggplot(imp1b,aes(x=importance,y=SYMBOL,size=importance))+geom_point(colour="#BFEFFF")+
  xlab("Importance")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=12,
                                face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=12,
                                  face="bold",colour="black"))+
  theme(axis.text.x=element_text(size=10,face="bold",
                                 colour="black"))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black"))+
  theme(legend.position = "none")

imp1c
ggsave("xgb impor IJS.pdf", width=4, height=5)




##交集
core1<-intersect(cc6a[c((nrow(cc6a)-39):nrow(cc6a)),]$ENTREZID,imp[1:40,1:2]$Feature) ##有意义
imp1h<-bitr(core1, fromType = "ENTREZID",
            toType = c("ENTREZID", "SYMBOL"),
            OrgDb = org.Hs.eg.db)
write.csv(imp1h, file="core1 LUAD IB MT.csv",col.names = T,row.names = F)
imp1h<-read.table("core1 LUAD IB MT.csv.csv",
                  sep=",",header=TRUE,stringsAsFactors=FALSE)
core1<-imp1h$ENTREZID
##评估上述基因的临床意义
options(digits=8)
##建立Cox模型
LA4a<-LA4[,c("OS.time","OS.status",core1)]


Ge2<-coxph(Surv(OS.time,OS.status)~., data=LA4a)
Ge2
summary(Ge2)
Ge3<-as.data.frame(Ge2$coefficients)
Ge3$Gene<-core1
colnames(Ge3)<-c("coef","Gene")

###输出Ge3
sh1<-Ge3
colnames(sh1)<-c("coef","ENTREZID")
sh2<-merge(imp1h,sh1,by=c("ENTREZID"))
write.csv(sh2, file="core1 LUAD IB MT coef.csv",col.names = T,row.names = F)




xu1b<-t5

xu1b[c(1:3),c(1:3)]

xuge<-intersect(Ge3$Gene,colnames(xu1b))

LUAD7x<-as.data.frame(t(xu1b[,xuge]))

LUAD7xa<-as.data.frame(apply(LUAD7x,2,as.numeric))

las4x<-as.data.frame(sapply(LUAD7xa,function(x)sum(x*Ge3$coef))) ##核查基因和系数是否匹配

las4x$Patients<-rownames(las4x)
colnames(las4x)<-c("LAS","Patients")

write.csv(las4x, file="LUAD IB gene signature COX.csv",row.names=F)


####训练集
getwd()
setwd("D:/data/data3/ASPM/Single LUAD")
##生存分析
las4x<-read.table("LUAD IB gene signature COX.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)

NS1a<-las4x

lR1<-merge(NS1u,NS1a,by=c("Patients"))


lR1a<-subset(lR1,lR1$Patients %in% su1$Patients,select=c(1:ncol(lR1)))


all<-lR1a


all$LAS1[all$LAS>=median(all$LAS)]<-"1High"
all$LAS1[all$LAS<median(all$LAS)]<-"0Low"

table(all$LAS1)
###生存分析
lSsurv<-Surv(all$OS.time,all$OS.status)
all1<-survdiff(Surv(OS.time,OS.status)~LAS1, data=all)#
all1
all2<-coxph(Surv(OS.time,OS.status)~LAS1,data=all)
all2
summary(all2)

all3<-all[c(1:nrow(all)),]
allfit1<-survfit(Surv(OS.time,OS.status)~LAS1, data=all3)
mytheme1<-theme_bw()+theme(panel.grid =element_blank())

allcurve1<-ggsurvplot(allfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      legend.labs=c("Low","High"),
                      palette=c("#F08080","#BFEFFF"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="",size=0.4,
                      legend="top",
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(15, "bold", "black"),
                      font.title=c(15, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(15, "bold", "black"),
                      font.y=c(15, "bold", "black"),
                      font.tickslab=c(12, "bold", "black"))
allcurve1

ggsave("LUAD Hpro OS IJS xu.pdf",width=4, height=4)
ggsave("LUAD Hpro OS IJS IA xu.pdf",width=4, height=4)


allcurve1a<-ggsurvplot(allfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                       legend.labs=c("Low","High"),
                       palette=c("#F08080","#BFEFFF"),
                       pval=FALSE,ggtheme=mytheme1,
                       legend.title="",size=0.4,
                       legend="top",
                       title="",xlab="Months",ylab="OS",
                       font.legend=c(15, "bold", "black"),
                       font.title=c(15, "bold", "black"),
                       surv.median.line="hv",
                       font.x=c(15, "bold", "black"),
                       font.y=c(15, "bold", "black"),
                       font.tickslab=c(12, "bold", "black"),
                       risk.table=TRUE)
allcurve1a




###验证集
xu1b<-t5t

xu1b[c(1:3),c(1:3)]

xuge<-intersect(Ge3$Gene,colnames(xu1b))

LUAD7x<-as.data.frame(t(xu1b[,xuge]))

LUAD7xa<-as.data.frame(apply(LUAD7x,2,as.numeric))

las4x<-as.data.frame(sapply(LUAD7xa,function(x)sum(x*Ge3$coef))) ##核查基因和系数是否匹配

las4x$Patients<-rownames(las4x)
colnames(las4x)<-c("LAS","Patients")

write.csv(las4x, file="LUAD IB gene signature COX test.csv",row.names=F)


####验证集
getwd()

##生存分析
las4x<-read.table("LUAD IB gene signature COX test.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)

NS1a<-las4x

lR1<-merge(NS1u,NS1a,by=c("Patients"))

tey1<-prob1
tey1$Patients<-rownames(tey1)
tey1$Type<-tey1$pred

tey1<-prob6
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred

tey1<-prob9
tey1$Patients<-substring(rownames(tey1),1,nchar(rownames(tey1))-1)
tey1$Type<-tey1$pred


tey1<-prob2
tey1<-prob4
tey1<-prob5 ##ok
tey1<-prob7 ##ok
tey1<-prob8
tey1$Patients<-rownames(testd)
tey1$Type<-tey1$pred


table(tey1$Type)

tey1$Type<-as.character(tey1$Type)


sut1<-subset(tey1,tey1$Type %in% c("0L","1M"),select=c(1:ncol(tey1)))


lR1a<-subset(lR1,lR1$Patients %in% sut1$Patients,select=c(1:ncol(lR1)))


all<-lR1a


all$LAS1[all$LAS>=median(all$LAS)]<-"1High"
all$LAS1[all$LAS<median(all$LAS)]<-"0Low"

table(all$LAS1)
###生存分析
lSsurv<-Surv(all$OS.time,all$OS.status)
all1<-survdiff(Surv(OS.time,OS.status)~LAS1, data=all)#
all1
all2<-coxph(Surv(OS.time,OS.status)~LAS1,data=all)
all2
summary(all2)
all2a<-coxph(Surv(OS.time,OS.status)~LAS,data=all)
all2a
summary(all2a)

all3<-all[c(1:nrow(all)),]
allfit1<-survfit(Surv(OS.time,OS.status)~LAS1, data=all3)
mytheme1<-theme_bw()+theme(panel.grid =element_blank())

allcurve1<-ggsurvplot(allfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      legend.labs=c("Low","High"),
                      palette=c("#F08080","#BFEFFF"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="",size=0.4,
                      legend="top",
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(15, "bold", "black"),
                      font.title=c(15, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(15, "bold", "black"),
                      font.y=c(15, "bold", "black"),
                      font.tickslab=c(12, "bold", "black"))
allcurve1

ggsave("LUAD Hpro OS IJS xu.pdf",width=4, height=4)
ggsave("LUAD Hpro OS IJS IA xu.pdf",width=4, height=4)


allcurve1a<-ggsurvplot(allfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                       legend.labs=c("Low","High"),
                       palette=c("#F08080","#BFEFFF"),
                       pval=FALSE,ggtheme=mytheme1,
                       legend.title="",size=0.4,
                       legend="top",
                       title="",xlab="Months",ylab="OS",
                       font.legend=c(15, "bold", "black"),
                       font.title=c(15, "bold", "black"),
                       surv.median.line="hv",
                       font.x=c(15, "bold", "black"),
                       font.y=c(15, "bold", "black"),
                       font.tickslab=c(12, "bold", "black"),
                       risk.table=TRUE)
allcurve1a





dev.off()









gs1<-read.table("Hallmark LUAD IB 0L.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)
gs2<-read.table("Hallmark LUAD IB 1M.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)
gs3<-read.table("Hallmark LUAD IB 2H.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)

Ha2<-list(gs1[,c(1,5,7)],
          gs2[,c(1,5,7)],
          gs3[,c(1,5,7)])
##
Ha3<-Reduce(function(x,y)merge(x,y,by="ID"),Ha2)
rownames(Ha3)<-Ha3$ID

Ha4<-Ha3[,seq(0,ncol(Ha3),2)]

colnames(Ha4)<-c("0L","1M","2H")
Ha4$Type<-rownames(Ha4)


##
Ha5<-reshape2::melt(Ha4,id=c("Type"))
Ha5a<-subset(Ha5,Ha5$variable=="2H",select=c(1:3))
Ha5b<-dplyr::arrange(Ha5a,Ha5a$value)
Ha5$Type<-factor(Ha5$Type,levels=Ha5b$Type)
Ha6<-ggplot(Ha5,aes(y=Type,x=variable)) +
  geom_point(aes(colour = value),size=6) +
  scale_colour_gradient2(low = "black",mid="white", high = "red")+
  theme_grey(base_size =9)+theme_bw()+
  theme(panel.grid=element_blank())+
  xlab("")+ylab("")+labs("")+labs(colour="NES")+
  theme(axis.text.x=element_text(size=15,face="bold",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",colour="black"))+
  theme(legend.title=element_text(size=15,face="bold",colour="black"))+
  theme(legend.text=element_text(size=12,face="bold",colour="black"))+
  theme(plot.title=element_text(size=25,face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))

Ha6
ggsave("LUAD 1B GSEA Hallmark1.pdf", width=8, height=10)



Ha3<-Reduce(function(x,y)merge(x,y,by="ID"),Ha2)
rownames(Ha3)<-Ha3$ID
Ha4<-Ha3[,seq(0,ncol(Ha3),2)]
colnames(Ha4)<-c("0L","1M","2H")
Ha7<-Ha4
Ha8<-as.data.frame(sapply(Ha7,as.numeric))
rownames(Ha8)<-rownames(Ha4)

max(Ha8)
min(Ha8)
Ha9<-Ha8/(max(Ha8))


##    Ha9a<-Ha9[order(Ha9$ACC,decreasing = T),],Ha9b<-arrange(Ha9,desc(Ha9$ACC))
##
Ha9a<-Ha9[order(Ha9$`2H`,decreasing = F),]

##p
Ha10<-Ha3[,-1]
Ha11<-Ha10[,seq(2,ncol(Ha10),2)]
Ha12<-as.data.frame(sapply(Ha11,as.numeric))
rownames(Ha12)<-rownames(Ha4)
colnames(Ha12)<-c("0L","1M","2H")
Ha13<-Ha12[rownames(Ha9a),]


Hacor<-ggcorrplot(t(Ha9a), legend.title="NES/4.336105",title="",
                  p.mat=t(Ha13),method="square", outline.color="white",
                  insig="blank",ggtheme=ggplot2::theme_bw, colors=c("#000000", "white", "#CC0000"))+
  theme(panel.grid=element_blank())+labs(colour="NES")+
  theme(axis.text.x=element_text(size=15,face="bold",family="serif",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="serif",colour="black"))+
  theme(legend.title=element_text(size=15,face="bold",family="serif",colour="black"))+
  theme(legend.text=element_text(size=12,face="bold",family="serif",colour="black"))+
  theme(plot.title=element_text(size=25,family="serif",face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))

Hacor
ggsave("LUAD 1B GSEA GSEA Hallmark p1.pdf", width=8, height=10)




##免疫浸润分析

hu1<-subset(NS1u1,NS1u1$SStage=="IB" & NS1u1$Dataset=="TCGA-LUAD",
                  select=c(1:ncol(NS1u1)))

hu2<-subset(NS1u1,NS1u1$SStage=="IB" & NS1u1$Dataset!="TCGA-LUAD",
            select=c(1:ncol(NS1u1)))



cb2<-LUAD7[,hu1$Patients]

cb2<-LUAD7[,hu2$Patients]


cb2$ENTREZID<-rownames(cb2)
cb3<-bitr(rownames(cb2), fromType = "ENTREZID",
          toType = c("ENTREZID", "SYMBOL"),
          OrgDb = org.Hs.eg.db)
cb4<-as.data.frame(cb3)
cb5<-merge(cb4,cb2,by=c("ENTREZID"))
rownames(cb5)<-cb5$SYMBOL

write.table(cb5[,-1],file="LUAD TCGA IB.txt",row.names=FALSE,sep="\t")
write.table(cb5[,-1],file="LUAD GEO IB.txt",row.names=FALSE,sep="\t")




source("CIBERSORT.R")
library("e1071")
library("preprocessCore")
??CIBERSORT ##测序数据 QN = TRUE   芯片数据QN = FALSE
ciber <- CIBERSORT(sig_matrix = "LM22.txt",
                   mixture_file = "LUAD TCGA IB.txt",
                   perm = 100,
                   QN = TRUE)
ciber<-as.data.frame(ciber)



ciber2 <- CIBERSORT(sig_matrix = "LM22.txt",
                   mixture_file = "LUAD GEO IB.txt",
                   perm = 100,
                   QN = TRUE)
ciber2<-as.data.frame(ciber2)


ci1<-rbind(ciber,ciber2)

ci1$Patients<-rownames(ci1)
write.csv(ci1,file="D:/data/data11/LUADs/LUAD IB ciber.csv",row.names=F,col.names=T)

##注意由于TCGA和GEO分开计算，记得Z转化
ci2<-merge(ci1,fe1,by=c("Patients"))
rownames(ci2)<-ci2$Patients

I5<-ci2[,-c(1,24:27)]
I5a<-as.data.frame(scale(I5))
I5a$Patients<-rownames(I5a)
I5b<-merge(fe1,I5a,by=c("Patients"))


I5c<-lapply(I5b[,-c(1:2)],function(x)kruskal.test(x ~ I5b$Type))

I6<-melt(I5b[,-1],id="Type")
I6$Type<-factor(I6$Type,levels=c("0L","1M","2H"))

"#BFEFFF","#40E0D0","#EED5D2","#F08080"
I7<-ggplot(I6,aes(x=interaction(Type,variable),y=value,fill=Type))+
  geom_boxplot(colour="black",size=0.1,outlier.colour=NA)+
  ylim(-1,4.2)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7


I5d1<-subset(I5b,I5b$Type=="0L",select=c(1:ncol(I5b)))
I5d2<-subset(I5b,I5b$Type=="1M",select=c(1:ncol(I5b)))
I5d3<-subset(I5b,I5b$Type=="2H",select=c(1:ncol(I5b)))

IM1<-as.data.frame(sapply(I5d1[,-c(1:2)],function(x)median(x)))
colnames(IM1)<-"0L"

IM2<-as.data.frame(sapply(I5d2[,-c(1:2)],function(x)median(x)))
colnames(IM2)<-"1M"

IM3<-as.data.frame(sapply(I5d3[,-c(1:2)],function(x)median(x)))
colnames(IM3)<-"2H"

IM<-cbind(IM1,IM2,IM3)
IM1<-2^(IM)
IM1$type<-rownames(IM1)
I6a<-melt(IM1,id="type")
I6a$variable<-factor(I6a$variable,levels=c("0L","1M","2H"))
class(I6a$value)

I7a<-ggplot(I6a,aes(x=interaction(variable,type),y=value,fill=variable))+
  geom_bar(stat="identity")+
  ylim(0,1.2)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("0L.",unique(I6$variable)),
                   labels=unique(I6$variable))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=10))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Expression")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=10))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")

I7a


##基因突变
L<-read.table("TCGA LUAD mut.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
colnames(L)
Lp<-substring(L$Tumor_Sample_Barcode,1,16)
Lp1<-as.data.frame(table(Lp))
Lp2<-substring(L$Tumor_Sample_Barcode,13,16)
Lp3<-as.data.frame(table(Lp2))
Lp4<-substring(L$Tumor_Sample_Barcode,1,12)
Lp5<-as.data.frame(table(Lp4))

table(L$sample_type_description)
table(L$sample_type_description)
L1<-subset(L,L$sample_type_description!="Recurrent Solid Tumor",select=c(1:21))
table(L1$sample_type_description)
L2<-substring(L1$Tumor_Sample_Barcode,1,12)
L3<-gsub("-",".",L2)
L1$Patients<-L3



##High risk
LMH<-subset(fe1,fe1$Type=="2H",select=c(1:2))
L4<-subset(L1,L1$Patients %in% LMH$Patients,select=c(1:21))
lamH = read.maf(maf = L4)
lamH

pdf("TCGA LUAD IB High risk Mut A.pdf",width=5,height=5)
plotmafSummary(maf = lamH, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

pdf("TCGA LUAD IB High risk Mut20.pdf",width=5,height=5)
oncoplot(maf = lamH, top = 20)
dev.off()

pdf("TCGA LUAD IB High risk pathway Mut.pdf",width=5,height=3)
OncogenicPathways(maf = lamH)
dev.off()

hri<-as.data.frame(OncogenicPathways(maf = lamH))


##median risk
LMM<-subset(fe1,fe1$Type=="1M",select=c(1:2))
L4M<-subset(L1,L1$Patients %in% LMM$Patients,select=c(1:21))
lamM = read.maf(maf = L4M)
lamM

pdf("TCGA LUAD IA M risk Mut A.pdf",width=5,height=5)
plotmafSummary(maf = lamM, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

pdf("TCGA LUAD IA M risk Mut20.pdf",width=5,height=5)
oncoplot(maf = lamM, top = 20)
dev.off()

pdf("TCGA LUAD IA M risk pathway Mut.pdf",width=5,height=3)
OncogenicPathways(maf = lamM)
dev.off()

mri<-as.data.frame(OncogenicPathways(maf = lamM))


##low risk
LML<-subset(fe1,fe1$Type=="0L",select=c(1:2))
L4L<-subset(L1,L1$Patients %in% LML$Patients,select=c(1:21))
lamL = read.maf(maf = L4L)
lamL

pdf("TCGA LUAD IA L risk Mut A.pdf",width=5,height=5)
plotmafSummary(maf = lamL, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

pdf("TCGA LUAD IA L risk Mut20.pdf",width=5,height=5)
oncoplot(maf = c, top = 20)
dev.off()

pdf("TCGA LUAD IA L risk pathway Mut.pdf",width=5,height=3)
OncogenicPathways(maf = lamL)
dev.off()

lri<-as.data.frame(OncogenicPathways(maf = lamL))

rsa<-list(hri[,c(1,5)],mri[,c(1,5)],lri[,c(1,5)])
rs1a<-Reduce(function(x,y)merge(x,y,by="Pathway",all.x=FALSE),rsa,accumulate=FALSE)
rs1a


rs1a$Nel<-13-rs1a$Mutated_samples.x
rs1a$Nem<-42-rs1a$Mutated_samples.y
rs1a$Neh<-24-rs1a$Mutated_samples


rs1b<-rs1a[,c(1,2,5,3,6,4,7)]


##Hippo p-value = 0.05867625
rs1c<-matrix(as.numeric(rs1b[1,-1]),nrow=3,ncol=2,byrow = T)

##MYC p-value = 1
rs1c<-matrix(as.numeric(rs1b[2,-1]),nrow=3,ncol=2,byrow = T)

##NOTCH p-value = 0.0257006
rs1c<-matrix(as.numeric(rs1b[3,-1]),nrow=3,ncol=2,byrow = T)

##NRF2 p-value = 0.717005
rs1c<-matrix(as.numeric(rs1b[4,-1]),nrow=3,ncol=2,byrow = T)

##PI3K p-value = 0.3586619
rs1c<-matrix(as.numeric(rs1b[5,-1]),nrow=3,ncol=2,byrow = T)

##RTK-RAS p-value = 0.3603761
rs1c<-matrix(as.numeric(rs1b[6,-1]),nrow=3,ncol=2,byrow = T)

##TGF-Beta p-value = 0.4573154
rs1c<-matrix(as.numeric(rs1b[7,-1]),nrow=3,ncol=2,byrow = T)

##TP53 p-value = 3.17481e-07
rs1c<-matrix(as.numeric(rs1b[8,-1]),nrow=3,ncol=2,byrow = T)

##WNT p-value = 0.009987725
rs1c<-matrix(as.numeric(rs1b[9,-1]),nrow=3,ncol=2,byrow = T)



chisq.test(rs1c)
fisher.test(rs1c)



rs<-list(hri[,c(1,6)],mri[,c(1,6)],lri[,c(1,6)])
rs1<-Reduce(function(x,y)merge(x,y,by="Pathway",all.x=FALSE),rs,accumulate=FALSE)
rs1

colnames(rs1)<-c("Pathway","IB H",
                 "IB M","IB L")

rs2<-melt(rs1,id="Pathway")

rs2$variable<-factor(rs2$variable,levels=c("IB L","IB M","IB H"))
class(rs2$value)

rs3<-ggplot(rs2,aes(x=interaction(variable,Pathway),y=value,fill=variable))+
  geom_bar(stat="identity")+
  ylim(0,1.2)+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_fill_manual(values=c("#BFEFFF","#EED5D2","#F08080"))+
  theme_bw()+theme(panel.grid =element_blank())+
  scale_x_discrete(breaks=paste0("IB L.",unique(rs2$Pathway)),
                   labels=unique(rs2$Pathway))+
  theme(axis.text.x=element_text(angle=-30,hjust=0,
                                 face="bold",colour="black",size=12))+
  theme(axis.text.y=element_text(face="bold",colour="black",size=12))+
  xlab("")+ylab("Fraction_mutated_samples")+labs(fill="")+labs(title="")+
  theme(axis.title.y=element_text(face="bold",
                                  colour="black",size=14))+
  theme(title=element_text(face="bold",colour="black",size=12))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=15))+
  theme(legend.position="top")+
  annotate("text",x=8,y=1,label="*",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=23,y=1,label="***",
           fontface="bold",colour="BLACK",size=6)+
  annotate("text",x=26,y=1,label="**",
           fontface="bold",colour="BLACK",size=6)


rs3

ggsave("LUAD IB TCGA mutation.pdf", width=6, height=6)




##TMB
##TMB
TMBH=tmb(maf = lamH)
TMBH$Type<-rep("2H",13)
median(TMBH$total_perMB) ##5.52

TMBM=tmb(maf = lamM)
TMBM$Type<-rep("1M",42)
median(TMBM$total_perMB)  ##5.19

TMBL=tmb(maf = lamL)
TMBL$Type<-rep("0L",24)
median(TMBL$total_perMB)  ##1.89

TMBN2<-rbind(TMBH,TMBM,TMBL)
kruskal.test(total_perMB_log~Type, data=TMBN2)






##拷贝数






gs1a<-subset(gs1,gs1$NES>0 & gs1$p.adjust<0.05,select=c(1:ncol(gs1)))
gs2a<-subset(gs2,gs2$NES>0 & gs2$p.adjust<0.05,select=c(1:ncol(gs2)))
gs3a<-subset(gs3,gs3$NES>0 & gs3$p.adjust<0.05,select=c(1:ncol(gs3)))



##按IB亚型
table(t7a$Type)

##IB1
s1<-t7a
s1$Type[t7a$Type=="IB1"]<-"T"
s1$Type[t7a$Type %in% c("IB2","IB3","IB4")]<-"N"
table(s1$Type)


##IB2
s1<-t7a
s1$Type[t7a$Type=="IB2"]<-"T"
s1$Type[t7a$Type %in% c("IB1","IB3","IB4")]<-"N"
table(s1$Type)



##IB3
s1<-t7a
s1$Type[t7a$Type=="IB3"]<-"T"
s1$Type[t7a$Type %in% c("IB1","IB2","IB4")]<-"N"
table(s1$Type)


##IB4
s1<-t7a
s1$Type[t7a$Type=="IB4"]<-"T"
s1$Type[t7a$Type %in% c("IB1","IB2","IB3")]<-"N"
table(s1$Type)




s2<-merge(s1,t7,by=c("Patients"))
rownames(s2)<-s2$Patients
s3<-as.data.frame(t(s2[,-c(1:4)]))
design <- model.matrix(~0+factor(s2$Type))
colnames(design)=levels(factor(s2$Type))
rownames(design)=colnames(s3)
table(s2$Type)
contrast.matrix<-makeContrasts(contrasts = "T-N",levels = design)

fit <- lmFit(s3,design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
diff2 <- topTable(fit2, coef = 1, n = Inf, adjust.method = "BH", sort.by = "P")

diff2$ENTREZID<-rownames(diff2)
gene.df<-bitr(rownames(diff2), fromType = "ENTREZID",
              toType = c("ENTREZID", "SYMBOL"),
              OrgDb = org.Hs.eg.db)
gmm1<-as.data.frame(gene.df)
gmm2<-merge(gmm1,diff2,by=c("ENTREZID"))
gmm3<-subset(gmm2,abs(gmm2$logFC)>1 & gmm2$adj.P.Val<0.05,select=c(1:ncol(gmm2)))


write.csv(gmm2,"LUAD IB IB1.csv",row.names=F)
write.csv(gmm2,"LUAD IB IB2.csv",row.names=F)
write.csv(gmm2,"LUAD IB IB3.csv",row.names=F)
write.csv(gmm2,"LUAD IB IB4.csv",row.names=F)






##GSEA分析

msigdbr_species()
human <- msigdbr(species = "Homo sapiens")
dim(human)
table(human$gs_subcat)

##Hallmark
h.human <- msigdbr(species="Homo sapiens",category="H")
colnames(h.human)
h.human1<-h.human %>% dplyr::select(gs_name,gene_symbol)
table(h.human1$gs_name)

length(unique(h.human1$gs_name))


##IB1
G1<-read.table("LUAD IB IB1.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()
help(GSEA)
h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB1.csv",row.names=F)


##IB2
G1<-read.table("LUAD IB IB2.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()

h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB2.csv",row.names=F)


##IB3
G1<-read.table("LUAD IB IB3.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()

h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB3.csv",row.names=F)


##IB4
G1<-read.table("LUAD IB IB4.csv",
               sep=",",header=TRUE,stringsAsFactors=FALSE)

f10<-data.frame(row.names=G1$SYMBOL,G1$logFC) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)
getwd()

h2<-GSEA(f11,TERM2GENE=h.human1,pvalueCutoff = 1,minGSSize = 0)
h3<-as.data.frame(h2@result)
write.csv(h3,"Hallmark LUAD IB4.csv",row.names=F)




gs1<-read.table("Hallmark LUAD IB1.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)
gs2<-read.table("Hallmark LUAD IB2.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)
gs3<-read.table("Hallmark LUAD IB3.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)
gs4<-read.table("Hallmark LUAD IB4.csv",
                sep=",",header=TRUE,stringsAsFactors=FALSE)




Ha2<-list(gs1[,c(1,5,7)],
          gs2[,c(1,5,7)],
          gs3[,c(1,5,7)],
          gs4[,c(1,5,7)])
##
Ha3<-Reduce(function(x,y)merge(x,y,by="ID"),Ha2)
rownames(Ha3)<-Ha3$ID

Ha4<-Ha3[,seq(0,ncol(Ha3),2)]

colnames(Ha4)<-c("1B1","1B2","1B3","1B4")
Ha4$Type<-rownames(Ha4)


##
Ha5<-reshape2::melt(Ha4,id=c("Type"))
Ha5a<-subset(Ha5,Ha5$variable=="1B4",select=c(1:3))
Ha5b<-dplyr::arrange(Ha5a,Ha5a$value)
Ha5$Type<-factor(Ha5$Type,levels=Ha5b$Type)
Ha6<-ggplot(Ha5,aes(y=Type,x=variable)) +
  geom_point(aes(colour = value),size=6) +
  scale_colour_gradient2(low = "black",mid="white", high = "red")+
  theme_grey(base_size =9)+theme_bw()+
  theme(panel.grid=element_blank())+
  xlab("")+ylab("")+labs("")+labs(colour="NES")+
  theme(axis.text.x=element_text(size=15,face="bold",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",colour="black"))+
  theme(legend.title=element_text(size=15,face="bold",colour="black"))+
  theme(legend.text=element_text(size=12,face="bold",colour="black"))+
  theme(plot.title=element_text(size=25,face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))

Ha6
ggsave("LUAD 1B GSEA Hallmark1 type.pdf", width=8, height=10)



Ha3<-Reduce(function(x,y)merge(x,y,by="ID"),Ha2)
rownames(Ha3)<-Ha3$ID
Ha4<-Ha3[,seq(0,ncol(Ha3),2)]
colnames(Ha4)<-c("IB1","IB2","IB3","IB4")
Ha7<-Ha4
Ha8<-as.data.frame(sapply(Ha7,as.numeric))
rownames(Ha8)<-rownames(Ha4)

max(Ha8)
min(Ha8)
Ha9<-Ha8/(max(Ha8))


##    Ha9a<-Ha9[order(Ha9$ACC,decreasing = T),],Ha9b<-arrange(Ha9,desc(Ha9$ACC))
##
Ha9a<-Ha9[order(Ha9$`IB4`,decreasing = F),]

##p
Ha10<-Ha3[,-1]
Ha11<-Ha10[,seq(2,ncol(Ha10),2)]
Ha12<-as.data.frame(sapply(Ha11,as.numeric))
rownames(Ha12)<-rownames(Ha4)
colnames(Ha12)<-c("IB1","IB2","IB3","IB4")
Ha13<-Ha12[rownames(Ha9a),]


Hacor<-ggcorrplot(t(Ha9a), legend.title="NES/4.336105",title="",
                  p.mat=t(Ha13),method="square", outline.color="white",
                  insig="blank",ggtheme=ggplot2::theme_bw, colors=c("#000000", "white", "#CC0000"))+
  theme(panel.grid=element_blank())+labs(colour="NES")+
  theme(axis.text.x=element_text(size=15,face="bold",family="serif",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="serif",colour="black"))+
  theme(legend.title=element_text(size=15,face="bold",family="serif",colour="black"))+
  theme(legend.text=element_text(size=12,face="bold",family="serif",colour="black"))+
  theme(plot.title=element_text(size=25,family="serif",face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))

Hacor
ggsave("LUAD 1B GSEA GSEA Hallmark p1 type.pdf", width=8, height=10)















gs1a<-subset(gs1,gs1$NES>0 & gs1$p.adjust<0.05,select=c(1:ncol(gs1)))
gs2a<-subset(gs2,gs2$NES>0 & gs2$p.adjust<0.05,select=c(1:ncol(gs2)))
gs3a<-subset(gs3,gs3$NES>0 & gs3$p.adjust<0.05,select=c(1:ncol(gs3)))




##coef
Ha7<-Ha4[,c(1:32)]
Ha8<-as.data.frame(sapply(Ha7,as.numeric))
rownames(Ha8)<-rownames(Ha4)
head(Ha8)
max(Ha8)
min(Ha8)
Ha9<-Ha8/(max(Ha8))
head(Ha9a)

##    Ha9a<-Ha9[order(Ha9$ACC,decreasing = T),],Ha9b<-arrange(Ha9,desc(Ha9$ACC))
##
Ha9a<-Ha9[order(Ha9$ACC,decreasing = F),]

##p
Ha10<-Ha3[,-1]
Ha11<-Ha10[,seq(2,ncol(Ha10),2)]
Ha12<-as.data.frame(sapply(Ha11,as.numeric))
rownames(Ha12)<-rownames(Ha4)
colnames(Ha12)<-files
head(Ha13)
Ha13<-Ha12[rownames(Ha9a),]


Hacor<-ggcorrplot(t(Ha9a), legend.title="NES/4.336105",title="",
                  p.mat=t(Ha13),method="square", outline.color="white",
                  insig="blank",ggtheme=ggplot2::theme_bw, colors=c("#000000", "white", "#CC0000"))+
  theme(panel.grid=element_blank())+labs(colour="NES")+
  theme(axis.text.x=element_text(size=15,face="bold",family="serif",
                                 angle=60,hjust=1,colour="black"))+
  theme(axis.text.y=element_text(size=10,face="bold",family="serif",colour="black"))+
  theme(legend.title=element_text(size=15,face="bold",family="serif",colour="black"))+
  theme(legend.text=element_text(size=12,face="bold",family="serif",colour="black"))+
  theme(plot.title=element_text(size=25,family="serif",face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))

Hacor
ggsave("TCGA CENPF GSEA Hallmark p1.pdf", width=20, height=15)




write.csv(a4,"GSE10072 IA TvsN padj.csv",row.names=F)



ab<-a[!duplicated(a$GeneID),]
rownames(ab)<-ab[,1]

a1<-ab[,ac$Patients]
options(digits=22)


lR1a<-CPD2
lR2<-split(lR1a,lR1a$Dataset)


###OS

HP1<-list()
for(i in seq_along(lR2)){
  HP1[[i]]<-as.data.frame(lR2[[i]])[1,2]}


for(i in seq_along(lR2)){
  HP1[[i]]$HR<-(summary(coxph(Surv(OS.time,OS.status)~LAS,data=lR2[[i]]))$coefficients)[1,2]
  HP1[[i]]$p<-(summary(coxph(Surv(OS.time,OS.status)~LAS,data=lR2[[i]]))$coefficients)[1,5]
  HP1[[i]]$CIL<-(summary(coxph(Surv(OS.time,OS.status)~LAS,data=lR2[[i]]))$conf.int)[1,3]
  HP1[[i]]$CIH<-(summary(coxph(Surv(OS.time,OS.status)~LAS,data=lR2[[i]]))$conf.int)[1,4]
}

HP2<-as.data.frame(do.call("rbind",HP1))

HP2m<-as.data.frame(sapply(HP2,function(x)unlist(x)))##去除列表形式








NS2<-subset(NS1,NS1$Patients %in% colnames(LUAD6)[-1],select=c(1:16))
NS3<-setdiff(colnames(LUAD6),NS2$Patients)[-1]



LUAD5a<-LUAD5
for(i in seq_along(LUAD5)){
  rownames(LUAD5a[[i]])<-LUAD5[[i]]$GeneID
}




##һ???Ծ???
t1<-as.data.frame(t(A2cal))
t2<-as.data.frame(sapply(t1,function(x)((x-min(x))/(max(x)-min(x)))))
rownames(t2)<-rownames(t1)
mad1<-sapply(t2,mad)
t3<-as.data.frame(mad1)
t3a<-arrange(t3,desc(t3$mad1))


##ע????t4,ѡ?????ķ?λ??
quantile(t3$mad1,na.rm=TRUE)##ѡ?????ķ?λ??
t4<-subset(t3,mad1>0.13930861,select=c(1:1))
t5<-A2cal[rownames(t4),]


##ѡ???߱?????????ǰ???٣?ѡ??ǰ5000??????
##t4<-rownames(t3a)[c(1:5000)]
##t5<-A2cal[t4,]


t6<-as.matrix(t(scale(t(t5))))%>%na.omit()


getwd()
title="D:\\data/data11/Concensus"
results = ConsensusClusterPlus(t6,maxK=10,reps=1000,pItem=0.8,pFeature=1,
                               title=title,clusterAlg="pam",

                               distance="euclidean",seed=12341234,plot="pdf")
icl=calcICL(results,plot="pdf")
dev.off()

#????K=2ʱ??һ???Ծ???
results[[2]][["consensusMatrix"]][1:5,1:5]
#hclustѡ??
results[[2]][["consensusTree"]]
#????????
results[[2]][["consensusClass"]][1:20]
t7<-as.data.frame(results[[2]][["consensusClass"]])
colnames(t7)<-c("Type")
t7$Patients<-rownames(t7)
t7$Type[t7$Type=="1"]<-"IB2"
t7$Type[t7$Type=="2"]<-"IB1"
write.csv(t7, file="D:/data/data11/TCGA NSCLC IB consensus type.csv",sep=",",row.names = FALSE)

##????t7
t7<-read.table(file="TCGA NSCLC IB consensus type.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
table(t7$Type)
###????????
setwd("D:/data/data11")
b<-read.table(file="TCGA-CDR 1.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
b1<-merge(t7,b,by=c("Patients"))


##OS
b2o<-subset(b1,b1$OS.time>30,select=c(1:11))  ##112
###????????

b3o<-survdiff(Surv(OS.time, OS)~Type.x, data=b2o)## p= 0.7
b3o
fito<-survfit(Surv((OS.time)/30, OS)~Type.x, data=b2o)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveo<-ggsurvplot(fito,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",
                   legend="top",legend.labs=c("IB1","IB2"),
                   title="",xlab="Months",ylab="OS",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curveo
ggsave("TCGA NSCLC IB OS.pdf", width=6, height=6)





##DSS
b2s<-subset(b1,b1$DSS.time>30,select=c(1:11))##112
###????????
surv<-Surv(b2s$DSS.time,b2s$DSS)
b3s<-survdiff(Surv(DSS.time, DSS)~Type.x, data=b2s)## p= 0.8
b3s
fits<-survfit(Surv((DSS.time)/30, DSS)~Type.x, data=b2s)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curves<-ggsurvplot(fits,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="DSS",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curves
ggsave("TCGA NSCLC IB DSS.pdf", width=6, height=6)



##PFI
b2p<-subset(b1,b1$PFI.time>30,select=c(1:11)) ##112??????
###????????
surv<-Surv(b2p$PFI.time,b2p$PFI)
b3p<-survdiff(Surv(PFI.time, PFI)~Type.x, data=b2p)## p= 0.08
b3p
b4p<-coxph(Surv(PFI.time,PFI)~Type.x,data=b2p)
b4p
summary(b4p)
##HR= 2.106  95CI=0.9099-4.874  p=0.082

fitp<-survfit(Surv((PFI.time)/30, PFI)~Type.x, data=b2p)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curvep<-ggsurvplot(fitp,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="PFI",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curvep
ggsave("TCGA NSCLC IB PFI.pdf", width=6, height=6)





##DFI
b2d<-subset(b1,b1$DFI.time>30,select=c(1:11))  ##94??????
###????????
surv<-Surv(b2d$DFI.time,b2d$DFI)
b3d<-survdiff(Surv(DFI.time, DFI)~Type.x, data=b2d)## p=0.007
b3d
b4d<-coxph(Surv(DFI.time,DFI)~Type.x,data=b2d)
b4d
summary(b4d)
##HR= 4.1698  95CI=1.360-12.782  p=0.0125

fitd<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=b2d)
fitd
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curved<-ggsurvplot(fitd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="DFI",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curved
ggsave("TCGA NSCLC IB DFI.pdf", width=6, height=6)


fitd<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=b2d)
fitd
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curved<-ggsurvplot(fitd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="DFS(%)",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=TRUE,risk.table.y.text=1,
                   risk.table.height=0.4,
                   risk.table.fontsize=7,risk.table.col=c("black"))
curved
ggsave("TCGA NSCLC IB DFI revison1.pdf",width=6, height=2.3)



fitd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=b2d)
fitd
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curved<-ggsurvplot(fitd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",size=0.4,
                   title="",xlab="Years",ylab="DFS(100%)",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curved
ggsave("TCGA NSCLC IB DFI revision2.pdf", width=6, height=6)



fitd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=b2d)
fitd
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curved<-ggsurvplot(fitd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",size=0.4,
                   title="",xlab="Years",ylab="DFS(100%)",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=TRUE,risk.table.y.text=1,
                   risk.table.height=0.4,
                   risk.table.fontsize=7,risk.table.col=c("black"))
curved
ggsave("TCGA NSCLC IB DFI revison3.pdf",width=6, height=2.3)



help(ggsurvplot)
##, width=10, height=10


##???????˲???
setdiff(b2o$Patients,b2s$Patients)
setdiff(b2o$Patients,b2p$Patients) ##?޲???
setdiff(b2d$Patients,b2p$Patients) ##?޲???
setdiff(b2p$Patients,b2d$Patients) ##18?????˲???


###????ָ??Ӣ?ķ??????ظ?
##OS
b2o<-subset(b1,b1$OS.time>30,select=c(1:11))  ##112
b2d<-subset(b1,b1$DFI.time>30,select=c(1:11))  ##94??????
b2o<-b2d
###????????
surv<-Surv(b2$OS.time,b2$OS)
b3o<-survdiff(Surv(OS.time, OS)~Type.x, data=b2o)## p= 0.287
b3o
b3o1<-coxph(Surv(OS.time, OS)~Type.x,data=b2o)
b3o1
summary(b3o1)

##HR= 1.7041  95CI=0.6314-4.599  p=0.293


fito<-survfit(Surv((OS.time)/30, OS)~Type.x, data=b2o)
fito
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveo<-ggsurvplot(fito,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",
                   legend="top",legend.labs=c("IB1","IB2"),
                   title="",xlab="Months",ylab="OS",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curveo
ggsave("TCGA NSCLC IB OS1.pdf", width=6, height=6)


fito<-survfit(Surv((OS.time)/30, OS)~Type.x, data=b2o)
fito
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveo<-ggsurvplot(fito,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",
                   legend="top",legend.labs=c("IB1","IB2"),
                   title="",xlab="Months",ylab="OS",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                    risk.table=TRUE,risk.table.y.text=1,
                   risk.table.height=0.4,
                   risk.table.fontsize=7,risk.table.col=c("black"))
curveo
ggsave("TCGA NSCLC IB OS1 revison1.pdf", width=6, height=2.3)


fito<-survfit(Surv((OS.time)/365, OS)~Type.x, data=b2o)
fito
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveo<-ggsurvplot(fito,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",size=0.4,
                   legend="top",legend.labs=c("IB1","IB2"),
                   title="",xlab="Years",ylab="OS(100%)",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curveo
ggsave("TCGA NSCLC IB OS1 revison2.pdf", width=6, height=6)



fito<-survfit(Surv((OS.time)/365, OS)~Type.x, data=b2o)
fito
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveo<-ggsurvplot(fito,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",size=0.4,
                   legend="top",legend.labs=c("IB1","IB2"),
                   title="",xlab="Years",ylab="OS(100%)",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=TRUE,risk.table.y.text=1,
                   risk.table.height=0.4,
                   risk.table.fontsize=7,risk.table.col=c("black"))
curveo
ggsave("TCGA NSCLC IB OS1 revison3.pdf", width=6, height=2.3)



##DSS
b2s<-subset(b1,b1$DSS.time>30,select=c(1:11))##112
b2d<-subset(b1,b1$DFI.time>30,select=c(1:11))  ##94??????
b2s<-b2d
###????????
surv<-Surv(b2s$DSS.time,b2s$DSS)
b3s<-survdiff(Surv(DSS.time, DSS)~Type.x, data=b2s)## p= 0.2
b3s
fits<-survfit(Surv((DSS.time)/30, DSS)~Type.x, data=b2s)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curves<-ggsurvplot(fits,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="DSS",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curves
ggsave("TCGA NSCLC IB DSS1.pdf", width=6, height=6)



##PFI
b2p<-subset(b1,b1$PFI.time>30,select=c(1:11)) ##112??????
b2d<-subset(b1,b1$DFI.time>30,select=c(1:11))  ##94??????
b2p<-b2d
###????????
surv<-Surv(b2p$PFI.time,b2p$PFI)
b3p<-survdiff(Surv(PFI.time, PFI)~Type.x, data=b2p)## p= 0.009
b3p
b4p<-coxph(Surv(PFI.time,PFI)~Type.x,data=b2p)
b4p
summary(b4p)
##HR=  3.569  95CI=1.3-9.799  p=0.0136

fitp<-survfit(Surv((PFI.time)/30, PFI)~Type.x, data=b2p)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curvep<-ggsurvplot(fitp,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="PFI",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curvep
ggsave("TCGA NSCLC IB PFI1.pdf", width=6, height=6)




#t-sne/u-mapչʾ????????  ##?趨??????
##umap??ά
u1<-t6
u2<-as.data.frame(t(u1))
u2[c(1:3),c(1:3)]
u2[is.na(u2)]<-0
u3<-umap(u2,method='naive',n_neighbors = 15)
u4<-as.data.frame(u3$layout)
u4$Type<-as.factor(t7$Type)
u5<-ggplot(u4,aes(x=V1,y=V2,colour=Type))+geom_point()+
  xlab("UMAP_1")+ylab("UMAP_2")+labs(colour="Type")+
  scale_colour_manual(values=c("#F08080","#696969"))+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "top")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=22))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=24))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
u5
ggsave("TCGA NSCLC IB UMAP.pdf", width=6, height=6)


##t-SNE??ά
n<-Rtsne(u2,
         dims = 2,
         pca = TRUE,
         perplexity = 10,
         theta = 0.0,
         max_iter = 1000)
n1<-data.frame(n$Y,u4$Type)
colnames(n1)<-c("Y1","Y2","Type")
n2<-ggplot(n1,aes(Y1,Y2,colour=Type))+geom_point()+
  xlab("tSNE_1")+ylab("tSNE_2")+labs(colour="Type")+
  scale_colour_manual(values=c("#F08080","#696969"))+
  theme_bw()+theme(panel.grid =element_blank())+labs()+theme(legend.position = "top")+
  theme(axis.text.x=element_text(size=22,face="bold",colour="black",family=""))+
  theme(axis.text.y=element_text(size=22,face="bold",colour="black",family=""))+
  theme(plot.title=element_text(size=25,family="",face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",family="",colour="black",size=24))+
  theme(axis.title.x=element_text(face="bold",family="",colour="black",size=24))+
  theme(legend.text=element_text(face="bold",family="",colour="black",size=22))+
  theme(legend.title=element_text(face="bold",family="",colour="black",size=24))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
n2
ggsave("TCGA NSCLC IB tSNE.pdf", width=6, height=6)



##???͵??ٴ???????????
##IB 1-2 vs IA
##LUAD
IAla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IA",select=c(1:110))
IAla1<-gsub("-",".",IAla$bcr_patient_barcode)

##LUSC
IAls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IA",select=c(1:108))
IAls1<-gsub("-",".",IAls$bcr_patient_barcode)


##?ϲ??ٰ????۰?
IA<-data.frame(IAla1,rep("IA",92))
colnames(IA)<-c("Patients","Type")

IAs<-data.frame(IAls1,rep("IA",43))
colnames(IAs)<-c("Patients","Type")

IAa<-rbind(IA,IAs)##?ϲ?LUAD LUSC ##135

IAa1<-rbind(IAa,t7) ##?ϲ?IB

IAb1<-merge(IAa1,b,by=c("Patients"))

##DFI
IAb2d<-subset(IAb1,IAb1$DFI.time>30,select=c(1:11))  ##203??????  IB 94 IA 109
table(IAb2d$Type.x)
###????????
surv<-Surv(IAb2d$DFI.time,IAb2d$DFI)

IAb3d<-pairwise_survdiff(Surv(DFI.time, DFI)~Type.x, data=IAb2d)##
IAb3d

IAb3d1c<-coxph(Surv(DFI.time, DFI)~Type.x, data=IAb2d)
IAb3d1c
summary(IAb3d1c)

##IB1 vs. IA  0.5632(0.1859-1.706)  pair p 0.324
##IB2 vs. IA  2.5446(1.2487-5.185)  pair p 0.011

fitIAd<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=IAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curveIAd<-ggsurvplot(fitIAd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                   palette=c("#96CDCD","#2B2B2B","#EE6363"),
                   pval=FALSE,ggtheme=mytheme1,
                   legend.title="Type",legend.labs=c("IA","IB1","IB2"),
                   legend="top",
                   title="",xlab="Months",ylab="DFI",
                   font.legend=c(24, "bold", "black"),
                   font.title=c(24, "bold", "black"),
                   surv.median.line="hv",
                   font.x=c(24, "bold", "black"),
                   font.y=c(24, "bold", "black"),
                   font.tickslab=c(20, "bold", "black"),
                   risk.table=FALSE)
curveIAd
ggsave("TCGA NSCLC IB IA DFI.pdf", width=6, height=6)



curveIAd<-ggsurvplot(fitIAd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#96CDCD","#2B2B2B","#EE6363"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IA","IB1","IB2"),
                     legend="top",
                     title="",xlab="Months",ylab="DFI",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE,risk.table.y.text=1,
                     risk.table.height=0.4,
                     risk.table.fontsize=6,risk.table.col=c("black"))
curveIAd
ggsave("TCGA NSCLC IB IA DFI revison1.pdf", width=6, height=2.3)


fitIAd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curveIAd<-ggsurvplot(fitIAd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#96CDCD","#2B2B2B","#EE6363"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IA","IB1","IB2"),
                     legend="top",size=0.4,
                     title="",xlab="Years",ylab="DFS(100%)",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIAd
ggsave("TCGA NSCLC IB IA DFI revison2.pdf", width=6, height=6)



fitIAd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curveIAd<-ggsurvplot(fitIAd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#96CDCD","#2B2B2B","#EE6363"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IA","IB1","IB2"),
                     legend="top",size=0.4,
                     title="",xlab="Years",ylab="DFS(100%)",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE,risk.table.y.text=1,
                     risk.table.height=0.4,
                     risk.table.fontsize=6,risk.table.col=c("black"))
curveIAd
ggsave("TCGA NSCLC IB IA DFI revison3.pdf", width=6, height=2.3)


##OS
IAb2dos<-subset(IAb1,IAb1$OS.time>30,select=c(1:11))  ##203??????  IB 112(IB1 45, IB2 67)   IA 129
table(IAb2dos$Type.x)
###????????
surv<-Surv(IAb2dos$OS.time,IAb2dos$OS)
IAb3dos<-pairwise_survdiff(Surv(OS.time, OS)~Type.x, data=IAb2dos)##
IAb3dos


fitIAdos<-survfit(Surv((OS.time)/30, OS)~Type.x, data=IAb2dos)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
curveIAdos<-ggsurvplot(fitIAdos,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#96CDCD","#2B2B2B","#EE6363"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IA","IB1","IB2"),
                     legend="top",
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIAdos
ggsave("TCGA NSCLC IB IA OS.pdf", width=6, height=6)






##IB 1-2 vs II
##LUAD
IIla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage II"|
               A2$ajcc_pathologic_tumor_stage=="Stage IIA"|
             A2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:110))
IIla1<-gsub("-",".",IIla$bcr_patient_barcode)

##LUSC
IIls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage II"|
                As2$ajcc_pathologic_tumor_stage=="Stage IIA"|
                As2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:108))
IIls1<-gsub("-",".",IIls$bcr_patient_barcode)


##?ϲ??ٰ????۰?
II<-data.frame(IIla1,rep("II",75))
colnames(II)<-c("Patients","Type")

IIs<-data.frame(IIls1,rep("II",86))
colnames(IIs)<-c("Patients","Type")


IIa<-rbind(II,IIs)##?ϲ?LUAD LUSC  ##161

IIa1<-rbind(IIa,t7) ##?ϲ?IB

IIb1<-merge(IIa1,b,by=c("Patients"))

##DFI
IIb2d<-subset(IIb1,IIb1$DFI.time>30,select=c(1:11)) ##197??????
IIb2d1<-subset(IIb2d,IIb2d$Patients!="TCGA.73.4676"|
                 IIb2d$Patients!="TCGA.96.A4JK",select=c(1:11)) ##????????

table(IIb2d$Type.x)
##IB1 IB2  II
##37  57 103

###II
IIP<-subset(IIb2d,IIb2d$Type.x=="II",select=c(1:2))


A2P1<-gsub("-",".",A2$bcr_patient_barcode)
A2$Patients<-A2P1
IIPLUAD<-subset(A2,A2$Patients%in%IIP$Patients,select=c(1:111))
table(IIPLUAD$ajcc_pathologic_tumor_stage)
##LUAD
##Stage II Stage IIA Stage IIB
##1        25        15

As2P1<-gsub("-",".",As2$bcr_patient_barcode)
As2$Patients<-As2P1
IIPLUSC<-subset(As2,As2$Patients%in%IIP$Patients,select=c(1:109))
table(IIPLUSC$ajcc_pathologic_tumor_stage)

##LUSC
##Stage II Stage IIA Stage IIB
##      1        37        24



###????????
surv<-Surv(IIb2d$DFI.time,IIb2d$DFI)
IIb3d<-pairwise_survdiff(Surv(DFI.time, DFI)~Type.x, data=IIb2d)##
IIb3d

IIb2d$TypeX[IIb2d$Type.x =="IB1"]<-"1IB1"
IIb2d$TypeX[IIb2d$Type.x =="IB2"]<-"1IB2"
IIb2d$TypeX[IIb2d$Type.x =="II"]<-"0II"


IIb3dIB1<-coxph(Surv(DFI.time, DFI)~TypeX, data=IIb2d)
IIb3dIB1
summary(IIb3dIB1)

##IB1 vs. II  0.3330(0.1164-0.9529)  pair p 0.053
##IB2 vs. II  1.305(0.6988- 2.4353)  pair p 0.377

fitIId<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=IIb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIId<-ggsurvplot(fitIId,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","II"),
                     legend="top",
                     title="",xlab="Months",ylab="DFI",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIId
ggsave("TCGA NSCLC IB II DFI.pdf", width=6, height=6)



curveIId<-ggsurvplot(fitIId,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","II"),
                     legend="top",
                     title="",xlab="Months",ylab="DFI",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE,risk.table.y.text=1,
                     risk.table.height=0.4,
                     risk.table.fontsize=6,risk.table.col=c("black"))
curveIId
ggsave("TCGA NSCLC IB II DFI revison1.pdf", width=6, height=2.3)


fitIId<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIId<-ggsurvplot(fitIId,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","II"),
                     legend="top",size=0.4,
                     title="",xlab="Years",ylab="DFS(100%)",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIId
ggsave("TCGA NSCLC IB II DFI revison2.pdf", width=6, height=6)

fitIId<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIId<-ggsurvplot(fitIId,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","II"),
                     legend="top",size=0.4,
                     title="",xlab="Years",ylab="DFS(100%)",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=TRUE,risk.table.y.text=1,
                     risk.table.height=0.4,
                     risk.table.fontsize=6,risk.table.col=c("black"))
curveIId
ggsave("TCGA NSCLC IB II DFI revison3.pdf", width=6, height=2.3)








##OS
IIb2dos<-subset(IIb1,IIb1$OS.time>30,select=c(1:11)) ##197??????
IIb2d1os<-subset(IIb2dos,IIb2dos$Patients!="TCGA.73.4676"|
                 IIb2dos$Patients!="TCGA.96.A4JK",select=c(1:11)) ##????????

table(IIb2dos$Type.x)
##IB1 IB2  II
##45  67 154

###II
IIPos<-subset(IIb2dos,IIb2dos$Type.x=="II",select=c(1:2))


A2P1os<-gsub("-",".",A2$bcr_patient_barcode)
A2$Patients<-A2P1os
IIPLUADos<-subset(A2,A2$Patients%in%IIPos$Patients,select=c(1:111))
table(IIPLUADos$ajcc_pathologic_tumor_stage)
##LUAD
##Stage II Stage IIA Stage IIB
##1        43        27

As2P1os<-gsub("-",".",As2$bcr_patient_barcode)
As2$Patients<-As2P1os
IIPLUSCos<-subset(As2,As2$Patients%in%IIPos$Patients,select=c(1:109))
table(IIPLUSCos$ajcc_pathologic_tumor_stage)

##LUSC
##Stage II Stage IIA Stage IIB
##      2        47        34



###????????
survos<-Surv(IIb2dos$OS.time,IIb2dos$OS)
IIb3dos<-pairwise_survdiff(Surv(OS.time, OS)~Type.x, data=IIb2dos)##
IIb3dos



fitIIdos<-survfit(Surv((OS.time)/30, OS)~Type.x, data=IIb2dos)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIdos<-ggsurvplot(fitIIdos,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","II"),
                     legend="top",
                     title="",xlab="Months",ylab="OS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIIdos
ggsave("TCGA NSCLC IB II OS.pdf", width=6, height=6)





##??һ????II IB1 IB2?? 1-3-5 DFI
install.packages("gmodels")
IIlv<-IIb2d[,c(1,3,2,8,9)]

IIlv1<-IIlv
IIlv1$DFIs<-ifelse(IIlv1$DFI.time<(365*5),IIlv1$DFI,0)
library(gmodels)
CrossTable(table(IIlv1$DFIs,IIlv1$Type.x),chisq=T,fisher=T,format="SPSS")
library(rcompanion)
pairwiseNominalIndependence(table(IIlv1$Type.x,IIlv1$DFIs),fisher=F,
                            gtest=F,chisq=T,method="fdr")


###IB 1-2 vs IIA
##LUAD
IIAla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IIA",select=c(1:110))
IIAla1<-gsub("-",".",IIAla$bcr_patient_barcode)

##LUSC
IIAls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IIA",select=c(1:108))
IIAls1<-gsub("-",".",IIAls$bcr_patient_barcode)


##?ϲ??ٰ????۰?
IIA<-data.frame(IIAla1,rep("IIA",45))
colnames(IIA)<-c("Patients","Type")

IIAs<-data.frame(IIAls1,rep("IIA",49))
colnames(IIAs)<-c("Patients","Type")

IIAa<-rbind(IIA,IIAs)##?ϲ?LUAD LUSC

IIAa1<-rbind(IIAa,t7) ##?ϲ?IB

IIAb1<-merge(IIAa1,b,by=c("Patients"))

##DFI
IIAb2d<-subset(IIAb1,IIAb1$DFI.time>30,select=c(1:11))  ##156??????
###????????
surv<-Surv(IIAb2d$DFI.time,IIAb2d$DFI)
IIAb3d<-pairwise_survdiff(Surv(DFI.time, DFI)~Type.x, data=IIAb2d)##
IIAb3d

IIAb2d$TypeX[IIAb2d$Type.x =="IB1"]<-"1IB1"
IIAb2d$TypeX[IIAb2d$Type.x =="IB2"]<-"1IB2"
IIAb2d$TypeX[IIAb2d$Type.x =="IIA"]<-"0IIA"


IIb3dIIA1<-coxph(Surv(DFI.time, DFI)~TypeX, data=IIAb2d)
IIb3dIIA1
summary(IIb3dIIA1)


##IB1 vs. IIA  0.4219(0.1371-1.298)  pair p 0.132
##IB2 vs. IIA  1.8190(0.8672-3.816)  pair p 0.132


fitIIAd<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=IIAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIAd<-ggsurvplot(fitIIAd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#2B2B2B","#EE6363","#96CDCD"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",legend.labs=c("IB1","IB2","IIA"),
                     legend="top",
                     title="",xlab="Months",ylab="DFI",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
curveIIAd
ggsave("TCGA NSCLC IB IIA DFI.pdf", width=6, height=6)


curveIIAd<-ggsurvplot(fitIIAd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIA"),
                      legend="top",
                      title="",xlab="Months",ylab="DFI",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=6,risk.table.col=c("black"))
curveIIAd
ggsave("TCGA NSCLC IB IIA DFI revison1.pdf", width=6, height=2.3)


fitIIAd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIAd<-ggsurvplot(fitIIAd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIA"),
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIIAd
ggsave("TCGA NSCLC IB IIA DFI revision2.pdf", width=6, height=6)

fitIIAd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIAb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIAd<-ggsurvplot(fitIIAd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIA"),
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=6,risk.table.col=c("black"))
curveIIAd
ggsave("TCGA NSCLC IB IIA DFI revison3.pdf", width=6, height=2.3)



##??һ????IIA IB1 IB2?? 1-3-5 DFI
IIAlv<-IIAb2d[,c(1,3,2,8,9)]
IIAlv1<-IIAlv
IIAlv1$DFIs<-ifelse(IIAlv1$DFI.time<(365*5),IIAlv1$DFI,0)
library(gmodels)
CrossTable(table(IIAlv1$DFIs,IIAlv1$Type.x),chisq=T,fisher=T,format="SPSS")
library(rcompanion)
pairwiseNominalIndependence(table(IIAlv1$Type.x,IIAlv1$DFIs),fisher=F,
                            gtest=F,chisq=T,method="fdr")


##OS
IIAb2dos<-subset(IIAb1,IIAb1$OS.time>30,select=c(1:11))  ##202??????
###????????
survos<-Surv(IIAb2dos$OS.time,IIAb2dos$OS)
IIAb3dos<-pairwise_survdiff(Surv(OS.time, OS)~Type.x, data=IIAb2dos)##
IIAb3dos



fitIIAdos<-survfit(Surv((OS.time)/30, OS)~Type.x, data=IIAb2dos)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIAdos<-ggsurvplot(fitIIAdos,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                        palette=c("#2B2B2B","#EE6363","#96CDCD"),
                        pval=FALSE,ggtheme=mytheme1,
                        legend.title="Type",legend.labs=c("IB1","IB2","IIA"),
                        legend="top",
                        title="",xlab="Months",ylab="OS",
                        font.legend=c(24, "bold", "black"),
                        font.title=c(24, "bold", "black"),
                        surv.median.line="hv",
                        font.x=c(24, "bold", "black"),
                        font.y=c(24, "bold", "black"),
                        font.tickslab=c(20, "bold", "black"),
                        risk.table=FALSE)
curveIIAdos
ggsave("TCGA NSCLC IB IIA OS.pdf", width=6, height=6)



###IB 1-2 vs IIB
##LUAD
IIBla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:110))
IIBla1<-gsub("-",".",IIBla$bcr_patient_barcode)

##LUSC
IIBls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:108))
IIBls1<-gsub("-",".",IIBls$bcr_patient_barcode)


##?ϲ??ٰ????۰?
IIB<-data.frame(IIBla1,rep("IIB",29))
colnames(IIB)<-c("Patients","Type")

IIBs<-data.frame(IIBls1,rep("IIB",35))
colnames(IIBs)<-c("Patients","Type")

IIBa<-rbind(IIB,IIBs)##?ϲ?LUAD LUSC

IIBa1<-rbind(IIBa,t7) ##?ϲ?IB

IIBb1<-merge(IIBa1,b,by=c("Patients"))

##DFI
IIBb2d<-subset(IIBb1,IIBb1$DFI.time>30,select=c(1:11))  ##133??????
###????????
surv<-Surv(IIBb2d$DFI.time,IIBb2d$DFI)
IIBb3d<-pairwise_survdiff(Surv(DFI.time, DFI)~Type.x, data=IIBb2d)##
IIBb3d

IIBb2d$TypeX[IIBb2d$Type.x =="IB1"]<-"1IB1"
IIBb2d$TypeX[IIBb2d$Type.x =="IB2"]<-"1IB2"
IIBb2d$TypeX[IIBb2d$Type.x =="IIB"]<-"0IIB"


IIb3dIIB1<-coxph(Surv(DFI.time, DFI)~TypeX, data=IIBb2d)
IIb3dIIB1
summary(IIb3dIIB1)


##IB1 vs. IIB  0.2281(0.07386-0.7043)  pair p 0.011
##IB2 vs. IIB  0.8470(0.40201-1.7847)  pair p 0.661

fitIIBd<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=IIBb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIBd<-ggsurvplot(fitIIBd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIB"),
                      legend="top",
                      title="",xlab="Months",ylab="DFI",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIIBd
ggsave("TCGA NSCLC IB IIB DFI.pdf", width=6, height=6)


curveIIBd<-ggsurvplot(fitIIBd,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIB"),
                      legend="top",
                      title="",xlab="Months",ylab="DFI",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=6,risk.table.col=c("black"))
curveIIBd
ggsave("TCGA NSCLC IB IIB DFI revision1.pdf", width=6, height=2.3)



fitIIBd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIBb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIBd<-ggsurvplot(fitIIBd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIB"),
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIIBd
ggsave("TCGA NSCLC IB IIB DFI revision2.pdf", width=6, height=6)

fitIIBd<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IIBb2d)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIBd<-ggsurvplot(fitIIBd,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIB"),
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=6,risk.table.col=c("black"))
curveIIBd
ggsave("TCGA NSCLC IB IIB DFI revision3.pdf", width=6, height=2.3)



##??һ????IIA IB1 IB2?? 1-3-5 DFI
IIBlv<-IIBb2d[,c(1,3,2,8,9)]
IIBlv1<-IIBlv
IIBlv1$DFIs<-ifelse(IIBlv1$DFI.time<(365*5),IIBlv1$DFI,0)
library(gmodels)
CrossTable(table(IIBlv1$DFIs,IIBlv1$Type.x),chisq=T,fisher=T,format="SPSS")
library(rcompanion)
pairwiseNominalIndependence(table(IIBlv1$Type.x,IIBlv1$DFIs),fisher=F,
                            gtest=F,chisq=T,method="fdr")

##OS
##
IIBb2dos<-subset(IIBb1,IIBb1$OS.time>30,select=c(1:11))  ##173??????
###????????
survos<-Surv(IIBb2dos$OS.time,IIBb2dos$OS)
IIBb3dos<-pairwise_survdiff(Surv(OS.time, OS)~Type.x, data=IIBb2dos)##
IIBb3dos



fitIIBdos<-survfit(Surv((OS.time)/30, OS)~Type.x, data=IIBb2dos)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIIBdos<-ggsurvplot(fitIIBdos,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD"),
                      pval=FALSE,ggtheme=mytheme1,
                      legend.title="Type",legend.labs=c("IB1","IB2","IIB"),
                      legend="top",
                      title="",xlab="Months",ylab="OS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIIBdos
ggsave("TCGA NSCLC IB IIB OS.pdf", width=6, height=6)


###IB1/2 IA II????һ????ͼ
IAII<-rbind(IAa,t7,IIa)  ## IA IB1 IB2  II  135  48  71 161
IAII1<-merge(IAII,b,by=c("Patients"))
##DFI
IAII1a<-subset(IAII1,IAII1$DFI.time>30,select=c(1:11))  ##306??????
###????????
IAII1b<-pairwise_survdiff(Surv(DFI.time, DFI)~Type.x, data=IAII1a)##
IAII1b
surv<-Surv(IAII1a$DFI.time,IAII1a$DFI)
fitIAII<-survfit(Surv((DFI.time)/30, DFI)~Type.x, data=IAII1a)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIAII<-ggsurvplot(fitIAII,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD","#DC143C"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("IA","IB1","IB2","II"),
                      legend.title="Type",
                      legend="top",
                      title="",xlab="Months",ylab="DFS",
                      font.legend=c(20, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIAII
ggsave("TCGA NSCLC IB IA II DFI.pdf", width=6, height=6)




surv<-Surv(IAII1a$DFI.time,IAII1a$DFI)
fitIAII<-survfit(Surv((DFI.time)/365, DFI)~Type.x, data=IAII1a)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##
curveIAII<-ggsurvplot(fitIAII,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD","#DC143C"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("IA","IB1","IB2","II"),
                      legend.title="Type",size=0.4,
                      legend="top",
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(20, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)
curveIAII
ggsave("TCGA NSCLC IB IA II DFI revision.pdf", width=6, height=6)



curveIAIIr<-ggsurvplot(fitIAII,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#2B2B2B","#EE6363","#96CDCD","#DC143C"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("IA","IB1","IB2","II"),
                      legend.title="Type",size=0.4,
                      legend="top",
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(20, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE)
curveIAIIr
ggsave("TCGA NSCLC IB IA II DFI revision2.pdf", width=6, height=2.3)




## biological analysis
##
###????????????
getwd()
setwd("D:/data/data11")
options(digits=1)
f1a<-read.table("mRNA__LUAD__gene_RNAseq__TP__20210531095710.txt",
                header=TRUE,row.names=1,sep="\t",stringsAsFactors = FALSE)
f2a<-f1a[-1,seq(1,ncol(f1a),2)]

f1b<-read.table("mRNA__LUSC__gene_RNAseq__TP__20210601080133.txt",
                header=TRUE,row.names=1,sep="\t",stringsAsFactors = FALSE)
f2b<-f1b[-1,seq(1,ncol(f1b),2)]

f2<-cbind(f2a,f2b)
colnames(f2)<-substring(colnames(f2),1,12)
f3<-as.data.frame(t(f2))
f3[c(1:3),c(1:3)]
f4<-as.data.frame(t(f3[t7$Patients,]))
f5<-sapply(f4,as.numeric)
f6<-as.data.frame(round(f5))
rownames(f6)<-rownames(f4)
condition=factor(t7$Type,ordered=FALSE)
coldata<-data.frame(row.names=t7$Patients,condition)
head(coldata)
dds<-DESeqDataSetFromMatrix(countData =f6,colData=coldata,design=~condition)
dds$condition<-relevel(dds$condition, ref="IB1")
dds<-DESeq(dds)
res<-results(dds)
head(res)
class(res)
f7<-as.data.frame(res)
write.csv(f7, file="D:/data/data11/TCGA NSCLC IB DEs.csv")

options(digits=22)
##???ƻ?ɽͼ
V1<-f7
V0<-read.table("TCGA NSCLC IB DEs.csv",
                header=TRUE,row.names=1,sep=",",stringsAsFactors = FALSE)
V1<-V0

V1$EntrezID<-sapply((strsplit(rownames(V1),"|",fixed=TRUE)), "[", 2)##20531
V1<-subset(V1,V1$EntrezID %in% A2cala$GeneID,select=c(1:ncol(V1)))##20472
V1<-V1 %>% na.omit() ##18852

max(V1$log2FoldChange)##9.5407970671623605
min(V1$log2FoldChange)##-10.5744254321407
max(-1*log10(V1$padj))##56.932797384781317
VHL<-subset(V1,V1$padj<0.05 & abs(V1$log2FoldChange)>1 ,select=c(1:7))##4355
VH<-subset(V1,V1$log2FoldChange>1 & V1$padj<0.05,select=c(1:7))##2423
VL<-subset(V1,(V1$log2FoldChange<(-1))& V1$padj<0.05,select=c(1:7))##1932

Significance<-as.factor(ifelse(V1$padj<0.05&abs(V1$log2FoldChange)>1,ifelse(V1$log2FoldChange>1,"Up-regulated","Down-regulated"),"No significance"))

V2<-ggplot(V1,aes(log2FoldChange,-1*log10(padj)))+geom_point()+
  theme_bw()+theme(panel.grid =element_blank())+xlim(-11,11)+
  ylim(0,60)+labs(title=" ")+xlab("log2FoldChange")+ylab("-log10(adj.pvalue)")+
  geom_hline(yintercept=1.30103,linetype="dashed",size=0.2,colour="black")+
  geom_vline(xintercept=c(-1,1),linetype="dashed",size=0.2,colour="black")+
  geom_point(aes(color =Significance))+
  scale_color_manual(values =c("#006666", "#333333", "#FF3300"))+theme(legend.position="none")+
  theme(axis.text.x=element_text(size=20,face="bold",colour="black"))+
  theme(axis.text.y=element_text(size=20,face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=24,face="bold",colour="black"))+
  theme(axis.title.y=element_text(size=24,face="bold",colour="black"))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))
V2
ggsave("TCGA NSCLC IB vol.pdf", width=6, height=6)



##GSEA
f8<-strsplit(rownames(f7),"|",fixed=TRUE)
f9<-sapply(f8, "[", 2)
f10<-data.frame(row.names=f9,f7$log2FoldChange) %>% na.omit()
colnames(f10)<-c("FC")
f11<-f10$FC
names(f11)<-rownames(f10)
f11=sort(f11,decreasing = T)


h1<-read.gmt("h.all.v7.4.entrez.gmt") #??gmt?ļ? Hallmark
h2<-GSEA(f11,TERM2GENE=h1)
h3<-as.data.frame(h2@result)
write.csv(h3, file="TCGA NSCLC IB Hallmark.csv")
h4<-separate(h3,ID,c("H","Name"),9)
h4$Name<-factor(h4$Name,level=h4$Name[order(h4$NES)])
h5<-ggplot(h4,aes(x=NES,y=Name,size=NES))+geom_point(colour="#006666")+
  labs(title="Hallmark gene sets")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-1,y=1,label="IB1",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=1,y=14,label="IB2",family="",
           fontface="bold",colour="BLACK",size=4.5)

h5
ggsave("Hallmark TCGA NSCLC GSEA IB.pdf", width=5.5, height=5)


k1<-read.gmt("c2.cp.kegg.v7.4.entrez.gmt") #??gmt?ļ? KEGG
k2<-GSEA(f11,TERM2GENE=k1)
k3<-as.data.frame(k2@result)
write.csv(k3, file="TCGA NSCLC IB KEGG.csv")
k4<-separate(k3,ID,c("H","Name"),5)
k4$Name<-factor(k4$Name,level=k4$Name[order(k4$NES)])
k5<-arrange(k4,k4$Name)
k6<-k5[c(1:10,((nrow(k5)-9):nrow(k5))),]
k7<-ggplot(k6,aes(x=NES,y=Name,size=NES))+geom_point(colour="#006666")+
  labs(title="KEGG")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family=""))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family=""))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family=""))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family=""))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-1,y=1,label="IB1",family="",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=1,y=18,label="IB2",family="",
           fontface="bold",colour="BLACK",size=4.5)

k7
ggsave("KEGG TCGA NSCLC GSEA IB.pdf", width=7, height=5)



r1<-read.gmt("c2.cp.reactome.v7.4.entrez.gmt") #??gmt?ļ? reactome
r2<-GSEA(f11,TERM2GENE=r1)
r3<-as.data.frame(r2@result)
write.csv(r3, file="TCGA NSCLC IB reactome.csv")
r4<-separate(r3,ID,c("H","Name"),9)
r4$Name<-factor(r4$Name,level=r4$Name[order(r4$NES)])
r5<-arrange(r4,r4$Name)
r6<-r5[c(1:10,((nrow(r5)-9):nrow(r5))),]
r7<-ggplot(r6,aes(x=NES,y=Name,colour="red",size=NES))+geom_point()+
  labs(title="reactome")+xlab("NES")+ylab("")+
  theme_bw()+theme(panel.grid =element_blank())+
  theme(plot.title=element_text(size=18,
                                face="bold",colour="black",family="serif"))+
  theme(axis.title.x=element_text(size=18,
                                  face="bold",colour="black",family="serif"))+
  theme(axis.text.x=element_text(size=18,face="bold",
                                 colour="black",family="serif"))+
  theme(axis.text.y=element_text(size=12,face="bold",
                                 colour="black",family="serif"))+
  theme(legend.position = "none")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  annotate("text",x=-1,y=1,label="IB1",family="serif",
           fontface="bold",colour="BLACK",size=4.5)+
  annotate("text",x=1,y=20,label="IB2",family="serif",
           fontface="bold",colour="BLACK",size=4.5)

r7
ggsave("reactome TCGA NSCLC GSEA IB.pdf", width=10, height=5)





###ͻ??
##?ߵ???ͻ??ģʽ?ı?

##????TCGA LUAD mut.csv   TCGA LUSC mut.csv

##????LUAD/LUSC ͻ??????
library(maftools)
library(TCGAmutations)
as.data.frame(tcga_available())##?鿴??R????????TCGA??????????
tcga_available()##



getwd()
setwd("D:/data/data11")
LUAD<-tcga_load(study = "LUAD") # Ĭ?ϼ??ؾ???У?????ĸ???Ȥ???? maf?ļ???ѡȡ?Լ???Ҫ??????
d1<- as.data.frame(LUAD@data)
write.table(d1,file="TCGA LUAD mut.csv",row.names=FALSE,sep=",")
write.table(d1,file="TCGA LUAD mut.maf",row.names=FALSE,sep=",")


LUSC<-tcga_load(study = "LUSC") # Ĭ?ϼ??ؾ???У?????ĸ???Ȥ???? maf?ļ???ѡȡ?Լ???Ҫ??????
d2<- as.data.frame(LUSC@data)
write.table(d2,file="TCGA LUSC mut.csv",row.names=FALSE,sep=",")
write.table(d2,file="TCGA LUSC mut.maf",row.names=FALSE,sep=",")



L<-rbind(d1,d2)
colnames(L)
Lp<-substring(L$Tumor_Sample_Barcode,1,16)
Lp1<-as.data.frame(table(Lp))
Lp2<-substring(L$Tumor_Sample_Barcode,13,16)
Lp3<-as.data.frame(table(Lp2))
Lp4<-substring(L$Tumor_Sample_Barcode,1,12)
Lp5<-as.data.frame(table(Lp4))

table(L$sample_type_description)
table(L$sample_type_description)
L1<-subset(L,L$sample_type_description!="Recurrent Solid Tumor",select=c(1:21))
table(L1$sample_type_description)
L2<-substring(L1$Tumor_Sample_Barcode,1,12)
L3<-gsub("-",".",L2)
L1$Patients<-L3

##IB1
LMH<-subset(t7,t7$Type=="IB1",seect=c(1:2))
L4<-subset(L1,L1$Patients %in% LMH$Patients,select=c(1:21))
lamH = read.maf(maf = L4)##???ظ???Ȥ?????ļ???ת??ΪMAF??ʽ
lamH###???????ݼ?ͻ???????ܽ?

##ͼ??չʾ???????ݼ? MAF??ʽ?ܽ?
pdf("TCGA NSCLC IB1 Mut.pdf",width=5,height=5)
plotmafSummary(maf = lamH, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

###ͼ??չʾoncoplotͼ
pdf("TCGA NSCLC IB1 Mut20.pdf",width=5,height=5)
oncoplot(maf = lamH, top = 20)
dev.off()

##չʾSNP??Transitions_vs_Transversions????
pdf("TCGA NSCLC IB1 Trans Mut.pdf",width=5,height=5)
lamH.titv = titv(maf = lamH, plot = FALSE, useSyn = TRUE)
plotTiTv(res = lamH.titv)
dev.off()


###??֢?е????????𼲲??Ļ?????ͬ??????????ͻ??ģʽ????ʾ??ǿ?ҵ??????ԡ?
##????ʹ??somaticInteractions????
##ʹ??????Fisher 's??ȷ????????
##ͻ??????֮???ĵ?co-occurring ????exclusiveness??
#exclusive/co-occurance event analysis on top 10 mutated genes.

pdf("TCGA LUAD NSCLC IB1 Int Mut.pdf",width=5,height=5)
Interact <- somaticInteractions(maf = lamH, top = 25, pvalue = c(0.05, 0.1))
dev.off()

#??ȡPֵ????
Interact$pValue

###OncogenicPathways ???ܲ鿴????????ͨ·
pdf("TCGA NSCLC IB1 pathway Mut.pdf",width=5,height=3)
OncogenicPathways(maf = lamH)
dev.off()

##?鿴????Ȥͨ·
PlotOncogenicPathways(maf = lamH, pathways = "RTK-RAS")







##
##IB2
LML<-subset(t7,t7$Type=="IB2",seect=c(1:2))
L5<-subset(L1,L1$Patients %in% LML$Patients,select=c(1:21))
lamL = read.maf(maf = L5)##???ظ???Ȥ?????ļ???ת??ΪMAF??ʽ
lamL###???????ݼ?ͻ???????ܽ?

##ͼ??չʾ???????ݼ? MAF??ʽ?ܽ?
pdf("TCGA NSCLC IB2 Mut A.pdf",width=5,height=5)
plotmafSummary(maf = lamL, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
dev.off()

###ͼ??չʾoncoplotͼ
pdf("TCGA NSCLC IB2 Mut20.pdf",width=5,height=5)
oncoplot(maf = lamL, top = 20)
dev.off()

##չʾSNP??Transitions_vs_Transversions????
pdf("TCGA NSCLC IB2 Trans Mut.pdf",width=5,height=5)
lamL.titv = titv(maf = lamL, plot = FALSE, useSyn = TRUE)
plotTiTv(res = lamL.titv)
dev.off()


###??֢?е????????𼲲??Ļ?????ͬ??????????ͻ??ģʽ????ʾ??ǿ?ҵ??????ԡ?
##????ʹ??somaticInteractions????
##ʹ??????Fisher 's??ȷ????????
##ͻ??????֮???ĵ?co-occurring ????exclusiveness??
#exclusive/co-occurance event analysis on top 10 mutated genes.

pdf("TCGA NSCLC IB2 Int Mut.pdf",width=5,height=5)
Interact <- somaticInteractions(maf = lamL, top = 25, pvalue = c(0.05, 0.1))
dev.off()

#??ȡPֵ????
Interact$pValue

###OncogenicPathways ???ܲ鿴????????ͨ·
pdf("TCGA NSCLC IB2 pathway Mut.pdf",width=5,height=3)
OncogenicPathways(maf = lamL)
dev.off()

##?鿴????Ȥͨ·
PlotOncogenicPathways(maf = lamL, pathways = "RTK-RAS")


##TMB
##TMB
TMBH=tmb(maf = lamH)
TMBH$Type<-rep("IB1",46)
TMBL=tmb(maf = lamL)
TMBL$Type<-rep("1B2",70)
TMBN2<-rbind(TMBH,TMBL)
wilcox.test(total_perMB_log~Type, data=TMBN2,paired=FALSE,
            exact=FALSE)
##ͻ?为???޲???
TMBN21<-ggplot(TMBN2,aes(x=Type,y=total_perMB,fill=Type))+
  geom_boxplot(colour="black",size=0.5)+theme_bw()+theme(panel.grid=element_blank())+
  scale_fill_manual(values=c("#F08080","#696969"))+
  theme(axis.text.y=element_text(face="bold",
                                 colour="black",size=15))+
  theme(axis.text.x=element_text(face="bold",
                                 colour="black",size=13))+
  xlab("")+ylab("TMB")+labs(title="")+labs(fill="Type")+
  theme(plot.title=element_text(size=5,face="bold",colour="black"))+
  theme(axis.title.y=element_text(face="bold",colour="black",size=15))+
  theme(legend.title=element_text(size=15,face="bold",colour="black"))+
  theme(legend.text=element_text(face="bold",colour="black",size=15))+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))+guides(fill=F)


TMBN21
ggsave("TCGA NSCLC IB TMB.pdf", width=4, height=4)
dev.off()



###?????ӷ??? IB??ָ??
###??????????????DFI??Ԥ??
HD<-subset(A2cala,A2cala$GeneID %in% VH$EntrezID,select=c(1:ncol(A2cala)))
LD<-subset(A2cala,A2cala$GeneID %in% VL$EntrezID,select=c(1:ncol(A2cala)))

##?߱???
HD1<-as.data.frame(t(HD[,-1]))
HD2<-as.data.frame(scale(HD1))
HD2$Patients<-rownames(HD2)
HD3<-merge(b,HD2,by=c("Patients"))
###??ÿһ?????ֱ?????COX?ع?
HD4<-sapply(HD3[,-(1:10)],function(x)coxph(Surv(DFI.time,DFI)~x,data=HD3),simplify=FALSE)
###??ȡ?б???ÿһ????summary???????ع?ϵ??
HD5<-as.data.frame(t(as.data.frame(sapply(HD4,function(x)summary(x)$coefficients[1,1],simplify=FALSE))))
HD5$EntrezID<-colnames(HD1)
###??ȡ?б???ÿһ??????summary?????еĻع?ϵ????pֵ???Ծ?????ʽ????
HD6<-as.data.frame(t(as.data.frame(sapply(HD4,function(x)summary(x)$coefficients[1,5],simplify=FALSE))))
HD6$EntrezID<-colnames(HD1)
HD7<-merge(HD5,HD6,by=c("EntrezID"))
colnames(HD7)<-c("EntrezID","coef","p")
HD7$HR<-exp(HD7$coef)
HD8<-subset(HD7,HD7$p<0.05&HD7$coef>0,select=c(1:4))  ##300???߱?????????????????


library(reshape)
library(ggplot2)
##"#006666", "#333333", "#FF3300"
bs<-as.factor(ifelse(HD7$p<0.05,ifelse(HD7$coef>0,"Up-regulated","Down-regulated"),"No significance"))
g1<-ggplot(HD7,aes(coef,-1*log10(p)))+geom_point()+theme_bw()+
  xlab("coef")+ylab("-log10(pvalue)")+xlim(-4,6)+
  geom_hline(yintercept=1.30103,linetype="dashed",size=0.2,colour="black")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  geom_point(aes(color=bs))+scale_color_manual(values =c("#333333", "#FF3300"))+
  theme(axis.text.x=element_text(size=20,face="bold",colour="black"))+
  theme(axis.text.y=element_text(size=20,face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=24,face="bold",colour="black"))+
  theme(axis.title.y=element_text(size=24,face="bold",colour="black"))+
  theme(legend.position="none")+labs(colour="coef")+
  theme(panel.grid=element_blank())+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))+guides(fill=F)
g1
ggsave("TCGA NSCLC IB high DEGs DFS.pdf", width=6, height=6)




##?ͱ???
LD1<-as.data.frame(t(LD[,-1]))
LD2<-as.data.frame(scale(LD1))
LD2$Patients<-rownames(LD2)
LD3<-merge(b,LD2,by=c("Patients"))
###??ÿһ?????ֱ?????COX?ع?
LD4<-sapply(LD3[,-(1:10)],function(x)coxph(Surv(DFI.time,DFI)~x,data=LD3),simplify=FALSE)
###??ȡ?б???ÿһ????summary???????ع?ϵ??
LD5<-as.data.frame(t(as.data.frame(sapply(LD4,function(x)summary(x)$coefficients[1,1],simplify=FALSE))))
LD5$EntrezID<-colnames(LD1)
###??ȡ?б???ÿһ??????summary?????еĻع?ϵ????pֵ???Ծ?????ʽ????
LD6<-as.data.frame(t(as.data.frame(sapply(LD4,function(x)summary(x)$coefficients[1,5],simplify=FALSE))))
LD6$EntrezID<-colnames(LD1)
LD7<-merge(LD5,LD6,by=c("EntrezID"))
colnames(LD7)<-c("EntrezID","coef","p")
LD7$HR<-exp(LD7$coef)
LD8<-subset(LD7,LD7$p<0.05&LD7$coef<0,select=c(1:4))  ##114???ͱ?????????????????
##"scale_color_manual(values =c("#006666", "#333333", "#FF3300"))+
bs1<-as.factor(ifelse(LD7$p<0.05,ifelse(LD7$coef>0,"Up-regulated","Down-regulated"),"No significance"))
g1a<-ggplot(LD7,aes(coef,-1*log10(p)))+geom_point()+theme_bw()+
  xlab("coef")+ylab("-log10(pvalue)")+xlim(-28,5)+
  geom_hline(yintercept=1.30103,linetype="dashed",size=0.2,colour="black")+
  geom_vline(xintercept=0,linetype="dashed",size=0.2,colour="black")+
  geom_point(aes(color=bs1))+scale_color_manual(values =c("#006666", "#333333", "#FF3300"))+
  theme(axis.text.x=element_text(size=20,face="bold",colour="black"))+
  theme(axis.text.y=element_text(size=20,face="bold",colour="black"))+
  theme(axis.title.x=element_text(size=24,face="bold",colour="black"))+
  theme(axis.title.y=element_text(size=24,face="bold",colour="black"))+
  theme(legend.position="none")+labs(colour="coef")+
  theme(panel.grid=element_blank())+
  theme(plot.margin=unit(c(1,1,1,1),"cm"))+guides(fill=F)
g1a
ggsave("TCGA NSCLC IB low DEGs DFS.pdf", width=6, height=6)











##?ϲ?
HLD<-rbind(HD8,LD8)
HLD$Type<-rep(c("High","Low"),c(300,114))
write.csv(HLD, file="D:/data/data11/TCGA NSCLC IB DFI DEs.csv",row.names = F)

##????HLD
HLD<-read.table("TCGA NSCLC IB DFI DEs.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)


##?Բ???????????LASSO?ع?
###N2????ɸѡ???? LASSO?ع?
###EntrezID???ֲ???????ֱ??ѡ??
LA1<-A2cal
LA1$EntrezID<-rownames(LA1)
LA2<-subset(LA1,LA1$EntrezID %in% HLD$EntrezID,select=c(1:119))

LA3<-as.data.frame(scale(t(LA2)))
LA3$Patients<-rownames(LA3)
LA4<-merge(b[,c(1,7,8)],LA3,by=c("Patients"))%>%na.omit()

lasy<-cbind(time=LA4$DFI.time,status=LA4$DFI)
lasx<-as.matrix(LA4[,-c(1:3)])
fit1<-glmnet(lasx,lasy,family="cox")

par("mar")
par(mar=c(7,7,7,7))
pdf("D:/data/data11/TCGA NSCLC IB lasso 1.pdf",width=6, height=6)
plot1<-plot(fit1,font.lab=2,font.axis=2,
            cex.lab=1.5,cex.axis=1.5)
dev.off()
##??????+?̶ȹ̶?
pdf("D:/data/data11/TCGA NSCLC IB lasso 2.pdf",width=8, height=6)
fit2<-cv.glmnet(lasx,lasy,family="cox")
plot2<-plot(fit2,font.lab=2,font.axis=2,
            cex.lab=1.5,cex.axis=1.5)
dev.off()

fit2$lambda.min
fit2$lambda.1se


e1<-coef(fit2,s=fit2$lambda.1se)
e1<-coef(fit2,s=fit2$lambda.min)



e2<-e1[which(e1!= 0)]
e2<-e1[which(e1>0.2)]
e3<-round(e2,4)
e3
e4<-row.names(e1)[which(e1!= 0)]
e4<-row.names(e1)[which(e1>0.2)]
e4
e5<-matrix(e3,length(e3),1)
rownames(e5)<-e4
colnames(e5)<-c("coef")
e5


##ʹ??LASSOģ??
las1<-A2cal[e4,]
setdiff(e4,rownames(las1))
las2<-as.data.frame(scale(t(las1)))
las3<-as.data.frame(e5)
write.csv(e5, file="TCGA NSCLC IB LASSO.csv",sep=",")

las4<-as.data.frame(t(las2))
rownames(las4)
rownames(las3)

las5<-as.data.frame(sapply(las4,function(x)sum(x*las3$coef)))
las5$Patients<-rownames(las5)
colnames(las5)<-c("LAS","Patients")


##IB A-B ROC????
lR1<-merge(t7,las5,by=c("Patients"))
l
2<-roc(lR1$Type,lR1$LAS)
auc(lR2)###  Area under the curve: 0.83568075117370888
ci(lR2)#95% CI: 0.76401472812945925-0.90734677421795873 (DeLong)
pdf("TCGA NSCLC IB LASSO roc.pdf",width=5, height=5)
plot(lR2,print.auc=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE,
     auc.polygon.col="#F08080", print.thres=TRUE,font=2,
     main="",cex.main=2,
     font.lab=2,font.axis=2,cex.lab=1.8,cex.axis=1.4)
text(0.3,0.3,"AUC:0.8357 \n 95% CI: 0.7640-0.9073",
     cex=1,font=2)
dev.off()


##????????


lSS<-merge(lR1,b,by=c("Patients"))
coxph(Surv(DFI.time,
           DFI)~LAS,data=lSS)

lSS$LAS1[lSS$LAS>=mean(lSS$LAS)]<-"1High"
lSS$LAS1[lSS$LAS<mean(lSS$LAS)]<-"0Low"
###????????
lSsurv<-Surv(lSS$OS.time,lSS$OS.status)
lSS1<-survdiff(Surv(DFI.time, DFI)~LAS1, data=lSS)##p= 2.106754822037831e-06
lSS1
lSS2<-coxph(Surv(DFI.time, DFI)~LAS1,data=lSS)
lSS2
summary(lSS2) ##HR=6.9908451698066552 95CI=2.7919799075377094-17.504393945051682
###p=3.289e-05
exp(confint(lSS2))

lSfit1<-survfit(Surv(DFI.time, DFI)~LAS1, data=lSS)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))


lScurve1<-ggsurvplot(lSfit1,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#696969","#F08080"),
                     pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                     legend.title="IB-Score",
                     legend="top",
                     title="",xlab="Days",ylab="DFI",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)

lScurve1
ggsave("TCGA NSCLC IB Score DFI.pdf", width=8, height=6)





###??????????Ԥ??  ###"1362" CPD
las2$Patients<-rownames(las2)

lR1a<-merge(t7,las2,by=c("Patients"))
lR2a<-roc(lR1a$Type,lR1a$`1362`)
auc(lR2a)###  Area under the curve:  0.7054
ci(lR2a)#95% CI: 0.6131-0.7977 (DeLong)
pdf("TCGA NSCLC IB CPD roc.pdf",width=5, height=5)
plot(lR2a,print.auc=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE,
     auc.polygon.col="#CD5555", print.thres=TRUE,font=2,
     main="CPD",cex.main=2,
     font.lab=2,font.axis=2,cex.lab=1.8,cex.axis=1.4)
text(0.4,0.2,"AUC:0.705 \n 95% CI: 0.613-0.798",
     cex=1.5,font=2)
dev.off()


##????????
b2<-subset(b1,b1$DFI.time>30,select=c(1:11))
lSSa<-merge(lR1a,b2,by=c("Patients"))
coxph(Surv(DFI.time,
           DFI)~lSSa$`1362`,data=lSSa)##HR=2.0041  p=2.89e-06

lSSa$`1362a`[lSSa$`1362`>=mean(lSSa$`1362`)]<-"1High"
lSSa$`1362a`[lSSa$`1362`<mean(lSSa$`1362`)]<-"0Low"
###????????

survdiff(Surv(DFI.time, DFI)~lSSa$`1362a`, data=lSSa)##p= 0.0005214132239149583

lSS2a<-coxph(Surv(DFI.time, DFI)~lSSa$`1362a`,data=lSSa)
lSS2a
summary(lSS2a) ##HR=4.534 95CI=1.784-11.52 p=0.00149
###p=3.289e-05
exp(confint(lSS2a))

lSfit1a<-survfit(Surv(DFI.time/30, DFI)~lSSa$`1362a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1a<-ggsurvplot(lSfit1a,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#696969","#F08080"),
                     pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                     legend.title="CPD",
                     legend="top",
                     title="",xlab="Months",ylab="DFS",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)

lScurve1a
ggsave("TCGA NSCLC IB CPD DFI.pdf", width=6, height=6)


lScurve1a<-ggsurvplot(lSfit1a,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="CPD",
                      legend="top",
                      title="",xlab="Months",ylab="DFI",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))

lScurve1a
ggsave("TCGA NSCLC IB CPD DFI revison1.pdf", width=6, height=2.3)


lSfit1a<-survfit(Surv(DFI.time/365, DFI)~lSSa$`1362a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))


lScurve1a<-ggsurvplot(lSfit1a,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="CPD",size=0.4,
                      legend="top",
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)

lScurve1a
ggsave("TCGA NSCLC IB CPD DFI revision2.pdf", width=6, height=6)


lSfit1a<-survfit(Surv(DFI.time/365, DFI)~lSSa$`1362a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))


lScurve1a<-ggsurvplot(lSfit1a,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="CPD",size=0.4,
                      legend="top",
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))

lScurve1a
ggsave("TCGA NSCLC IB CPD DFI revison3.pdf", width=6, height=2.3)


###??????????Ԥ??  ###"134" ADORA1

lR1a<-merge(t7,las2,###独立预测作用
lu1<-read.table("LUSC clinical re.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
lu2<-merge(lu1,b,by=c("Patients"))

NS1<-read.table("NSCLC clinical.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
la1<-NS1[,colnames(lu1)]
la2<-merge(la1,b,by=c("Patients"))

lda<-rbind(lu2,la2)
lda1<-merge(lSSa[,c(1:5)],lda,by=c("Patients"))

g1<-lda1

g1$pCancer[g1$`1362`>=median(g1$`1362`)]<-"1High"
g1$pCancer[g1$`1362`<median(g1$`1362`)]<-"0Low"

g1$pAge[g1$Age>=65]<-">=65"
g1$pAge[g1$Age<65]<-"<65"

g1$pSmoking[g1$Smoking==1]<-"Yes"
g1$pSmoking[g1$Smoking==0]<-"No"

colnames(g1)
g1a<-dplyr::select(g1,DFI.time,DFI,pAge,Gender,pSmoking,pCancer)
colnames(g1a)<-c("DFS.time","DFS.status","Age","Gender","Smoking","CPD")

model <- coxph(Surv(DFS.time,DFS.status) ~ Age +  Gender + Smoking + CPD, data = g1a )
summary(model)
ggforest(model = model,
         data = g1a,
         cpositions = c(0.01,0.1,0.3),
         refLabel = "",
         fontsize=1,
         noDigits=2,
         main = "")
ggsave("TCGA CPD mul HR COX.pdf",width=8, height=6.5)





###CPD对IB进行分层
#
## IA
##LUAD
IAla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IA",select=c(1:110))
IAla1<-gsub("-",".",IAla$bcr_patient_barcode)

##LUSC
IAls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IA",select=c(1:108))
IAls1<-gsub("-",".",IAls$bcr_patient_barcode)

IA<-data.frame(IAla1,rep("IA",92))
colnames(IA)<-c("Patients","Type")

IAs<-data.frame(IAls1,rep("IA",43))
colnames(IAs)<-c("Patients","Type")

IAa<-rbind(IA,IAs) ## LUAD LUSC 135

##II
##LUAD
IIla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage II"|
               A2$ajcc_pathologic_tumor_stage=="Stage IIA"|
               A2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:110))
IIla1<-gsub("-",".",IIla$bcr_patient_barcode)

##LUSC
IIls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage II"|
               As2$ajcc_pathologic_tumor_stage=="Stage IIA"|
               As2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:108))
IIls1<-gsub("-",".",IIls$bcr_patient_barcode)


##
II<-data.frame(IIla1,rep("II",75))
colnames(II)<-c("Patients","Type")

IIs<-data.frame(IIls1,rep("II",86))
colnames(IIs)<-c("Patients","Type")


IIa<-rbind(II,IIs)##LUAD LUSC  ##161


fe1<-rbind(IAa,IIa)

fe1$subType[fe1$Patients %in% IAa$Patients]<-"IA"



##IIA
##LUAD
IIAla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IIA",select=c(1:110))
IIAla1<-gsub("-",".",IIAla$bcr_patient_barcode)

##LUSC
IIAls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IIA",select=c(1:108))
IIAls1<-gsub("-",".",IIAls$bcr_patient_barcode)


##
IIA<-data.frame(IIAla1,rep("IIA",45))
colnames(IIA)<-c("Patients","subType")

IIAs<-data.frame(IIAls1,rep("IIA",49))
colnames(IIAs)<-c("Patients","subType")


IIAa<-rbind(IIA,IIAs)## LUAD LUSC

fe1$subType[fe1$Patients %in% IIAa$Patients]<-"IIA"



##LUAD
IIBla<-subset(A2,A2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:110))
IIBla1<-gsub("-",".",IIBla$bcr_patient_barcode)

##LUSC
IIBls<-subset(As2,As2$ajcc_pathologic_tumor_stage=="Stage IIB",select=c(1:108))
IIBls1<-gsub("-",".",IIBls$bcr_patient_barcode)


##?ϲ??ٰ????۰?
IIB<-data.frame(IIBla1,rep("IIB",29))
colnames(IIB)<-c("Patients","subType")

IIBs<-data.frame(IIBls1,rep("IIB",35))
colnames(IIBs)<-c("Patients","subType")

IIBa<-rbind(IIB,IIBs)##LUAD LUSC


fe1$subType[fe1$Patients %in% IIBa$Patients]<-"IIB"


fe3<-lSSa[,c(1:5)]
fe3$pCancer[fe3$`1362`>=median(fe3$`1362`)]<-"1High"
fe3$pCancer[fe3$`1362`<median(fe3$`1362`)]<-"0Low"

fe4<-fe3[c(1,6)]
colnames(fe4)<-c("Patients","Type")
fe4$subType<-fe4$Type

fe5<-rbind(fe1,fe4)

fe2<-merge(b,fe5,by=c("Patients"))

fe6<-subset(fe2,fe2$DFI.time>30,select=c(1:ncol(fe2)))  ##DFS小于1月
table(fe6$Type.y)

table(fe6$Type.y,fe6$subType)

fe6$TypeX[fe6$Type.y =="IA"]<-"1IA"
fe6$TypeX[fe6$Type.y =="0Low"]<-"20Low"
fe6$TypeX[fe6$Type.y =="1High"]<-"31High"
fe6$TypeX[fe6$Type.y =="II"]<-"4II"


surv<-Surv(fe6$DFI.time,fe6$DFI)
fe7<-pairwise_survdiff(Surv(DFI.time, DFI)~TypeX, data=fe6)##
fe7

fe8<-survfit(Surv((DFI.time)/365, DFI)~TypeX, data=fe6)
mytheme1<-theme_classic(base_family="")+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))
##legend.labs=c("IB1","IB2","II"),
fe9<-ggsurvplot(fe8,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                     palette=c("#EE6363","#96CDCD","#87CEFF","#2B2B2B"),
                     pval=FALSE,ggtheme=mytheme1,
                     legend.title="Type",
                     legend.labs=c("IA","IB-low","IB-high","II"),
                     legend="right",size=0.4,
                     title="",xlab="Years",ylab="DFS(100%)",
                     font.legend=c(24, "bold", "black"),
                     font.title=c(24, "bold", "black"),
                     surv.median.line="hv",
                     font.x=c(24, "bold", "black"),
                     font.y=c(24, "bold", "black"),
                     font.tickslab=c(20, "bold", "black"),
                     risk.table=FALSE)
fe9
ggsave("TCGA NSCLC cpd risk.pdf", width=8, height=6)

fe10<-ggsurvplot(fe8,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                palette=c("#EE6363","#96CDCD","#87CEFF","#2B2B2B"),
                pval=FALSE,ggtheme=mytheme1,
                legend.title="Type",
                legend.labs=c("IA","IB-low","IB-high","II"),
                legend="right",size=0.4,
                title="",xlab="Years",ylab="DFS(100%)",
                font.legend=c(24, "bold", "black"),
                font.title=c(24, "bold", "black"),
                surv.median.line="hv",
                font.x=c(24, "bold", "black"),
                font.y=c(24, "bold", "black"),
                font.tickslab=c(20, "bold", "black"),
                risk.table=TRUE)
fe10
ggsave("TCGA NSCLC cpd risk2.pdf", width=6, height=2.3)



by=c("Patients"))
lR2<-roc(lR1a$Type,lR1a$`134`)
auc(lR2b)###  Area under the curve:  0.75088028169014087
ci(lR2b)#95% CI: 0.66397641765651982-0.83778414572376192 (DeLong)
pdf("TCGA NSCLC IB ADORA1 roc.pdf",width=5, height=5)
plot(lR2a,print.auc=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE,
     auc.polygon.col="#CD5555", print.thres=TRUE,font=2,
     main="ADORA1",cex.main=2,
     font.lab=2,font.axis=2,cex.lab=1.8,cex.axis=1.4)
text(0.4,0.2,"AUC:0.751 \n 95% CI: 0.664-0.838",
     cex=1.5,font=2)
dev.off()


##????????

lSSa<-merge(lR1a,b2,by=c("Patients"))
coxph(Surv(DFI.time,
           DFI)~lSSa$`134`,data=lSSa)##HR=2.4384  p= 1.2671e-07

lSSa$`134a`[lSSa$`134`>=mean(lSSa$`134`)]<-"1High"
lSSa$`134a`[lSSa$`134`<mean(lSSa$`134`)]<-"0Low"
###????????

survdiff(Surv(DFI.time, DFI)~lSSa$`134a`, data=lSSa)##p= p= 4e-04

lSS2b<-coxph(Surv(DFI.time, DFI)~lSSa$`134a`,data=lSSa)
lSS2b
summary(lSS2b) ##HR=4.3907 95CI=1.804-10.69 p=0.00111
###p=3.289e-05
exp(confint(lSS2b))

lSfit1b<-survfit(Surv(DFI.time/30, DFI)~lSSa$`134a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1b<-ggsurvplot(lSfit1b,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ADORA1",
                      legend="top",
                      title="",xlab="Months",ylab="DFS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)

lScurve1b
ggsave("TCGA NSCLC IB ADORA1 DFI.pdf", width=6, height=6)



lSfit1b<-survfit(Surv(DFI.time/30, DFI)~lSSa$`134a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1b<-ggsurvplot(lSfit1b,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ADORA1",
                      legend="top",
                      title="",xlab="Months",ylab="DFS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))


lScurve1b
ggsave("TCGA NSCLC IB ADORA1 DFI revison1.pdf", width=6, height=2.3)


lSfit1b<-survfit(Surv(DFI.time/365, DFI)~lSSa$`134a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1b<-ggsurvplot(lSfit1b,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ADORA1",
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)

lScurve1b
ggsave("TCGA NSCLC IB ADORA1 DFI revision2.pdf", width=6, height=6)



lSfit1b<-survfit(Surv(DFI.time/365, DFI)~lSSa$`134a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1b<-ggsurvplot(lSfit1b,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ADORA1",
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))


lScurve1b
ggsave("TCGA NSCLC IB ADORA1 DFI revison3.pdf", width=6, height=2.3)




##
###??????????Ԥ??  ###"5169" ENPP3

lR1a<-merge(t7,las2,by=c("Patients"))
lR2c<-roc(lR1a$Type,lR1a$`5169`)
auc(lR2c)###  Area under the curve:  0.81719483568075113
ci(lR2c)#95% CI: 0.73946745498475441-0.89492221637674785 (DeLong)
pdf("TCGA NSCLC IB ENPP3 roc.pdf",width=5, height=5)
plot(lR2a,print.auc=FALSE, auc.polygon=TRUE, max.auc.polygon=TRUE,
     auc.polygon.col="#CD5555", print.thres=TRUE,font=2,
     main="ENPP3",cex.main=2,
     font.lab=2,font.axis=2,cex.lab=1.8,cex.axis=1.4)
text(0.4,0.2,"AUC:0.817 \n 95% CI: 0.739-0.895",
     cex=1.5,font=2)
dev.off()


##????????

lSSa<-merge(lR1a,b2,by=c("Patients"))
coxph(Surv(DFI.time,
           DFI)~lSSa$`5169`,data=lSSa)##HR=2.1528  p= 5.2816e-07

lSSa$`5169a`[lSSa$`5169`>=mean(lSSa$`5169`)]<-"1High"
lSSa$`5169a`[lSSa$`5169`<mean(lSSa$`5169`)]<-"0Low"
###????????

survdiff(Surv(DFI.time, DFI)~lSSa$`5169a`, data=lSSa)##p= 1e-04

lSS2c<-coxph(Surv(DFI.time, DFI)~lSSa$`5169a`,data=lSSa)
lSS2c
summary(lSS2c) ##HR=5.033 95CI=2.036-12.44 p=0.000464
###p=3.289e-05
exp(confint(lSS2c))

lSfit1c<-survfit(Surv(DFI.time/30, DFI)~lSSa$`5169a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1c<-ggsurvplot(lSfit1c,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ENPP3",
                      legend="top",
                      title="",xlab="Months",ylab="DFS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)

lScurve1c
ggsave("TCGA NSCLC IB ENPP3 DFI.pdf", width=6, height=6)

lScurve1c<-ggsurvplot(lSfit1c,conf.int=FALSE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ENPP3",
                      legend="top",
                      title="",xlab="Months",ylab="DFS",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))

lScurve1c
ggsave("TCGA NSCLC IB ENPP3 DFI revison1.pdf", width=6, height=2.3)


lSfit1c<-survfit(Surv(DFI.time/365, DFI)~lSSa$`5169a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1c<-ggsurvplot(lSfit1c,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ENPP3",
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      font.tickslab=c(20, "bold", "black"),
                      risk.table=FALSE)

lScurve1c
ggsave("TCGA NSCLC IB ENPP3 DFI revision2.pdf", width=6, height=6)

lSfit1c<-survfit(Surv(DFI.time/365, DFI)~lSSa$`5169a`, data=lSSa)

mytheme1<-theme_classic()+
  theme(plot.margin=unit(c(1,2,1,1),"cm"))

lScurve1c<-ggsurvplot(lSfit1c,conf.int=TRUE,conf.int.alpha=0.3,conf.int.style="ribbon",
                      palette=c("#696969","#F08080"),
                      pval=FALSE,ggtheme=mytheme1,legend.labs=c("Low","High"),
                      legend.title="ENPP3",
                      legend="top",size=0.4,
                      title="",xlab="Years",ylab="DFS(100%)",
                      font.legend=c(24, "bold", "black"),
                      font.title=c(24, "bold", "black"),
                      surv.median.line="hv",
                      font.x=c(24, "bold", "black"),
                      font.y=c(24, "bold", "black"),
                      risk.table=TRUE,risk.table.y.text=1,
                      risk.table.height=0.4,
                      risk.table.fontsize=7,risk.table.col=c("black"))

lScurve1c
ggsave("TCGA NSCLC IB ENPP3 DFI revison3.pdf", width=6, height=2.3)



###TCGA NSCLC IB clinical relation
setwd("D:/data/data11")
y1<-read.table(file="TCGA NSCLC IB consensus type.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
y2<-read.table(file="TCGA-CDR 1.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
y3<-merge(y1,y2,by=c("Patients"))
y4<-read.table(file="TCGA LUAD 7 IB clinical 2.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
y5<-read.table(file="TCGA LUSC 7 IB clinical 2.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
y6<-rbind(y4,y5)

y7<-merge(y3,y6,by=c("Patients"))
y8<-read_excel("D:/data/data11/TCGA LUAD molecular type.xlsx",sheet=1)
y9<-merge(y1,y8,by=c("Patients"))
table(y9$Type,y9$expression_subtype)
##
class(y7$Age)
y7$Age<-as.numeric(y7$age_at_initial_pathologic_diagnosis)
summary(y7$Age)

y7$Age1[y7$Age > 68]<-"1older"
y7$Age1[y7$Age <= 68]<-"0young"
table(y7$Type.x)
table(y7$Age1)
Age<-table(y7$Type.x,y7$Age1)
Age
chisq.test(Age)
fisher.test(Age)




table(y7$gender)
gender<-table(y7$Type.x,y7$gender)
gender
chisq.test(gender)
fisher.test(gender)



table(y7$anatomic_organ_subdivision)
y7$loc[y7$anatomic_organ_subdivision %in% c("L-Lower",
                          "L-Upper")]<-"Left"
y7$loc[y7$anatomic_organ_subdivision %in% c("R-Lower","R-Middle","R-Upper")]<-"Right"
table(y7$loc)
location<-table(y7$Type.x,y7$loc)
location
chisq.test(location)
fisher.test(location)


table(y7$histologic_diagnosis.1)
path<-table(y7$histologic_diagnosis.1,y7$Type.x)
path
chisq.test(path)
fisher.test(path)


table(y7$kras_mutation_found)
kras<-table(y7$kras_mutation_found,y7$Type.x)
kras
chisq.test(kras)
fisher.test(kras)


table(y7$egfr_mutation_status)
egfr<-table(y7$egfr_mutation_status,y7$Type.x)
egfr
chisq.test(egfr)
fisher.test(egfr)


table(y7$eml4_alk_translocation_status)
eml4<-table(y7$eml4_alk_translocation_status,y7$Type.x)
eml4
chisq.test(eml4)
fisher.test(eml4)

table(y7$tobacco_smoking_history_indicator)
y7$Smoking[y7$tobacco_smoking_history_indicator %in% c(2,3,4,5)]<-"Yes"
y7$Smoking[y7$tobacco_smoking_history_indicator %in% c(1)]<-"No"
table(y7$Smoking)
Smoking<-table(y7$Smoking,y7$Type.x)
Smoking
chisq.test(Smoking)
fisher.test(Smoking)


table(y7$Smoking,y7$histologic_diagnosis,y7$Type.x)




###????ͻ?????ݣ?

##????TCGA???ݼ???ͻ??????

##

La<-read.table("TCGA LUAD mut.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)
Ls<-read.table("TCGA LUSC mut.csv",sep=",",header=TRUE,stringsAsFactors=FALSE)

L<-rbind(La,Ls)

LMH<-subset(t7,t7$Type=="IB1",seect=c(1:2))
L4<-subset(L1,L1$Patients %in% LMH$Patients,select=c(1:21))

colnames(L)
Lp<-substring(L$Tumor_Sample_Barcode,1,16)
Lp1<-as.data.frame(table(Lp))
Lp2<-substring(L$Tumor_Sample_Barcode,13,16)
Lp3<-as.data.frame(table(Lp2))
Lp4<-substring(L$Tumor_Sample_Barcode,1,12)
Lp5<-as.data.frame(table(Lp4))

table(L$sample_type_description)
table(L$sample_type_description)
L1<-subset(L,L$sample_type_description!="Recurrent Solid Tumor",select=c(1:21))
table(L1$sample_type_description)
L2<-substring(L1$Tumor_Sample_Barcode,1,12)
L3<-gsub("-",".",L2)
L1$Patients<-L3
t7<-y1


##KRAS
krasmut<-subset(L1,L1$Hugo_Symbol=="KRAS",select=c(1:22))
krasWT<-subset(L1,L1$Hugo_Symbol!="KRAS" & (L1$Patients %in%
                 setdiff(L1$Patients,krasmut$Patients)),select=c(1:22))

t7$KRAS[t7$Patients %in% unique(krasmut$Patients) ]<-"Mut"
t7$KRAS[t7$Patients %in% unique(krasWT$Patients) ]<-"WT"

KRAS<-table(t7$KRAS,t7$Type)
chisq.test(KRAS)
fisher.test(KRAS)


##EGFR
EGFRmut<-subset(L1,L1$Hugo_Symbol=="EGFR",select=c(1:22))
unique(EGFRmut$Patients)
EGFRWT<-subset(L1,L1$Hugo_Symbol!="EGFR" & (L1$Patients %in%
                                              setdiff(L1$Patients,EGFRmut$Patients)),select=c(1:22))

t7$EGFR[t7$Patients %in% unique(EGFRmut$Patients) ]<-"Mut"
t7$EGFR[t7$Patients %in% unique(EGFRWT$Patients) ]<-"WT"

EGFR<-table(t7$EGFR,t7$Type)
chisq.test(EGFR)
fisher.test(EGFR)


##ALK
ALKmut<-subset(L1,L1$Hugo_Symbol=="ALK",select=c(1:22))
ALKWT<-subset(L1,L1$Hugo_Symbol!="ALK" & (L1$Patients %in%
   setdiff(L1$Patients,ALKmut$Patients)),select=c(1:22))

t7$ALK[t7$Patients %in% unique(ALKmut$Patients) ]<-"Mut"
t7$ALK[t7$Patients %in% unique(ALKWT$Patients) ]<-"WT"

ALK<-table(t7$ALK,t7$Type)
chisq.test(ALK)
fisher.test(ALK)




##
